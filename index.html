<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ▼ 手順1で発行したGASのウェブアプリURLをここに貼り付けてください
    const GOOGLE_SCRIPT_URL = "ここにGASのウェブアプリURLを貼り付けてください";

    // ベースとなるマスタデータ（バックアップ用）
    const MASTER_CSV = `ID,施設名,都道府県,エリア,ジャンル,料金,住所,URL,緯度,経度
1001,旭川市旭山動物園,北海道,旭川市,zoo,本人と介護者1名無料,北海道旭川市東旭川町倉沼,,43.7684,142.48
1002,札幌市円山動物園,北海道,札幌市,zoo,本人と介護者1名無料,北海道札幌市中央区宮ヶ丘3番地1,,43.0526,141.3082
1003,北海道開拓の村,北海道,札幌市,museum,本人と介護者1名無料,北海道札幌市厚別区厚別町小野幌50-1,,43.0493,141.4983
1004,三内丸山遺跡センター,青森県,青森市,museum,本人と付添人1名無料,青森県青森市三内字丸山305,,40.8122,140.697
1005,盛岡市動物公園 ZOOMA,岩手県,盛岡市,park,本人と介護者1名無料,岩手県盛岡市新庄字下八木田60-18,,39.7214,141.1923
1006,仙台市博物館,宮城県,仙台市,museum,本人と介護者1名無料,宮城県仙台市青葉区川内26,,38.2562,140.8566
1007,アクアマリンふくしま,福島県,いわき市,aquarium,本人と介護者1名無料,福島県いわき市小名浜字辰巳町50,,36.9427,140.9032
1008,鶴ヶ城（会津若松城）,福島県,会津若松市,museum,本人と付添人1名無料,福島県会津若松市追手町1-1,,37.4875,139.9297
1009,国営ひたち海浜公園,茨城県,ひたちなか市,park,本人と付添人1名無料,茨城県ひたちなか市馬渡字大沼605-4,,36.4027,140.5927
1010,日光田母沢御用邸記念公園,栃木県,日光市,park,本人と付添人1名無料,栃木県日光市本町8-27,,36.7533,139.5936
1011,富岡製糸場,群馬県,富岡市,museum,本人と介護者1名無料,群馬県富岡市富岡1-1,,36.2553,138.8925
1012,群馬県立自然史博物館,群馬県,富岡市,museum,本人と介護者1名無料,群馬県富岡市上黒岩1674-1,,36.2647,138.8833
1013,さいたま水族館,埼玉県,羽生市,aquarium,本人と介護者1名無料,埼玉県羽生市三田ヶ谷751-1,,36.1736,139.5925
1014,千葉市動物公園,千葉県,千葉市,park,本人と介護者1名無料,千葉県千葉市若葉区源町280,,35.6369,140.1222
1015,東京国立博物館,東京都,台東区,museum,本人と介護者1名無料（総合文化展）,東京都台東区上野公園13-9,,35.7187,139.7765
1016,国立科学博物館,東京都,台東区,museum,本人と介護者1名無料,東京都台東区上野公園7-20,,35.7163,139.7766
1017,恩賜上野動物園,東京都,台東区,zoo,本人と付添人1名無料,東京都台東区上野公園9-83,,35.7165,139.7713
1018,新宿御苑,東京都,新宿区,museum,本人と介助者1名無料,東京都新宿区内藤町11,,35.6851,139.71
1019,葛西臨海水族園,東京都,江戸川区,museum,本人と付添人1名無料,東京都江戸川区臨海町6-2-3,,35.6401,139.8624
1020,よこはま動物園ズーラシア,神奈川県,横浜市,zoo,本人と介護者2名まで無料,神奈川県横浜市旭区上白根町1175-1,,35.4944,139.5255
1021,川崎市藤子・F・不二雄ミュージアム,神奈川県,川崎市,leisure,本人と介助者1名無料（要予約）,神奈川県川崎市多摩区長尾2-8-1,,35.6103,139.5732
1022,新潟市水族館 マリンピア日本海,新潟県,新潟市,aquarium,本人と介助者1名無料,新潟県新潟市中央区西船見町5932-445,,37.9239,139.0322
1023,兼六園,石川県,金沢市,park,本人と介護者1名無料,石川県金沢市兼六町1,,36.562,136.6625
1024,福井県立恐竜博物館,福井県,勝山市,museum,本人と介護者1名無料（常設展）,福井県勝山市村岡町寺尾51-11,,36.0545,136.5033
1025,山梨県立リニア見学センター,山梨県,都留市,museum,本人と介助者1名無料,山梨県都留市小形山2381,,35.567,138.9372
1026,国宝 松本城,長野県,松本市,museum,本人と介助者1名無料,長野県松本市丸の内4-1,,36.2387,137.9691
1027,岐阜城,岐阜県,岐阜市,museum,本人と介護者1名無料,岐阜県岐阜市金華山天守閣18,,35.4339,136.7821
1028,浜松市動物園,静岡県,浜松市,zoo,本人と介護者1名無料,静岡県浜松市西区舘山寺町199,,34.7644,137.6622
1029,名古屋城,愛知県,名古屋市,museum,本人と介護者2名まで無料,愛知県名古屋市中区本丸1-1,,35.1847,136.9
1030,東山動植物園,愛知県,名古屋市,museum,本人と介護者2名まで無料,愛知県名古屋市千種区東山元町3-70,,35.1565,136.9744
1031,トヨタ産業技術記念館,愛知県,名古屋市,museum,本人と付添人1名無料,愛知県名古屋市西区則武新町4-1-35,,35.1828,136.8753
1032,彦根城,滋賀県,彦根市,museum,本人と付添人1名無料,滋賀県彦根市金亀町1-1,,35.2766,136.2517
1033,元離宮二条城,京都府,京都市,museum,本人と介護者1名無料,京都府京都市中京区二条通堀川西入二条城町541,,35.0142,135.7482
1034,京都国立博物館,京都府,京都市,museum,本人と介護者1名無料（名品ギャラリー）,京都府京都市東山区茶屋町527,,34.9906,135.7725
1035,京都市動物園,京都府,京都市,zoo,本人と介護者1名無料,京都府京都市左京区岡崎法勝寺町岡崎公園内,,35.0116,135.7836
1036,大阪城天守閣,大阪府,大阪市,museum,本人と介護者1名無料,大阪府大阪市中央区大阪城1-1,,34.6873,135.5262
1037,天王寺動物園,大阪府,大阪市,zoo,本人と付添人1名無料,大阪府大阪市天王寺区茶臼山町1-108,,34.6506,135.5103
1038,万博記念公園,大阪府,吹田市,park,本人と介助者1名無料,大阪府吹田市千里万博公園,,34.8028,135.5367
1039,姫路城,兵庫県,姫路市,museum,本人と介助者1名無料,兵庫県姫路市本町68,,34.8394,134.6939
1040,神戸市立王子動物園,兵庫県,神戸市,zoo,本人と介護者1名無料,兵庫県神戸市灘区王子町3-1,,34.7126,135.2166
1041,奈良国立博物館,奈良県,奈良市,museum,本人と介護者1名無料,奈良県奈良市登大路町50,,34.6836,135.8358
1042,和歌山城,和歌山県,和歌山市,museum,本人と付添人1名無料,和歌山県和歌山市一番丁3,,34.2255,135.1706
1043,鳥取砂丘 砂の美術館,鳥取県,鳥取市,museum,本人と介護者1名無料,鳥取県鳥取市福部町湯山2083-17,,35.5404,134.2382
1044,松江城,島根県,松江市,museum,本人と介助者1名無料,島根県松江市殿町1-5,,35.4753,133.0505
1045,岡山後楽園,岡山県,岡山市,park,本人と介護者1名無料,岡山県岡山市北区後楽園1-5,,34.6669,133.9358
1046,広島平和記念資料館,広島県,広島市,museum,本人と介護者1名無料,広島県広島市中区中島町1-2,,34.3916,132.4519
1047,海響館（市立しものせき水族館）,山口県,下関市,aquarium,本人と介護者1名無料,山口県下関市あるかぽーと6-1,,33.9538,130.9436
1048,栗林公園,香川県,高松市,park,本人と介護者1名無料,香川県高松市栗林町1-20-16,,34.3323,134.0439
1049,松山城,愛媛県,松山市,museum,本人と介助者2名まで無料,愛媛県松山市丸之内1,,33.8455,132.7663
1050,愛媛県立とべ動物園,愛媛県,砥部町,zoo,本人と介護者1名無料,愛媛県伊予郡砥部町上原町240,,33.7667,132.7961
1051,高知城,高知県,高知市,museum,本人と介護者1名無料,高知県高知市丸ノ内1-2-1,,33.5607,133.5312
1052,九州国立博物館,福岡県,太宰府市,museum,本人と介護者1名無料（文化交流展）,福岡県太宰府市石坂4-7-2,,33.5186,130.5242
1053,海の中道海浜公園,福岡県,福岡市,park,本人と付添人1名無料,福岡県福岡市東区大字西戸崎18-25,,33.6558,130.3664
1054,グラバー園,長崎県,長崎市,park,本人と介護者1名無料,長崎県長崎市南山手町8-1,,32.7341,129.8696
1055,熊本城,熊本県,熊本市,museum,本人と付添人1名無料,熊本県熊本市中央区本丸1-1,,32.8062,130.7058
1056,フェニックス自然動物園,宮崎県,宮崎市,zoo,本人と介護者1名無料,宮崎県宮崎市塩路浜山3083-42,,31.9567,131.4722
1057,いおワールドかごしま水族館,鹿児島県,鹿児島市,aquarium,本人と介護者1名無料,鹿児島県鹿児島市本港新町3-1,,31.5947,130.5636
1058,沖縄美ら海水族館,沖縄県,本部町,aquarium,本人と付添人1名無料,沖縄県国頭郡本部町石川424,,26.6943,127.8779
1059,首里城公園,沖縄県,那覇市,museum,本人と介助者1名無料,沖縄県那覇市首里金城町1-2,,26.217,127.7196
1060,北海道博物館,北海道,札幌市,museum,本人と介護者1名無料,北海道札幌市厚別区厚別町小野幌53-2,https://www.hm.pref.hokkaido.lg.jp/,43.0531,141.4965
1061,北海道立近代美術館,北海道,札幌市,museum,本人と介護者1名無料,北海道札幌市中央区北1条西17丁目,https://artmuseum.pref.hokkaido.lg.jp/knb,43.0602,141.3303
1062,本郷新記念札幌彫刻美術館,北海道,札幌市,museum,本人と介護者1名無料,北海道札幌市中央区宮の森4条12丁目,http://www.hongoshin-smos.jp/,43.0548,141.2928
1063,札幌芸術の森,北海道,札幌市,museum,本人と介護者1名無料,北海道札幌市南区芸術の森2丁目75,https://artpark.or.jp/,42.9421,141.3422
1064,さっぽろ羊ケ丘展望台,北海道,札幌市,park,本人のみ無料,北海道札幌市豊平区羊ヶ丘1番地,https://www.hitsujigaoka.jp/,42.9991,141.3944
1065,AOAO SAPPORO,北海道,札幌市,aquarium,本人と介護者1名半額,北海道札幌市中央区南2条西3丁目20 moyuk SAPPORO 4F-6F,https://aoao-sapporo.blue/,43.0577,141.3533
1066,東京ディズニーリゾート,千葉県,浦安市,leisure,障がいのある方向けチケットあり（変動価格）,千葉県浦安市舞浜1-1,,35.6329,139.8804
1067,マザー牧場,千葉県,富津市,park,本人・介助者1名まで一般料金の半額,千葉県富津市田倉940-3,,35.246,139.9348
1068,鴨川シーワールド,千葉県,鴨川市,aquarium,本人・介助者1名まで一般料金の半額,千葉県鴨川市東町1464-18,,35.1164,140.1202
1069,市原ぞうの国,千葉県,市原市,zoo,本人・介助者1名まで約半額,千葉県市原市山小川937,,35.3547,140.1823
1070,東京ドイツ村,千葉県,袖ケ浦市,park,駐車料金等の割引（要確認）,千葉県袖ケ浦市永吉419,,35.4055,140.0594
1071,成田ゆめ牧場,千葉県,成田市,park,入場料割引（約半額）,千葉県成田市名木730-3,,35.8693,140.3954
1072,ふなばしアンデルセン公園,千葉県,船橋市,park,本人・介助者1名まで入園無料,千葉県船橋市金堀町525,,35.7599,140.0629
1073,千葉ポートタワー,千葉県,千葉市,leisure,本人・介助者1名まで入館無料,千葉県千葉市中央区中央港1,,35.6004,140.0978
1074,鋸山ロープウェー,千葉県,富津市,leisure,本人・介助者1名まで往復運賃約半額,千葉県富津市金谷4052-1,,35.1623,139.823
1075,京成バラ園,千葉県,八千代市,park,入園料割引,千葉県八千代市大和田新田755,,35.731,140.0875
1076,横浜・八景島シーパラダイス,神奈川県,横浜市,aquarium,ワンデーパス等が5割引き,神奈川県横浜市金沢区八景島,,35.3367,139.6468
1077,新江ノ島水族館,神奈川県,藤沢市,aquarium,本人・介助者1名まで一般料金の半額,神奈川県藤沢市片瀬海岸2-19-1,,35.3097,139.4797
1078,横浜ランドマークタワー スカイガーデン,神奈川県,横浜市,leisure,本人・介助者1名まで入場料半額,神奈川県横浜市西区みなとみらい2-2-1,,35.4543,139.631
1079,カップヌードルミュージアム 横浜,神奈川県,横浜市,museum,本人・介助者1名まで入館無料（体験料別途）,神奈川県横浜市中区新港2-3-4,,35.4554,139.6395
1080,箱根園水族館,神奈川県,箱根町,aquarium,本人・介助者1名まで割引（約半額）,神奈川県足柄下郡箱根町元箱根139,,35.2122,139.0093
1081,彫刻の森美術館,神奈川県,箱根町,museum,本人・介助者1名まで割引,神奈川県足柄下郡箱根町二ノ平1121,,35.2447,139.0513
1082,箱根ガラスの森美術館,神奈川県,箱根町,museum,本人・介助者1名まで割引,神奈川県足柄下郡箱根町仙石原940-48,,35.2663,139.0177
1083,よみうりランド,東京都,稲城市,leisure,ワンデーパス等割引,東京都稲城市矢野口4015-1,,35.623,139.5187
1084,箱根ロープウェイ,神奈川県,箱根町,leisure,運賃割引,神奈川県足柄下郡箱根町強羅1300,,35.2464,139.0356
1085,箱根海賊船,神奈川県,箱根町,leisure,運賃割引,神奈川県足柄下郡箱根町元箱根,,35.2009,139.0305
1086,マリーンルージュ,神奈川県,横浜市,leisure,乗船料割引,神奈川県横浜市中区山下町,,35.4456,139.6515
1087,TOHOシネマズ,東京都,千代田区,cinema,本人・介助者1名まで鑑賞料金1000円,東京都千代田区有楽町1-1-2,,35.6736,139.7592
1088,イオンシネマ,千葉県,千葉市,cinema,本人・介助者1名まで鑑賞料金1000円,千葉県千葉市美浜区豊砂1-1,,35.6512,140.0383
1089,109シネマズ,東京都,世田谷区,cinema,本人・介助者1名まで鑑賞料金1000円,東京都世田谷区玉川1-14-1,,35.611,139.6297
1090,ビッグエコー,東京都,中央区,leisure,室料割引（店舗により異なる）,東京都中央区銀座4-2-14,,35.6725,139.7635
1091,ラウンドワン,東京都,江東区,leisure,クラブ会員入会費免除・貸靴無料など店舗による,東京都江東区青海1-1-10,,35.6256,139.7745
1092,東京スカイツリー,東京都,墨田区,leisure,本人・介助者1名まで当日券が約半額,東京都墨田区押上1-1-2,,35.71,139.8107
1093,東京タワー,東京都,港区,leisure,本人・介助者1名まで約半額,東京都港区芝公園4-2-8,,35.6586,139.7454
1094,サンリオピューロランド,東京都,多摩市,leisure,本人・介助者1名までチケット200円引（窓口購入）,東京都多摩市落合1-31,,35.6246,139.4291
1095,サンシャイン水族館,東京都,豊島区,aquarium,本人・介助者1名まで約半額,東京都豊島区東池袋3-1,,35.7291,139.7198
1096,マクセル アクアパーク品川,東京都,港区,aquarium,本人・介助者1名まで約半額,東京都港区高輪4-10-30,,35.6278,139.7352
1097,すみだ水族館,東京都,墨田区,aquarium,本人・介助者1名まで約半額,東京都墨田区押上1-1-2,,35.71,139.8107
1098,しながわ水族館,東京都,品川区,aquarium,本人・介助者1名まで2割〜5割引（区外・区民で変動）,東京都品川区勝島3-2-1,,35.5884,139.7375
1099,東京ジョイポリス,東京都,港区,leisure,本人・介助者1名まで入場無料（パスポートは割引販売）,東京都港区台場1-6-1,,35.6288,139.7766
1100,六本木ヒルズ展望台 東京シティビュー,東京都,港区,leisure,本人・介助者1名まで約半額,東京都港区六本木6-10-1,,35.6604,139.7292
1101,浅草花やしき,東京都,台東区,leisure,本人・介助者1名まで入園無料（のりもの券別途）,東京都台東区浅草2-28-1,,35.7154,139.7946
1102,チームラボプラネッツ TOKYO DMM,東京都,江東区,museum,障がい者割引チケットあり（約半額〜）,東京都江東区豊洲6-1-16,,35.6469,139.7942
1103,レゴランド・ディスカバリー・センター東京,東京都,港区,park,障がい者割引チケットあり,東京都港区台場1-6-1,,35.6289,139.7763
1104,スモールワールズ,東京都,江東区,museum,本人・介助者1名まで割引,東京都江東区有明1-3-33,,35.6378,139.7883
1105,アートアクアリウム美術館 GINZA,東京都,中央区,museum,本人・介助者1名まで割引,東京都中央区銀座4-6-16,,35.6713,139.7661`;

    let map, markers = {};
    let userStatus = JSON.parse(localStorage.getItem('handimap_v2')) || {};
    let userCurrentPos = null;
    let activeListCategory = 'all';
    let activeMapCategories = new Set(['leisure', 'aquarium', 'zoo', 'museum', 'park', 'cinema']);
    let searchQuery = "";
    let currentListTab = 'fav';
    let facilitiesData = [];
    let isProgrammaticScroll = false;
    let scrollTimeout;
    let isMapFlying = false;
    let observer;

    // ジャンル表記ゆれ吸収用マップ
    const GENRE_CONVERT_MAP = {
        '動物園': 'zoo', 'zoo': 'zoo',
        '水族館': 'aquarium', 'aquarium': 'aquarium',
        '博物館': 'museum', '美術館': 'museum', '科学館': 'museum', 'museum': 'museum',
        '遊園地': 'leisure', 'レジャー': 'leisure', 'leisure': 'leisure', 'テーマパーク': 'leisure',
        '公園': 'park', '庭園': 'park', 'park': 'park',
        '映画': 'cinema', '映画館': 'cinema', 'cinema': 'cinema'
    };

    window.onload = function() {
        initApp();
    };

    async function initApp() {
        // 1. まずベースデータをロード（これで最低限動く）
        let baseData = parseCSV(MASTER_CSV);
        facilitiesData = baseData; // 一旦表示

        // 2. 外部データを非同期で取得
        if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL.startsWith('http')) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const sheetText = await response.text();
                
                // HTMLが返ってきてしまった場合のチェック（GAS設定ミス対策）
                if (sheetText.trim().startsWith('<')) {
                    console.error('エラー: GASからHTMLが返されています。GASのdoGet関数を修正してください。');
                    return; // 処理中断
                }

                const sheetData = parseSheetData(sheetText);
                
                // ▼ 重複排除＆結合ロジック
                // 名前（スペース除去）をキーにして重複チェック
                const existingMap = new Map();
                baseData.forEach(d => existingMap.set(d.name.replace(/\s+/g, ''), d));

                let addedCount = 0;
                let updatedCount = 0;

                sheetData.forEach(d => {
                    const key = d.name.replace(/\s+/g, '');
                    const existing = existingMap.get(key);

                    if (existing) {
                        // 重複あり：既存データに情報が不足していて、新データにあれば補完するなどの処理が可能
                        // 今回は「スプレッドシート側を優先」したければここで上書きするが
                        // ベースデータの方が座標など正確な場合が多いので、基本はスキップまたは補完
                        // ※ご要望の「結合」は、ここでは「既存にあれば何もしない（ベース優先）」とします
                        updatedCount++;
                    } else {
                        // 新規かつ、座標(lat,lng)がある場合のみ追加
                        if (d.lat && d.lng) {
                            baseData.push(d);
                            existingMap.set(key, d); // 追加したものをマップにも登録
                            addedCount++;
                        }
                    }
                });
                
                console.log(`データ更新: 追加 ${addedCount}件 / 既存重複 ${updatedCount}件`);
                facilitiesData = baseData; // データを更新

            } catch (e) {
                console.error('外部データ読み込み失敗:', e);
                // 失敗してもアラートは出さず、ベースデータのみで動作継続
            }
        }

        // マップとリストを初期化・再描画
        initMap();
        renderList();
        renderMyList();
    }

    // スプレッドシートデータの解析パーサー
    function parseSheetData(csv) {
        const lines = csv.trim().split('\n');
        let result = [];
        let autoId = 2001; // 自動採番用ID

        for(let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if(!line || line.startsWith('ID') || line.startsWith('施設名')) continue; // ヘッダー等スキップ

            const cols = line.split(',');
            // 最低限、施設名(1)が必要
            if(cols.length < 2) continue;

            // 各カラム取得（undefined対策）
            const idStr = cols[0] ? cols[0].trim() : "";
            const name = cols[1] ? cols[1].trim() : "";
            const pref = cols[2] ? cols[2].trim() : "";
            const area = cols[3] ? cols[3].trim() : "";
            const rawGenre = cols[4] ? cols[4].trim() : "leisure";
            const price = cols[5] ? cols[5].trim() : "";
            const addr = cols[6] ? cols[6].trim() : "";
            const url = cols[7] ? cols[7].trim() : "";
            const latStr = cols[8] ? cols[8].trim() : "";
            const lngStr = cols[9] ? cols[9].trim() : "";

            if(!name) continue;

            // ID処理
            let id = parseInt(idStr);
            if(isNaN(id)) id = autoId++;

            // ジャンル変換
            let category = GENRE_CONVERT_MAP[rawGenre] || 'leisure';

            // 座標処理
            let lat = parseFloat(latStr);
            let lng = parseFloat(lngStr);

            if (isNaN(lat) || isNaN(lng)) continue; // 座標なしは除外

            result.push({ id, name, pref, area, category, price, address: addr, url, lat, lng });
        }
        return result;
    }

    // 既存CSVパーサー
    function parseCSV(csv) {
        return csv.trim().split('\n').slice(1).map(line => {
            const [id,name,pref,area,cat,price,addr,url,lat,lng] = line.split(',');
            if(!name) return null;
            return { 
                id: parseInt(id), name, pref, area, category: cat, price, address: addr, url, 
                lat: lat ? parseFloat(lat) : null, lng: lng ? parseFloat(lng) : null 
            };
        }).filter(Boolean);
    }

    function getIcon(cat) { return { leisure:'🎡', zoo:'🐘', aquarium:'🐬', cinema:'🎬', museum:'🏛️', park:'🌳' }[cat] || '📍'; }
    
    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lng2-lng1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function initMap() {
        if(map) {
            renderAllMarkers();
            return;
        }
        map = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        if(window.innerWidth >= 768) L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        map.on('moveend', () => {
            if(!isMapFlying) updateVisibleSpots(); 
            isMapFlying = false;
        });
        renderAllMarkers();
    }

    function renderAllMarkers() {
        Object.values(markers).forEach(m => map.removeLayer(m));
        markers = {};
        facilitiesData.forEach(spot => {
            if (!spot.lat || !activeMapCategories.has(spot.category)) return;
            const icon = L.divIcon({ className: 'custom-div-icon', html: `<div id="pin-${spot.id}" class="pin-marker">${getIcon(spot.category)}</div>`, iconSize: [44, 44], iconAnchor: [22, 50] });
            const marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
            marker.on('click', (e) => { 
                L.DomEvent.stopPropagation(e); 
                isMapFlying = true; 
                map.flyTo([spot.lat, spot.lng], 13); 
                showMapCard(spot.id); 
            });
            markers[spot.id] = marker;
        });
    }

    function showMapCard(id) {
        isProgrammaticScroll = true;
        document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
        const pin = document.getElementById(`pin-${id}`);
        if(pin) pin.classList.add('active-pin');

        const card = document.getElementById(`map-card-${id}`);
        if(card) {
            card.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            document.querySelectorAll('.map-card-horizontal').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
        }
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => { isProgrammaticScroll = false; }, 800);
    }

    function highlightMarker(id) {
        document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
        const pin = document.getElementById(`pin-${id}`);
        if(pin) pin.classList.add('active-pin');

        document.querySelectorAll('.map-card-horizontal').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`map-card-${id}`);
        if(card) card.classList.add('active');

        const spot = facilitiesData.find(f => f.id === id);
        if(spot && map) {
            isMapFlying = true; 
            map.panTo([spot.lat, spot.lng], { animate: true, duration: 1.0 });
        }
    }

    function setupObserver() {
        if (observer) observer.disconnect();
        observer = new IntersectionObserver((entries) => {
            if (isProgrammaticScroll) return;
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = parseInt(entry.target.id.replace('map-card-', ''));
                    highlightMarker(id);
                }
            });
        }, { root: document.getElementById('card-scroller'), threshold: 0.55 });
        document.querySelectorAll('.map-card-horizontal').forEach(card => observer.observe(card));
    }

    function updateVisibleSpots() {
        const center = map.getCenter();
        const refLat = userCurrentPos ? userCurrentPos.lat : center.lat;
        const refLng = userCurrentPos ? userCurrentPos.lng : center.lng;

        const sorted = facilitiesData.filter(f => f.lat && activeMapCategories.has(f.category))
            .map(f => ({ ...f, dist: getDistance(refLat, refLng, f.lat, f.lng) }))
            .sort((a, b) => a.dist - b.dist);
            
        const scroller = document.getElementById('card-scroller');
        scroller.innerHTML = sorted.map(spot => {
            const isFav = userStatus[spot.id]?.fav;
            const isVisited = userStatus[spot.id]?.visited;
            return `
            <div id="map-card-${spot.id}" class="map-card-horizontal" onclick="isMapFlying=true; map.flyTo([${spot.lat}, ${spot.lng}], 14); showMapCard(${spot.id}); event.stopPropagation();">
                <div class="flex-1">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-base mb-1 text-blue-600 underline flex items-center gap-1" onclick="openExternalLink('${spot.url}', '${spot.name}'); event.stopPropagation();">
                            ${spot.name} <i class="fas fa-external-link-alt text-xs"></i>
                        </h3>
                        <div class="text-xl">${getIcon(spot.category)}</div>
                    </div>
                    <p class="text-xs text-red-500 font-bold mb-1">${spot.price}</p>
                    <p class="text-[10px] text-slate-400"><i class="fas fa-map-marker-alt"></i> ${spot.dist < 1 ? Math.round(spot.dist*1000)+'m' : spot.dist.toFixed(1)+'km'}先</p>
                </div>
                <div class="mt-2 pt-2 border-t border-slate-100 flex gap-2">
                    <button onclick="handleNav('${spot.name}', ${spot.lat}, ${spot.lng}); event.stopPropagation()" class="flex-1 bg-teal-600 text-white text-xs font-bold py-2 rounded-lg"><i class="fas fa-location-arrow"></i> ナビ</button>
                    <button onclick="toggleFav(${spot.id}); event.stopPropagation()" class="w-10 bg-white border border-${isFav?'pink-200':'slate-200'} rounded-lg text-${isFav?'pink-500':'slate-300'}"><i class="${isFav?'fas':'far'} fa-heart"></i></button>
                    <button onclick="toggleVisited(${spot.id}); event.stopPropagation()" class="w-10 bg-white border border-${isVisited?'green-200':'slate-200'} rounded-lg text-${isVisited?'green-500':'slate-300'}"><i class="fas fa-check"></i></button>
                </div>
            </div>
        `}).join('') + '<div style="flex:0 0 10px"></div>';
        setupObserver();
    }

    function renderList() {
        const container = document.getElementById('list-container');
        const q = searchQuery.toLowerCase().trim();
        let targets = facilitiesData.filter(f => {
            if(activeListCategory !== 'all' && f.category !== activeListCategory) return false;
            if(q) {
                if( !f.name.toLowerCase().includes(q) && 
                    !f.pref.toLowerCase().includes(q) && 
                    !f.area.toLowerCase().includes(q) && 
                    !f.address.toLowerCase().includes(q) &&
                    !f.category.toLowerCase().includes(q)
                ) return false;
            }
            return true;
        });
        if(userCurrentPos) targets.sort((a,b) => getDistance(userCurrentPos.lat,userCurrentPos.lng,a.lat,a.lng) - getDistance(userCurrentPos.lat,userCurrentPos.lng,b.lat,b.lng));
        if(targets.length === 0) { container.innerHTML = `<div class="text-center py-10 text-slate-400">該当なし</div>`; return; }

        const grouped = {}; 
        targets.forEach(f => { if(!grouped[f.pref]) grouped[f.pref] = []; grouped[f.pref].push(f); });
        
        const prefOrder = ["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];
        
        container.innerHTML = prefOrder.filter(p => grouped[p]).map(pref => `
            <details class="group mb-3 bg-white rounded-xl shadow-sm overflow-hidden">
                <summary class="flex justify-between p-4 cursor-pointer bg-slate-50 font-bold text-teal-800">
                    <span>${pref} <span class="text-xs bg-teal-100 text-teal-600 px-2 rounded-full ml-2">${grouped[pref].length}</span></span>
                    <i class="fas fa-chevron-down text-slate-300 group-open:rotate-180 transition-transform"></i>
                </summary>
                <div class="p-3 border-t grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${grouped[pref].map(spot => createCardHTML(spot)).join('')}
                </div>
            </details>
        `).join('');
    }

    function createCardHTML(spot) {
        const isFav = userStatus[spot.id]?.fav;
        const isVisited = userStatus[spot.id]?.visited;
        return `
            <div class="map-card relative hover:shadow-md transition-shadow" onclick="openExternalLink('${spot.url}', '${spot.name}')">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500 font-bold">${spot.area}</span>
                    <div class="text-xl opacity-40">${getIcon(spot.category)}</div>
                </div>
                <h3 class="font-bold text-lg mb-1 text-blue-600 underline flex items-center gap-2" onclick="event.stopPropagation(); openExternalLink('${spot.url}', '${spot.name}')">
                    ${spot.name} <i class="fas fa-external-link-alt text-sm"></i>
                </h3>
                <div class="inline-block bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded mb-3">${spot.price}</div>
                <div class="flex gap-2 mt-auto">
                    <button onclick="handleNav('${spot.name}', ${spot.lat}, ${spot.lng}); event.stopPropagation()" class="flex-1 bg-teal-600 text-white text-xs font-bold py-2 rounded-lg shadow-sm"><i class="fas fa-location-arrow mr-1"></i>ナビ</button>
                    ${spot.lat ? `<button onclick="jumpToMap(${spot.lat}, ${spot.lng}, ${spot.id}); event.stopPropagation()" class="w-10 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-teal-600"><i class="fas fa-map-marker-alt"></i></button>` : ''}
                    <button onclick="toggleFav(${spot.id}); event.stopPropagation()" class="w-10 bg-white border border-${isFav?'pink-200':'slate-200'} rounded-lg text-${isFav?'pink-500':'slate-300'}"><i class="${isFav?'fas':'far'} fa-heart"></i></button>
                    <button onclick="toggleVisited(${spot.id}); event.stopPropagation()" class="w-10 bg-white border border-${isVisited?'green-200':'slate-200'} rounded-lg text-${isVisited?'green-500':'slate-300'}"><i class="fas fa-check"></i></button>
                </div>
            </div>
        `;
    }

    function openExternalLink(url, name) {
        const targetUrl = url ? url : `https://www.google.com/search?q=${encodeURIComponent(name)}`;
        window.open(targetUrl, '_blank', 'noopener,noreferrer');
    }
    function handleNav(name, lat, lng) {
        window.tempNav = { name, lat, lng };
        document.getElementById('map-select-modal').classList.add('show');
    }
    function confirmNavigation(type) {
        const t = window.tempNav;
        if(type === 'google') window.open(`http://googleusercontent.com/maps.google.com/maps?q=${t.lat},${t.lng}&query=${encodeURIComponent(t.name)}`);
        else window.open(`geo:${t.lat},${t.lng}?q=${encodeURIComponent(t.name)}`);
        closeModal('map-select-modal');
    }
    function locateUserOnMap() {
        if(!navigator.geolocation) return alert('位置情報が取得できません');
        navigator.geolocation.getCurrentPosition(pos => {
            userCurrentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            isMapFlying = false; 
            map.flyTo([userCurrentPos.lat, userCurrentPos.lng], 13);
            L.marker([userCurrentPos.lat, userCurrentPos.lng], {
                icon: L.divIcon({ html: '<div class="w-4 h-4 bg-teal-500 rounded-full border-2 border-white shadow-lg"></div>', className:'' })
            }).addTo(map);
            updateVisibleSpots();
        });
    }
    function toggleFav(id) {
        if(!userStatus[id]) userStatus[id] = {};
        userStatus[id].fav = !userStatus[id].fav;
        localStorage.setItem('handimap_v2', JSON.stringify(userStatus));
        renderList(); renderMyList(); 
        updateVisibleSpots();
    }
    function toggleVisited(id) {
        if(!userStatus[id]) userStatus[id] = {};
        userStatus[id].visited = !userStatus[id].visited;
        localStorage.setItem('handimap_v2', JSON.stringify(userStatus));
        renderList(); renderMyList();
        updateVisibleSpots();
    }
    function switchPage(p) {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('nav-'+p).classList.add('active');
        if(p === 'map') setTimeout(() => { map.invalidateSize(); isMapFlying=false; updateVisibleSpots(); }, 100);
    }
    function toggleMapFilter(cat, btn) {
        if(activeMapCategories.has(cat)) { activeMapCategories.delete(cat); btn.classList.remove('active'); }
        else { activeMapCategories.add(cat); btn.classList.add('active'); }
        renderAllMarkers(); updateVisibleSpots();
    }
    function applyListFilter(cat, btn) {
        activeListCategory = cat;
        document.querySelectorAll('#page-list .chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        renderList();
    }
    function handleSearch(val) { searchQuery = val; renderList(); }
    function renderMyList() {
        const list = facilitiesData.filter(f => userStatus[f.id]?.[currentListTab]);
        document.getElementById('mylist-container').innerHTML = list.length ? list.map(f => createCardHTML(f)).join('') : '<div class="text-center text-slate-400 mt-10">まだありません</div>';
    }
    function jumpToMap(lat, lng, id) { switchPage('map'); isMapFlying = true; map.flyTo([lat, lng], 14); showMapCard(id); }
    function switchListTab(t) { currentListTab = t; document.getElementById('tab-fav').className = t==='fav'?'px-3 py-1 text-xs font-bold rounded bg-white text-teal-600 shadow-sm':'px-3 py-1 text-xs font-bold rounded text-slate-400'; document.getElementById('tab-visited').className = t==='visited'?'px-3 py-1 text-xs font-bold rounded bg-white text-green-600 shadow-sm':'px-3 py-1 text-xs font-bold rounded text-slate-400'; renderMyList(); }
    
    // Admin Functions
    function checkAdminPasscode() {
        if(document.getElementById('admin-passcode').value === '19870429') {
            document.getElementById('passcode-area').style.display = 'none';
            document.getElementById('csv-admin-controls').classList.remove('hidden');
        } else alert('パスコードが違います');
    }
    function openBackupModal(t) { 
        document.getElementById('backup-modal').classList.add('show');
        const txt = document.getElementById('backup-text');
        const btn = document.getElementById('backup-action-btn');
        if(t === 'export') {
            document.getElementById('backup-title').innerText = "データ保存";
            txt.value = JSON.stringify(userStatus);
            btn.innerText = "コピー";
            btn.onclick = () => { txt.select(); document.execCommand('copy'); alert('コピーしました'); };
        } else {
            document.getElementById('backup-title').innerText = "データ復元";
            txt.value = "";
            btn.innerText = "復元";
            btn.onclick = () => {
                try {
                    userStatus = JSON.parse(txt.value);
                    localStorage.setItem('handimap_v2', JSON.stringify(userStatus));
                    renderMyList(); renderList();
                    alert('復元しました'); closeModal('backup-modal');
                } catch(e) { alert('データ形式が正しくありません'); }
            };
        }
    }
    function downloadCSV() {
        const rows = [["ID", "施設名", "都道府県", "エリア", "ジャンル", "料金", "住所", "URL", "緯度", "経度", "行きたい", "行った"]];
        facilitiesData.forEach(f => {
            const s = userStatus[f.id] || {};
            rows.push([f.id, f.name, f.pref, f.area, f.category, f.price, f.address, f.url, f.lat, f.lng, s.fav?"1":"0", s.visited?"1":"0"]);
        });
        const csvContent = "\uFEFF" + rows.map(r => r.map(c => `"${c}"`).join(",")).join("\n");
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csvContent], { type: "text/csv;charset=utf-8;" }));
        link.download = `handimap_data_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    }
    function handleCSVUpload(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const lines = e.target.result.split(/\r\n|\n/); let count = 0;
                for(let i=1; i<lines.length; i++) {
                    const cols = lines[i].split(",").map(c => c.trim().replace(/^"|"$/g, ''));
                    if(cols.length < 12) continue;
                    const id = parseInt(cols[0]);
                    if(id) {
                        if(!userStatus[id]) userStatus[id] = {};
                        userStatus[id].fav = cols[10] === "1"; userStatus[id].visited = cols[11] === "1";
                        count++;
                    }
                }
                localStorage.setItem('handimap_v2', JSON.stringify(userStatus));
                renderMyList(); renderList(); alert(`${count}件更新しました`);
            } catch(err) { alert("エラーが発生しました"); }
            input.value = "";
        };
        reader.readAsText(file);
    }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
</script>
