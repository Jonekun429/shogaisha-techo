<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HandiMap Kanto</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"M PLUS Rounded 1c"', 'sans-serif'] },
                    colors: { primary: '#0D9488', secondary: '#F0FDFA', accent: '#F43F5E' },
                    animation: { 'bounce-slow': 'bounce 3s infinite' }
                }
            }
        }
    </script>

    <style>
        body { touch-action: manipulation; overflow: hidden; background-color: #F8FAFC; -webkit-font-smoothing: antialiased; color: #334155; }
        #app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; position: relative; }
        @media (min-width: 768px) { #app-container { flex-direction: row; } }
        .page { display: none; flex: 1; height: 100%; width: 100%; flex-direction: column; position: relative; padding-bottom: 90px; }
        .page.active { display: flex; }
        @media (min-width: 768px) { .page { padding-bottom: 0; } }

        /* Map Styles */
        #map { flex: 1; width: 100%; z-index: 0; background: #e5e7eb; }
        .pin-marker {
            background-color: white; border-radius: 50%; border: 2.5px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; transition: all 0.3s; width: 44px; height: 44px; position: relative;
        }
        .pin-marker::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid white;
        }
        .pin-marker.active-pin {
            background-color: #0D9488; color: white; border-color: #0D9488; 
            transform: scale(1.25) translateY(-8px); z-index: 3000 !important;
            box-shadow: 0 10px 25px rgba(13, 148, 136, 0.4);
        }
        .pin-marker.active-pin::after { border-top-color: #0D9488; }

        /* Top Controls */
        .top-control-bar {
            position: absolute; top: 16px; left: 16px; right: 16px; z-index: 500;
            display: flex; align-items: flex-start; gap: 10px; pointer-events: none;
        }
        .gps-section { display: flex; flex-direction: column; align-items: center; pointer-events: auto; flex-shrink: 0; }
        .gps-btn {
            width: 44px; height: 44px; background: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #0D9488; font-size: 20px;
            border: 1px solid #E2E8F0; transition: transform 0.2s;
        }
        .gps-btn:active { transform: scale(0.9); }
        .gps-hint-bubble {
            margin-top: 8px; background: rgba(13, 148, 136, 0.95); padding: 6px 10px; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 10px; font-weight: bold; color: white;
            white-space: nowrap; position: relative;
        }
        .gps-hint-bubble::after {
            content: ''; position: absolute; left: 50%; top: -6px; transform: translateX(-50%);
            border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 6px solid rgba(13, 148, 136, 0.95);
        }
        .filter-section {
            flex: 1; overflow-x: auto; pointer-events: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch;
            display: flex; gap: 8px; padding-bottom: 10px; padding-top: 2px;
        }
        .chip {
            padding: 0 16px; border-radius: 100px; font-size: 12px; font-weight: 700; white-space: nowrap;
            background: rgba(255,255,255,0.9); color: #64748B; border: 1px solid #E2E8F0; 
            display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); height: 40px;
        }
        .chip.active { background: #0D9488; color: white; border-color: #0D9488; box-shadow: 0 4px 10px rgba(13, 148, 136, 0.25); }
        .chip:not(.active) { opacity: 0.9; }

        /* Map Cards */
        .card-scroller {
            position: absolute; bottom: 100px; left: 0; right: 0; 
            display: flex; gap: 10px; padding: 0 16px;
            overflow-x: auto; scroll-snap-type: x mandatory; 
            z-index: 1000; padding-bottom: 10px; scrollbar-width: none;
            height: 110px; pointer-events: auto; -webkit-overflow-scrolling: touch;
        }
        @media (min-width: 768px) { .card-scroller { bottom: 40px; justify-content: center; } }
        
        .map-card-compact {
            flex: 0 0 88%; max-width: 340px; scroll-snap-align: center;
            background: white; border-radius: 16px; padding: 12px 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12); border: 1px solid #E2E8F0;
            height: 100%; display: flex; align-items: center; justify-content: space-between; gap: 12px;
            transition: transform 0.3s;
        }
        .map-card-compact.active { border-color: #0D9488; transform: scale(1.02); box-shadow: 0 8px 25px rgba(13, 148, 136, 0.15); }

        .btn-mini {
            width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #F1F5F9; color: #64748B; font-size: 14px; transition: all 0.2s;
        }
        .btn-mini-nav { background: #0D9488; color: white; border-color: #0D9488; box-shadow: 0 2px 5px rgba(13,148,136,0.3); }
        .btn-mini:active { transform: scale(0.95); }

        /* Nav & Search */
        .nav-container { z-index: 3000; }
        @media (max-width: 767px) {
            .nav-container {
                position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                width: 92%; max-width: 400px; height: 64px;
                background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
                border-radius: 32px; box-shadow: 0 8px 30px rgba(0,0,0,0.12);
                display: flex; justify-content: space-evenly; align-items: center; border: 1px solid rgba(255,255,255,0.5);
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #94A3B8; font-size: 10px; font-weight: bold; width: 70px; height: 100%;
            }
            .nav-item i { font-size: 20px; margin-bottom: 2px; }
            .nav-item.active { color: #0D9488; }
            .nav-item.active i { transform: translateY(-3px); }
            .nav-item.active::after { content: ''; width: 4px; height: 4px; background: #0D9488; border-radius: 50%; position: absolute; bottom: 6px; }
        }
        @media (min-width: 768px) {
            .nav-container { width: 260px; height: 100%; background: white; border-right: 1px solid #E2E8F0; display: flex; flex-direction: column; padding-top: 40px; }
            .nav-item { display: flex; align-items: center; gap: 14px; padding: 16px 32px; font-size: 15px; color: #64748B; font-weight: 600; cursor: pointer; }
            .nav-item:hover { background: #F8FAFC; color: #0D9488; }
            .nav-item.active { background: #F0FDFA; color: #0D9488; border-right: 3px solid #0D9488; }
        }

        .search-area {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid #E2E8F0; padding: 12px 16px; position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .search-input {
            width: 100%; padding: 12px 16px 12px 40px; border-radius: 14px; border: 2px solid #F1F5F9;
            background: #F8FAFC; font-weight: bold; color: #334155; transition: all 0.2s; font-size: 14px;
        }
        .search-input:focus { background: white; border-color: #0D9488; outline: none; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94A3B8; }
        .search-status { font-size: 11px; color: #0D9488; font-weight: bold; margin-top: 4px; display: none; }
        .search-status.show { display: block; }
        
        .simple-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 10px; border: 1px solid #F1F5F9; display: flex; justify-content: space-between; align-items: center; }
        .btn-primary { background: #0D9488; color: white; font-weight: 700; padding: 10px 0; border-radius: 10px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-circle-nav { background: #0D9488; color: white; }
        .btn-circle-fav { background: white; border: 1px solid #F1F5F9; color: #CBD5E1; }
        .btn-circle-fav.active { background: #FEF2F2; border-color: #FECDD3; color: #F43F5E; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: white; width: 85%; max-width: 360px; border-radius: 24px; padding: 24px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="text-slate-700">

    <div id="app-container">
        <nav class="nav-container order-2 md:order-1">
            <div class="hidden md:block px-8 mb-8">
                <h1 class="text-2xl font-extrabold text-teal-800 tracking-tight flex items-center gap-3">
                    <span class="w-10 h-10 bg-teal-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg"><i class="fas fa-universal-access"></i></span>
                    HandiMap
                </h1>
                <p class="text-xs text-slate-400 mt-2 font-bold pl-1">Version 24.0</p>
            </div>
            <div class="nav-item active" onclick="switchPage('map')" id="nav-map"><i class="fas fa-map-marked-alt"></i><span>マップ</span></div>
            <div class="nav-item" onclick="switchPage('list')" id="nav-list"><i class="fas fa-search"></i><span>探す</span></div>
            <div class="nav-item" onclick="switchPage('mylist')" id="nav-mylist"><i class="fas fa-heart"></i><span>保存済み</span></div>
        </nav>

        <main class="flex-1 relative h-full order-1 md:order-2 overflow-hidden bg-slate-50">
            
            <div id="page-map" class="page active">
                <div class="top-control-bar">
                    <div class="gps-section">
                        <button onclick="locateUserOnMap()" class="gps-btn"><i class="fas fa-crosshairs"></i></button>
                        <div id="gps-hint" class="gps-hint-bubble animate-bounce-slow">現在地を表示！</div>
                    </div>
                    <div class="filter-section">
                        <button class="chip active" onclick="toggleMapFilter('leisure', this)"><i class="fas fa-rocket"></i> 遊園地</button>
                        <button class="chip active" onclick="toggleMapFilter('aquarium', this)"><i class="fas fa-water"></i> 水族館</button>
                        <button class="chip active" onclick="toggleMapFilter('zoo', this)"><i class="fas fa-paw"></i> 動物園</button>
                        <button class="chip active" onclick="toggleMapFilter('museum', this)"><i class="fas fa-landmark"></i> 博物館</button>
                        <button class="chip active" onclick="toggleMapFilter('park', this)"><i class="fas fa-tree"></i> 公園</button>
                        <button class="chip active" onclick="toggleMapFilter('cinema', this)"><i class="fas fa-film"></i> 映画</button>
                    </div>
                </div>
                <div id="map"></div>
                <div id="card-scroller" class="card-scroller"></div>
            </div>

            <div id="page-list" class="page overflow-y-auto">
                <div class="search-area">
                    <div class="relative w-full mb-3">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="施設名、地名、ジャンル..." 
                               onkeydown="if(event.key === 'Enter') searchLocationAndSort(this.value)"
                               oninput="handleSearchDebounced(this.value)">
                    </div>
                    <div id="search-status" class="search-status"><i class="fas fa-spinner fa-spin"></i> 場所を検索中...</div>
                    <div class="chip-scroll" style="display:flex; gap:8px; overflow-x:auto;">
                        <button class="chip active" onclick="applyListFilter('all', this)">すべて</button>
                        <button class="chip" onclick="applyListFilter('leisure', this)">遊園地</button>
                        <button class="chip" onclick="applyListFilter('aquarium', this)">水族館</button>
                        <button class="chip" onclick="applyListFilter('zoo', this)">動物園</button>
                        <button class="chip" onclick="applyListFilter('museum', this)">博物館</button>
                    </div>
                    <div id="location-prompt" class="mt-3 hidden animate-pulse-fast bg-teal-50 border border-teal-100 rounded-xl p-3 flex items-center justify-between cursor-pointer hover:bg-teal-100 transition-colors" onclick="locateUserForList()">
                        <div class="flex items-center gap-2 text-xs font-bold text-teal-800"><i class="fas fa-location-arrow"></i> <span>現在地を取得</span></div>
                        <span class="bg-white px-3 py-1 rounded-full text-[10px] text-teal-600 font-extrabold shadow-sm">ON</span>
                    </div>
                </div>
                <div id="list-container" class="p-4 pb-28 md:pb-12 max-w-3xl mx-auto w-full min-h-[50vh]"></div>
            </div>

            <div id="page-mylist" class="page overflow-y-auto">
                <div class="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b border-slate-100 px-6 py-4 shadow-sm flex justify-between items-center">
                    <h1 class="text-lg font-bold text-slate-800"><i class="fas fa-bookmark text-pink-500 mr-2"></i>保存済み</h1>
                    <div class="flex bg-slate-100 rounded-lg p-1 gap-1">
                        <button onclick="switchListTab('fav')" id="tab-fav" class="px-3 py-1.5 text-xs font-bold rounded-md bg-white text-teal-600 shadow-sm transition-all">行きたい</button>
                        <button onclick="switchListTab('visited')" id="tab-visited" class="px-3 py-1.5 text-xs font-bold rounded-md text-slate-400 transition-all">行った</button>
                    </div>
                </div>
                <div id="mylist-container" class="p-4 pb-20 md:pb-12 max-w-3xl mx-auto w-full"></div>
                <div class="p-6 border-t border-slate-200 mt-auto bg-slate-50 text-center">
                    <h3 class="text-xs font-bold text-slate-400 mb-3">データ引き継ぎ</h3>
                    <div class="flex gap-3 justify-center mb-6">
                        <button onclick="openBackupModal('export')" class="flex-1 px-4 py-2 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 shadow-sm hover:bg-slate-50"><i class="fas fa-copy mr-1"></i> コードを表示</button>
                        <button onclick="openBackupModal('import')" class="flex-1 px-4 py-2 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 shadow-sm hover:bg-slate-50"><i class="fas fa-paste mr-1"></i> コードを入力</button>
                    </div>
                    <button onclick="downloadCSV()" class="text-[10px] text-slate-300 hover:text-slate-500 underline">
                        管理者用データダウンロード
                    </button>
                </div>
            </div>

        </main>
    </div>

    <div id="map-select-modal" class="modal-overlay">
        <div class="modal-box text-left">
            <h3 class="text-xl font-bold mb-1 text-slate-800 text-center">経路案内を開始</h3>
            <p class="text-xs text-slate-400 mb-6 text-center">移動前に最新情報をご確認ください</p>
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 text-center">
                <p class="text-xs font-bold text-blue-800 mb-2">⚠️ 料金・営業時間に変更がある場合があります</p>
                <a id="modal-hp-link" href="#" target="_blank" class="block w-full bg-white text-blue-600 font-bold py-3 rounded-lg border border-blue-200 text-xs hover:bg-blue-600 hover:text-white transition-colors">
                    <i class="fas fa-external-link-alt mr-2"></i> 公式ホームページを確認
                </a>
            </div>
            <div class="text-xs font-bold text-slate-400 mb-2 pl-1">マップアプリを選択:</div>
            <div class="flex flex-col gap-3 mb-4">
                <button onclick="confirmNavigation('google')" class="p-3 rounded-xl border-2 border-slate-100 hover:border-teal-500 hover:bg-teal-50 transition-all flex items-center group bg-white">
                    <i class="fab fa-google text-lg mr-3 text-red-500"></i><div class="flex-1 text-sm font-bold text-slate-700">Googleマップ</div><i class="fas fa-chevron-right text-slate-300"></i>
                </button>
                <button onclick="confirmNavigation('default')" class="p-3 rounded-xl border-2 border-slate-100 hover:border-teal-500 hover:bg-teal-50 transition-all flex items-center group bg-white">
                    <i class="fas fa-mobile-alt text-lg mr-3 text-slate-600"></i><div class="flex-1 text-sm font-bold text-slate-700">標準マップ</div><i class="fas fa-chevron-right text-slate-300"></i>
                </button>
            </div>
            <button onclick="closeModal('map-select-modal')" class="text-sm text-slate-400 font-bold w-full py-2">閉じる</button>
        </div>
    </div>

    <div id="backup-modal" class="modal-overlay">
        <div class="modal-box text-left">
            <h3 id="backup-title" class="text-lg font-bold mb-2 text-slate-800 text-center">データ保存</h3>
            <p id="backup-desc" class="text-xs text-slate-500 mb-4 text-center">このコードをコピーしてメモ帳に保存してください。</p>
            <textarea id="backup-text" class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono mb-4 resize-none focus:border-teal-500 focus:outline-none"></textarea>
            <button id="backup-action-btn" class="btn-primary mb-3">コピーする</button>
            <button onclick="closeModal('backup-modal')" class="text-xs text-slate-400 font-bold w-full py-2">閉じる</button>
        </div>
    </div>

    <div id="region-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="text-lg font-bold mb-2 text-slate-800">位置情報が取得できません</h3>
            <p class="text-sm text-slate-500 mb-6">端末の設定を確認してください。</p>
            <button onclick="closeModal('region-modal')" class="btn-primary bg-slate-500">閉じる</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const STORAGE_KEY = 'handimap_persistent_save_v1';
        const facilitiesData = [
    {
        "id": 101,
        "name": "東京スカイツリー",
        "pref": "東京都",
        "area": "墨田区",
        "category": "leisure",
        "lat": 35.71,
        "lng": 139.8107,
        "price": "半額 (休日1150円～)",
        "address": "墨田区押上1-1-2",
        "url": "https://www.tokyo-skytree.jp/"
    },
    {
        "id": 102,
        "name": "東京タワー",
        "pref": "東京都",
        "area": "港区",
        "category": "leisure",
        "lat": 35.6585,
        "lng": 139.7454,
        "price": "半額 (600円)",
        "address": "港区芝公園4-2-8",
        "url": "https://www.tokyotower.co.jp/"
    },
    {
        "id": 103,
        "name": "新宿御苑",
        "pref": "東京都",
        "area": "新宿区",
        "category": "park",
        "lat": 35.6851,
        "lng": 139.71,
        "price": "無料 (付添1名含)",
        "address": "新宿区内藤町11",
        "url": "https://fng.or.jp/shinjuku/"
    },
    {
        "id": 104,
        "name": "上野動物園",
        "pref": "東京都",
        "area": "台東区",
        "category": "zoo",
        "lat": 35.7165,
        "lng": 139.7713,
        "price": "無料 (付添1名含)",
        "address": "台東区上野公園9-83",
        "url": "https://www.tokyo-zoo.net/zoo/ueno/"
    },
    {
        "id": 105,
        "name": "葛西臨海水族園",
        "pref": "東京都",
        "area": "江戸川区",
        "category": "aquarium",
        "lat": 35.6401,
        "lng": 139.8624,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都江戸川区臨海町6-2-3",
        "url": "https://www.tokyo-zoo.net/zoo/kasai/"
    },
    {
        "id": 106,
        "name": "国立科学博物館",
        "pref": "東京都",
        "area": "台東区",
        "category": "museum",
        "lat": 35.7163,
        "lng": 139.7766,
        "price": "無料 (付添1名含)",
        "address": "台東区上野公園7-20",
        "url": "https://www.kahaku.go.jp/"
    },
    {
        "id": 107,
        "name": "日本科学未来館",
        "pref": "東京都",
        "area": "江東区",
        "category": "museum",
        "lat": 35.6193,
        "lng": 139.7765,
        "price": "無料 (付添1名含)",
        "address": "江東区青海2-3-6",
        "url": "https://www.miraikan.jst.go.jp/"
    },
    {
        "id": 108,
        "name": "サンリオピューロランド",
        "pref": "東京都",
        "area": "多摩市",
        "category": "leisure",
        "lat": 35.6247,
        "lng": 139.4293,
        "price": "200円引",
        "address": "多摩市落合1-31",
        "url": "https://www.puroland.jp/"
    },
    {
        "id": 109,
        "name": "TOHOシネマズ",
        "pref": "東京都",
        "area": "都内各所",
        "category": "cinema",
        "lat": 35.6955,
        "lng": 139.702,
        "price": "1000円 (付添1名含)",
        "address": "新宿ほか都内各所",
        "url": "https://www.tohotheater.jp/"
    },
    {
        "id": 110,
        "name": "国立新美術館",
        "pref": "東京都",
        "area": "港区",
        "category": "museum",
        "lat": 35.6652,
        "lng": 139.7263,
        "price": "無料 (企画展含)",
        "address": "港区六本木",
        "url": "https://www.nact.jp/"
    },
    {
        "id": 111,
        "name": "森美術館",
        "pref": "東京都",
        "area": "港区",
        "category": "museum",
        "lat": 35.6604,
        "lng": 139.7292,
        "price": "半額",
        "address": "港区六本木ヒルズ",
        "url": "https://www.mori.art.museum/"
    },
    {
        "id": 201,
        "name": "新江ノ島水族館",
        "pref": "神奈川県",
        "area": "藤沢市",
        "category": "aquarium",
        "lat": 35.3089,
        "lng": 139.4819,
        "price": "半額 (1250円)",
        "address": "藤沢市片瀬海岸",
        "url": "https://www.enosui.com/"
    },
    {
        "id": 202,
        "name": "よこはま動物園ズーラシア",
        "pref": "神奈川県",
        "area": "横浜市",
        "category": "zoo",
        "lat": 35.4944,
        "lng": 139.5255,
        "price": "無料 (付添1名含)",
        "address": "横浜市旭区",
        "url": "https://www.hama-midorinokyokai.or.jp/zoo/zoorasia/"
    },
    {
        "id": 204,
        "name": "横浜・八景島シーパラダイス",
        "pref": "神奈川県",
        "area": "横浜市",
        "category": "leisure",
        "lat": 35.3367,
        "lng": 139.6469,
        "price": "半額 (パス等)",
        "address": "横浜市金沢区",
        "url": "https://www.seaparadise.co.jp/"
    },
    {
        "id": 301,
        "name": "東京ディズニーランド/シー",
        "pref": "千葉県",
        "area": "浦安市",
        "category": "leisure",
        "lat": 35.6329,
        "lng": 139.8804,
        "price": "専用パス (6800円～)",
        "address": "浦安市舞浜",
        "url": "https://www.tokyodisneyresort.jp/"
    },
    {
        "id": 302,
        "name": "鴨川シーワールド",
        "pref": "千葉県",
        "area": "鴨川市",
        "category": "aquarium",
        "lat": 35.1157,
        "lng": 140.1189,
        "price": "半額 (1650円)",
        "address": "鴨川市東町",
        "url": "https://www.kamogawa-seaworld.jp/"
    },
    {
        "id": 303,
        "name": "マザー牧場",
        "pref": "千葉県",
        "area": "富津市",
        "category": "zoo",
        "lat": 35.2639,
        "lng": 139.9328,
        "price": "半額 (750円)",
        "address": "富津市田倉",
        "url": "https://www.motherfarm.co.jp/"
    },
    {
        "id": 401,
        "name": "鉄道博物館",
        "pref": "埼玉県",
        "area": "さいたま市",
        "category": "museum",
        "lat": 35.9209,
        "lng": 139.6196,
        "price": "半額 (660円)",
        "address": "さいたま市大宮区",
        "url": "https://www.railway-museum.jp/"
    },
    {
        "id": 403,
        "name": "西武園ゆうえんち",
        "pref": "埼玉県",
        "area": "所沢市",
        "category": "leisure",
        "lat": 35.7644,
        "lng": 139.4447,
        "price": "割引あり",
        "address": "所沢市山口",
        "url": "https://www.seibu-leisure.co.jp/"
    },
    {
        "id": 501,
        "name": "アクアワールド大洗",
        "pref": "茨城県",
        "area": "大洗町",
        "category": "aquarium",
        "lat": 36.3134,
        "lng": 140.5898,
        "price": "半額 (1150円)",
        "address": "東茨城郡大洗町",
        "url": "https://www.aquaworld-oarai.com/"
    },
    {
        "id": 901,
        "name": "イオンシネマ",
        "pref": "全域",
        "area": "各店舗",
        "category": "cinema",
        "lat": null,
        "lng": null,
        "price": "1000円",
        "address": "関東各所",
        "url": "https://www.aeoncinema.com/"
    },
    {
        "id": 1000,
        "name": "多摩動物公園",
        "pref": "東京都",
        "area": "日野市",
        "category": "zoo",
        "lat": 35.649538,
        "lng": 139.402201,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都日野市程久保7-1-1",
        "url": "https://www.tokyo-zoo.net/zoo/tama/"
    },
    {
        "id": 1001,
        "name": "井の頭自然文化園",
        "pref": "東京都",
        "area": "武蔵野市",
        "category": "zoo",
        "lat": 35.700908,
        "lng": 139.571034,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都武蔵野市御殿山1-17-6",
        "url": "https://www.tokyo-zoo.net/zoo/ino/"
    },
    {
        "id": 1002,
        "name": "神代植物公園",
        "pref": "東京都",
        "area": "調布市",
        "category": "park",
        "lat": 35.672146,
        "lng": 139.546022,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都調布市深大寺元町5-31-10",
        "url": "https://www.tokyo-park.or.jp/park/jindai/"
    },
    {
        "id": 1003,
        "name": "夢の島熱帯植物館",
        "pref": "東京都",
        "area": "江東区",
        "category": "park",
        "lat": 35.651128,
        "lng": 139.829413,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都江東区夢の島2-1-2",
        "url": "https://www.yumenoshima.jp/"
    },
    {
        "id": 1004,
        "name": "東京都美術館",
        "pref": "東京都",
        "area": "台東区",
        "category": "museum",
        "lat": 35.717242,
        "lng": 139.772791,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都台東区上野公園8-36",
        "url": "https://www.tobikan.jp/"
    },
    {
        "id": 1005,
        "name": "国立西洋美術館",
        "pref": "東京都",
        "area": "台東区",
        "category": "museum",
        "lat": 35.715392,
        "lng": 139.77586,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都台東区上野公園7-7",
        "url": "https://www.nmwa.go.jp/"
    },
    {
        "id": 1006,
        "name": "江戸東京たてもの園",
        "pref": "東京都",
        "area": "小金井市",
        "category": "museum",
        "lat": 35.71271,
        "lng": 139.512332,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都小金井市桜町3-7-1",
        "url": "https://www.tatemonoen.jp/"
    },
    {
        "id": 1007,
        "name": "東京都庭園美術館",
        "pref": "東京都",
        "area": "港区",
        "category": "museum",
        "lat": 35.636853,
        "lng": 139.719244,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都港区白金台5-21-9",
        "url": "https://www.teien-art-museum.ne.jp/"
    },
    {
        "id": 1008,
        "name": "小石川後楽園",
        "pref": "東京都",
        "area": "文京区",
        "category": "park",
        "lat": 35.705351,
        "lng": 139.748979,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都文京区後楽1-6-6",
        "url": "https://www.tokyo-park.or.jp/park/koishikawakorakuen/"
    },
    {
        "id": 1009,
        "name": "六義園",
        "pref": "東京都",
        "area": "文京区",
        "category": "park",
        "lat": 35.733139,
        "lng": 139.746512,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都文京区本駒込6-16-3",
        "url": "https://www.tokyo-park.or.jp/park/rikugien/"
    },
    {
        "id": 1010,
        "name": "浜離宮恩賜庭園",
        "pref": "東京都",
        "area": "中央区",
        "category": "park",
        "lat": 35.662931,
        "lng": 139.763149,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都中央区浜離宮庭園1-1",
        "url": "https://www.tokyo-park.or.jp/park/hamarikyu/"
    },
    {
        "id": 1011,
        "name": "清澄庭園",
        "pref": "東京都",
        "area": "江東区",
        "category": "park",
        "lat": 35.680678,
        "lng": 139.797822,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都江東区清澄3-3-9",
        "url": "https://www.tokyo-park.or.jp/park/kiyosumi/"
    },
    {
        "id": 1012,
        "name": "旧古河庭園",
        "pref": "東京都",
        "area": "北区",
        "category": "park",
        "lat": 35.7425,
        "lng": 139.7461,
        "price": "本人および同伴者1名無料（障害者手帳提示）",
        "address": "東京都北区西ケ原1-27-39",
        "url": "https://www.tokyo-park.or.jp/park/kyufurukawa/"
    }
];

        let map, markers = {};
        let userStatus = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let userCurrentPos = null;
        let activeListCategory = 'all'; 
        let activeMapCategories = new Set(['leisure', 'aquarium', 'zoo', 'museum', 'park', 'cinema']);
        let searchQuery = "";
        let currentListTab = 'fav';
        let searchDebounceTimer;

        window.onload = function() {
            initMap();
            renderList();
            renderMyList();
        };

        // --- CSV DOWNLOAD (Protected) ---
        function downloadCSV() {
            const password = prompt("管理者パスワードを入力してください");
            if (password === "19870429") {
                const headers = ['id', 'name', 'pref', 'area', 'category', 'lat', 'lng', 'price', 'address', 'url'];
                let csvContent = "\uFEFF" + headers.join(",") + "\n";
                facilitiesData.forEach(item => {
                    const row = headers.map(header => {
                        const val = item[header] !== undefined && item[header] !== null ? item[header] : "";
                        const stringVal = String(val);
                        return stringVal.includes(",") || stringVal.includes('"') ? `"${stringVal.replace(/"/g, '""')}"` : stringVal;
                    });
                    csvContent += row.join(",") + "\n";
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "handimap_data.csv";
                link.click();
            } else {
                if(password !== null) alert("パスワードが違います");
            }
        }

        // --- BACKUP LOGIC (Text Base) ---
        function openBackupModal(type) {
            const modal = document.getElementById('backup-modal');
            const title = document.getElementById('backup-title');
            const desc = document.getElementById('backup-desc');
            const textarea = document.getElementById('backup-text');
            const btn = document.getElementById('backup-action-btn');
            modal.classList.add('show');
            if(type === 'export') {
                title.innerText = "データを保存（書き出し）"; desc.innerText = "以下のコードをコピーして保存してください。";
                textarea.value = JSON.stringify(userStatus); textarea.readOnly = true;
                btn.innerText = "コードをコピー";
                btn.onclick = function() { textarea.select(); document.execCommand('copy'); alert("コピーしました！"); };
            } else {
                title.innerText = "データを復元（読み込み）"; desc.innerText = "保存していたコードを貼り付けてください。";
                textarea.value = ""; textarea.readOnly = false;
                btn.innerText = "復元する";
                btn.onclick = function() {
                    try {
                        const data = JSON.parse(textarea.value);
                        if(confirm("データを上書きしますか？")) {
                            userStatus = data; localStorage.setItem(STORAGE_KEY, JSON.stringify(userStatus));
                            renderMyList(); renderList(); alert("復元しました！"); closeModal('backup-modal');
                        }
                    } catch(e) { alert("コードが正しくありません。"); }
                };
            }
        }

        // --- MAP LOGIC ---
        function initMap() {
            if(map) return;
            map = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 9);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(map);
            if (window.innerWidth >= 768) L.control.zoom({ position: 'bottomright' }).addTo(map);
            map.on('moveend', () => updateVisibleSpots());
            map.on('touchstart click', () => { hideGpsHint(); });
            renderAllMarkers();
            
            const scroller = document.getElementById('card-scroller');
            scroller.addEventListener('scroll', () => {
                let center = scroller.scrollLeft + (scroller.offsetWidth / 2);
                let cards = document.querySelectorAll('.map-card-compact');
                let closest = null, minDiff = Infinity;
                cards.forEach(card => {
                    let diff = Math.abs(center - (card.offsetLeft + (card.offsetWidth / 2)));
                    if(diff < minDiff) { minDiff = diff; closest = card; }
                });
                if(closest) {
                    cards.forEach(c => c.classList.remove('active'));
                    closest.classList.add('active');
                    const id = parseInt(closest.dataset.id);
                    if(id && id !== window.lastCenteredId) {
                        window.lastCenteredId = id;
                        const spot = facilitiesData.find(f => f.id === id);
                        if(spot) {
                            map.panTo([spot.lat, spot.lng], {animate: true, duration: 0.5});
                            document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
                            const pin = document.getElementById(`pin-${id}`); if(pin) pin.classList.add('active-pin');
                        }
                    }
                }
            });
        }

        function renderAllMarkers() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            facilitiesData.forEach(spot => {
                if (!spot.lat) return;
                if (!activeMapCategories.has(spot.category)) return;
                const icon = L.divIcon({ className: 'custom-div-icon', html: `<div id="pin-${spot.id}" class="pin-marker">${getIcon(spot.category)}</div>`, iconSize: [44, 44], iconAnchor: [22, 50] });
                const marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
                marker.on('click', () => { setActiveFacilityOnMap(spot.id); map.flyTo([spot.lat, spot.lng], 14); });
                markers[spot.id] = marker;
            });
        }

        function toggleMapFilter(cat, btn) {
            if (activeMapCategories.has(cat)) { activeMapCategories.delete(cat); btn.classList.remove('active'); }
            else { activeMapCategories.add(cat); btn.classList.add('active'); }
            renderAllMarkers(); updateVisibleSpots();
        }

        function updateVisibleSpots() {
            const center = map.getCenter();
            const refLat = userCurrentPos ? userCurrentPos.lat : center.lat;
            const refLng = userCurrentPos ? userCurrentPos.lng : center.lng;
            const sorted = facilitiesData.filter(f => f.lat && activeMapCategories.has(f.category))
                .map(f => ({ ...f, dist: getDistance(refLat, refLng, f.lat, f.lng) })).sort((a, b) => a.dist - b.dist).slice(0, 15);
            renderMapCards(sorted);
        }

        function renderMapCards(spots) {
            const scroller = document.getElementById('card-scroller');
            scroller.innerHTML = '';
            const spacer = document.createElement('div'); spacer.style.flex = "0 0 10px"; scroller.appendChild(spacer);
            spots.forEach(spot => {
                const status = userStatus[spot.id] || {};
                const card = document.createElement('div');
                card.className = "map-card-compact bg-white";
                card.dataset.id = spot.id;
                card.onclick = () => { map.flyTo([spot.lat, spot.lng], 14); setActiveFacilityOnMap(spot.id); };
                card.innerHTML = `
                    <div class="flex flex-col justify-center flex-1 mr-2" onclick="window.open('${spot.url}', '_blank'); event.stopPropagation();">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-slate-800 text-sm line-clamp-1 underline decoration-dotted decoration-teal-500">${spot.name}</h3>
                            <i class="fas fa-external-link-alt text-xs text-teal-500"></i>
                        </div>
                        <p class="text-[10px] text-slate-400"><i class="fas fa-map-marker-alt"></i> ${spot.dist < 1 ? Math.round(spot.dist*1000)+'m' : spot.dist.toFixed(1)+'km'}</p>
                        <p class="text-xs text-red-500 font-bold mt-1 line-clamp-1">${spot.price}</p>
                    </div>
                    <div class="flex flex-col gap-2 shrink-0">
                        <button onclick="toggleStatus(${spot.id}, 'fav'); event.stopPropagation();" class="btn-circle btn-circle-fav ${status.fav ? 'active' : ''}"><i class="${status.fav ? 'fas' : 'far'} fa-heart"></i></button>
                        <button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}', '${spot.url}'); event.stopPropagation();" class="btn-circle btn-circle-nav"><i class="fas fa-location-arrow"></i></button>
                    </div>
                `;
                scroller.appendChild(card);
            });
            const spacerEnd = document.createElement('div'); spacerEnd.style.flex = "0 0 10px"; scroller.appendChild(spacerEnd);
        }

        function setActiveFacilityOnMap(id) {
            const spot = facilitiesData.find(f => f.id === id); if(!spot) return;
            document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
            const pin = document.getElementById(`pin-${id}`); if(pin) pin.classList.add('active-pin');
            const cards = document.querySelectorAll('.map-card-compact');
            for(let card of cards) {
                if(parseInt(card.dataset.id) === id) {
                    card.scrollIntoView({behavior: "smooth", inline: "center"});
                    break;
                }
            }
        }

        function locateUserOnMap() {
             hideGpsHint();
             if(!navigator.geolocation) { document.getElementById('region-modal').classList.add('show'); return; }
             navigator.geolocation.getCurrentPosition((pos) => {
                 userCurrentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                 if(window.userMarker) map.removeLayer(window.userMarker);
                 const icon = L.divIcon({ className: '', html: '<div style="width:20px;height:20px;background:#0D9488;border-radius:50%;border:3px solid white;box-shadow:0 0 0 4px rgba(13,148,136,0.3);"></div>' });
                 window.userMarker = L.marker([userCurrentPos.lat, userCurrentPos.lng], {icon: icon}).addTo(map);
                 map.flyTo([userCurrentPos.lat, userCurrentPos.lng], 13);
                 updateVisibleSpots();
             });
        }

        function hideGpsHint() { const el = document.getElementById('gps-hint'); if(el) el.style.display = 'none'; }

        // --- SEARCH & LOCATION ---
        function handleSearchDebounced(val) {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                if(val.length > 0) searchLocationAndSort(val); 
                else { searchQuery = ""; renderList(); }
            }, 800);
        }

        async function searchLocationAndSort(query) {
            searchQuery = query.toLowerCase().trim();
            const statusEl = document.getElementById('search-status');
            statusEl.classList.add('show');
            try {
                renderList(); 
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    userCurrentPos = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    renderList();
                    statusEl.innerText = `「${data[0].display_name.split(',')[0]}」周辺`;
                } else {
                    statusEl.innerText = "施設名で検索中...";
                }
            } catch (e) { statusEl.innerText = "検索中..."; }
            setTimeout(() => { statusEl.classList.remove('show'); statusEl.innerText = '検索中...'; }, 4000);
        }

        // --- LIST ---
        function applyListFilter(cat, btn) {
            activeListCategory = cat;
            btn.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderList();
        }

        function renderList() {
            const container = document.getElementById('list-container'); if(!container) return;
            container.innerHTML = '';
            let targets = facilitiesData.filter(f => {
                if (activeListCategory !== 'all') {
                    if (activeListCategory === 'leisure' && (f.category === 'zoo' || f.category === 'aquarium')) return true;
                    if (f.category !== activeListCategory) return false;
                }
                if (searchQuery) {
                    const q = searchQuery;
                    return f.name.toLowerCase().includes(q) || f.pref.toLowerCase().includes(q) || f.area.toLowerCase().includes(q);
                }
                return true;
            });
            if (userCurrentPos) {
                targets = targets.map(f => {
                    if(!f.lat) return {...f, dist: Infinity};
                    return {...f, dist: getDistance(userCurrentPos.lat, userCurrentPos.lng, f.lat, f.lng)};
                }).sort((a,b) => a.dist - b.dist);
            }
            if (targets.length === 0) { container.innerHTML = `<div class="text-center py-10 text-slate-400 font-bold">該当なし</div>`; return; }
            targets.forEach(spot => {
                const status = userStatus[spot.id] || {};
                let distStr = "";
                if (userCurrentPos && spot.lat) {
                    const d = spot.dist !== undefined ? spot.dist : getDistance(userCurrentPos.lat, userCurrentPos.lng, spot.lat, spot.lng);
                    distStr = d < 1 ? Math.round(d*1000)+'m' : d.toFixed(1)+'km';
                }
                const card = document.createElement('div');
                card.className = "simple-card";
                card.innerHTML = `
                    <div class="flex-1" onclick="window.open('${spot.url}', '_blank')">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-slate-800 text-sm line-clamp-1">${spot.name}</h3>
                            <i class="fas fa-external-link-alt text-xs text-teal-500"></i>
                        </div>
                        <p class="text-[10px] text-slate-400"><i class="fas fa-map-marker-alt"></i> ${spot.area} ${distStr ? ' · '+distStr : ''}</p>
                        <p class="text-xs text-red-500 font-bold mt-1">${spot.price}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleStatus(${spot.id}, 'fav'); event.stopPropagation();" class="btn-circle btn-circle-fav ${status.fav ? 'active' : ''}"><i class="${status.fav ? 'fas' : 'far'} fa-heart"></i></button>
                        ${spot.lat ? `<button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}', '${spot.url}'); event.stopPropagation();" class="btn-circle btn-circle-nav"><i class="fas fa-location-arrow"></i></button>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Common ---
        function handleNavClick(lat, lng, name, url) {
            window.tempNavTarget = { lat, lng, name };
            const linkEl = document.getElementById('modal-hp-link');
            if(linkEl) linkEl.href = url;
            document.getElementById('map-select-modal').classList.add('show');
        }
        function confirmNavigation(provider) {
            document.getElementById('map-select-modal').classList.remove('show');
            if (window.tempNavTarget) {
                const t = window.tempNavTarget;
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                if (provider === 'google') window.open(`https://www.google.com/maps/search/?api=1&query=${t.lat},${t.lng}&query_place_id=${encodeURIComponent(t.name)}`, '_blank');
                else if (isIOS) window.open(`http://maps.apple.com/?q=${encodeURIComponent(t.name)}&ll=${t.lat},${t.lng}`, '_system');
                else window.open(`geo:${t.lat},${t.lng}?q=${encodeURIComponent(t.name)}`, '_system');
            }
        }
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            if(pageId === 'map') setTimeout(() => map.invalidateSize(), 300);
            if(pageId === 'mylist') renderMyList();
        }
        function handleSearch(val) { searchQuery = val.toLowerCase().trim(); renderList(); }
        function locateUserForList() {
            if(!navigator.geolocation) { document.getElementById('region-modal').classList.add('show'); return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                userCurrentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                document.getElementById('location-prompt').classList.add('hidden');
                renderList();
            });
        }
        function toggleStatus(id, type) {
            if(!userStatus[id]) userStatus[id] = {};
            userStatus[id][type] = !userStatus[id][type];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userStatus));
            renderList(); renderMyList();
            if(document.getElementById('page-map').classList.contains('active')) updateVisibleSpots();
        }
        function switchListTab(tab) {
            currentListTab = tab;
            document.getElementById('tab-fav').className = `px-3 py-1.5 text-xs font-bold rounded-md transition-all ${tab==='fav' ? 'bg-white text-teal-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('tab-visited').className = `px-3 py-1.5 text-xs font-bold rounded-md transition-all ${tab==='visited' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400'}`;
            renderMyList();
        }
        function renderMyList() {
            const container = document.getElementById('mylist-container');
            container.innerHTML = '';
            const list = facilitiesData.filter(f => userStatus[f.id]?.[currentListTab]);
            if(list.length === 0) { container.innerHTML = `<div class="text-center text-slate-400 py-10 font-bold">まだありません</div>`; return; }
            list.forEach(spot => {
               // Use same simple-card style for consistency
                const status = userStatus[spot.id] || {};
                const card = document.createElement('div');
                card.className = "simple-card";
                card.innerHTML = `
                    <div class="flex-1" onclick="window.open('${spot.url}', '_blank')">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-slate-800 text-sm line-clamp-1">${spot.name}</h3>
                            <i class="fas fa-external-link-alt text-xs text-teal-500"></i>
                        </div>
                        <p class="text-[10px] text-slate-400"><i class="fas fa-map-marker-alt"></i> ${spot.area}</p>
                        <p class="text-xs text-red-500 font-bold mt-1">${spot.price}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleStatus(${spot.id}, '${currentListTab}'); event.stopPropagation();" class="btn-circle btn-circle-fav active"><i class="fas fa-trash"></i></button>
                        ${spot.lat ? `<button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}', '${spot.url}'); event.stopPropagation();" class="btn-circle btn-circle-nav"><i class="fas fa-location-arrow"></i></button>` : ''}
                    </div>
                `;
                container.appendChild(card); 
            });
        }
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getIcon(cat) { const icons = { leisure:'🎡', zoo:'🐘', aquarium:'🐬', cinema:'🎬', museum:'🏛️', park:'🌳', other:'🎤' }; return icons[cat] || '📍'; }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    </script>
</body>
</html>
