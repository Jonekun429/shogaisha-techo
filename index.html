<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HandiMap Kanto - éšœå®³è€…æ‰‹å¸³ã§æ¥½ã—ã‚€é–¢æ±</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"M PLUS Rounded 1c"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#0F766E',
                        secondary: '#F0FDFA',
                        accent: '#F43F5E',
                    },
                    boxShadow: {
                        'float': '0 8px 30px rgba(0,0,0,0.12)',
                        'card': '0 4px 12px rgba(0,0,0,0.08)',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            touch-action: manipulation; overflow: hidden; background-color: #F8FAFC;
            -webkit-font-smoothing: antialiased; color: #334155;
        }

        /* Layout */
        #app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; position: relative; }
        @media (min-width: 768px) { #app-container { flex-direction: row; } }
        .page { display: none; flex: 1; height: 100%; width: 100%; flex-direction: column; position: relative; padding-bottom: 90px; opacity: 0; transition: opacity 0.3s ease; }
        .page.active { display: flex; opacity: 1; }
        @media (min-width: 768px) { .page { padding-bottom: 0; } }

        /* Map */
        #map { flex: 1; width: 100%; z-index: 0; background: #e5e7eb; }
        .pin-marker {
            background-color: white; border-radius: 50%; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; transition: all 0.3s; width: 48px; height: 48px; position: relative; border: 2px solid #fff;
        }
        .pin-marker::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 10px solid white;
        }
        .pin-marker.active-pin {
            background-color: #0F766E; color: white; border-color: #0F766E; 
            transform: scale(1.2) translateY(-10px); z-index: 3000 !important;
            box-shadow: 0 10px 25px rgba(15, 118, 110, 0.5);
        }
        .pin-marker.active-pin::after { border-top-color: #0F766E; }

        /* Controls */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .category-filter {
            display: flex; gap: 8px; overflow-x: auto; padding: 6px;
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .category-filter::-webkit-scrollbar { display: none; }
        .filter-btn {
            padding: 8px 16px; border-radius: 100px; font-size: 13px; font-weight: 700; white-space: nowrap;
            transition: all 0.2s; background: white; color: #64748B; border: 1px solid #E2E8F0;
            display: flex; align-items: center; gap: 6px;
        }
        .filter-btn.active {
            background: #0F766E; color: white; border-color: #0F766E; transform: translateY(-1px);
        }

        /* GPS Hint Bubble */
        .gps-hint-bubble {
            position: absolute; right: 60px; top: 8px;
            background: white; padding: 8px 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 12px; font-weight: bold; color: #0F766E;
            white-space: nowrap; pointer-events: none; z-index: 1000;
        }
        .gps-hint-bubble::after {
            content: ''; position: absolute; right: -6px; top: 50%; transform: translateY(-50%);
            border-left: 6px solid white; border-top: 6px solid transparent; border-bottom: 6px solid transparent;
        }

        /* Search Bar Styles */
        .search-wrapper {
            position: relative; width: 100%;
        }
        .search-input {
            width: 100%; padding: 12px 16px 12px 42px;
            border-radius: 16px; border: 2px solid #E2E8F0;
            background: #F8FAFC; font-weight: bold; color: #334155;
            transition: all 0.2s;
        }
        .search-input:focus {
            background: white; border-color: #0F766E; outline: none;
            box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
        }
        .search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: #94A3B8; font-size: 18px; pointer-events: none;
        }

        /* Nav */
        .nav-container { z-index: 3000; }
        @media (max-width: 767px) {
            .nav-container {
                position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                width: 92%; max-width: 400px; height: 70px;
                background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
                border-radius: 35px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);
                display: flex; justify-content: space-evenly; align-items: center;
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #94A3B8; font-size: 11px; font-weight: bold; width: 70px; height: 100%;
            }
            .nav-item i { font-size: 22px; transition: transform 0.2s; }
            .nav-item.active { color: #0F766E; }
            .nav-item.active i { transform: translateY(-2px); }
        }
        @media (min-width: 768px) {
            .nav-container {
                width: 280px; height: 100%; background: white; border-right: 1px solid #F1F5F9;
                display: flex; flex-direction: column; padding-top: 40px;
            }
            .nav-item {
                display: flex; align-items: center; gap: 16px; padding: 18px 32px; font-size: 16px;
                color: #64748B; font-weight: 600; cursor: pointer; transition: all 0.2s;
            }
            .nav-item:hover { background: #F8FAFC; color: #0F766E; }
            .nav-item.active { background: #F0FDFA; color: #0F766E; border-right: 4px solid #0F766E; }
        }

        /* Cards & Utils */
        .card-scroller {
            position: absolute; bottom: 100px; left: 0; right: 0;
            display: flex; gap: 16px; padding: 0 20px;
            overflow-x: auto; scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; z-index: 1000;
            padding-bottom: 20px; scrollbar-width: none;
        }
        @media (min-width: 768px) { .card-scroller { bottom: 30px; justify-content: center; } }
        .card-scroller::-webkit-scrollbar { display: none; }
        
        .map-card {
            flex: 0 0 90%; max-width: 380px;
            background: white; border-radius: 24px; padding: 24px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            scroll-snap-align: center; transition: transform 0.3s, border 0.3s;
            border: 3px solid transparent; position: relative; display: flex; flex-direction: column;
        }
        .map-card.active { border-color: #0F766E; transform: translateY(-4px); }

        .btn-primary {
            background: linear-gradient(135deg, #0F766E, #14B8A6); color: white;
            font-weight: 700; padding: 12px 24px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary:active { transform: scale(0.96); }
        .tag { font-size: 11px; padding: 4px 10px; border-radius: 8px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
        .tag-price { background: #FEF2F2; color: #BE123C; border: 1px solid #FECDD3; }
        .tag-area { background: #F1F5F9; color: #475569; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-box {
            background: white; width: 88%; max-width: 400px; border-radius: 28px;
            padding: 24px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            transform: scale(0.95); transition: transform 0.3s;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }
    </style>
</head>
<body class="text-slate-700">

    <div id="app-container">
        <nav class="nav-container order-2 md:order-1">
            <div class="hidden md:block px-8 mb-8">
                <h1 class="text-2xl font-bold text-teal-900 tracking-tight flex items-center gap-3">
                    <span class="w-10 h-10 bg-teal-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg"><i class="fas fa-map-marked-alt"></i></span>
                    HandiMap
                </h1>
                <p class="text-sm text-slate-400 mt-2 font-bold pl-1">é–¢æ±ãƒ»å‰²å¼•æ–½è¨­ãƒãƒƒãƒ—</p>
            </div>

            <div class="nav-item active" onclick="switchPage('map')" id="nav-map">
                <i class="fas fa-search-location"></i><span>ãƒãƒƒãƒ—</span>
            </div>
            <div class="nav-item" onclick="switchPage('list')" id="nav-list">
                <i class="fas fa-list-ul"></i><span>æ–½è¨­ä¸€è¦§</span>
            </div>
            <div class="nav-item" onclick="switchPage('mylist')" id="nav-mylist">
                <i class="fas fa-heart"></i><span>ãŠæ°—ã«å…¥ã‚Š</span>
            </div>
        </nav>

        <main class="flex-1 relative h-full order-1 md:order-2 overflow-hidden bg-slate-50">
            
            <div id="page-map" class="page active">
                <div class="absolute top-5 left-4 right-4 z-[500] flex flex-col gap-3 pointer-events-none md:top-8 md:left-8 md:right-8 md:flex-row md:justify-between md:items-start">
                    
                    <div class="glass-panel rounded-full p-1 pointer-events-auto max-w-full overflow-hidden shadow-float">
                        <div class="category-filter">
                            <button onclick="setFilter('all')" id="filter-all" class="filter-btn active">ã™ã¹ã¦</button>
                            <button onclick="setFilter('leisure')" id="filter-leisure" class="filter-btn"><i class="fas fa-rocket text-purple-500"></i>ãƒ¬ã‚¸ãƒ£ãƒ¼</button>
                            <button onclick="setFilter('museum')" id="filter-museum" class="filter-btn"><i class="fas fa-landmark text-amber-500"></i>åšç‰©é¤¨</button>
                            <button onclick="setFilter('aquarium')" id="filter-aquarium" class="filter-btn"><i class="fas fa-fish text-blue-500"></i>æ°´æ—é¤¨</button>
                            <button onclick="setFilter('park')" id="filter-park" class="filter-btn"><i class="fas fa-tree text-green-500"></i>å…¬åœ’</button>
                        </div>
                    </div>

                    <div class="flex gap-3 pointer-events-auto self-end md:self-auto relative">
                        <div id="gps-hint" class="gps-hint-bubble animate-bounce-slow">
                            ã“ã“ã‚’æŠ¼ã—ã¦ç¾åœ¨åœ°ã‚’è¡¨ç¤ºï¼
                        </div>
                        <button onclick="locateUser()" class="w-12 h-12 bg-white rounded-full shadow-float text-teal-600 flex items-center justify-center active:scale-90 transition-transform text-lg">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>
                </div>

                <div id="map"></div>
                <div id="card-scroller" class="card-scroller"></div>
            </div>

            <div id="page-list" class="page overflow-y-auto">
                <div class="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b border-slate-100 px-6 py-4 shadow-sm">
                    <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-3">
                        <i class="fas fa-list text-teal-600"></i> æ–½è¨­ã‚’æ¢ã™
                    </h1>
                    
                    <div class="search-wrapper mb-2">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="æ–½è¨­åã€åœ°åã€æ˜ ç”»ã€æ°´æ—é¤¨..." oninput="handleSearch(this.value)">
                    </div>

                    <div id="location-prompt" class="hidden animate-pulse-fast bg-teal-50 border border-teal-100 rounded-lg p-3 flex items-center justify-between cursor-pointer hover:bg-teal-100 transition-colors" onclick="locateUserForList()">
                        <div class="flex items-center gap-2 text-xs font-bold text-teal-700">
                            <i class="fas fa-map-marker-alt"></i> 
                            <span>ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹ã¨ã€è·é›¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span>
                        </div>
                        <span class="bg-white px-2 py-1 rounded text-[10px] text-teal-600 font-bold shadow-sm">å–å¾—ã™ã‚‹</span>
                    </div>

                    <p id="total-count" class="text-xs font-bold text-slate-400 mt-2 text-right">å…¨ä»¶è¡¨ç¤ºä¸­</p>
                </div>
                
                <div id="pref-list-container" class="p-6 pb-28 md:pb-12 max-w-4xl mx-auto w-full min-h-[50vh]"></div>
            </div>

            <div id="page-mylist" class="page overflow-y-auto">
                <div class="sticky top-0 z-20 bg-white/90 backdrop-blur-md border-b border-slate-100 px-6 py-5 flex justify-between items-center shadow-sm">
                    <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-bookmark text-pink-500"></i> ãŠæ°—ã«å…¥ã‚Š
                    </h1>
                    <div class="flex bg-slate-100 rounded-lg p-1 gap-1">
                        <button onclick="switchListTab('fav')" id="tab-fav" class="px-4 py-2 text-xs font-bold rounded-md bg-white text-teal-600 shadow-sm transition-all">è¡ŒããŸã„</button>
                        <button onclick="switchListTab('visited')" id="tab-visited" class="px-4 py-2 text-xs font-bold rounded-md text-slate-400 transition-all">è¡Œã£ãŸ</button>
                    </div>
                </div>
                <div id="mylist-container" class="p-6 pb-28 md:pb-12 grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto w-full"></div>
            </div>

        </main>
    </div>

    <div id="map-select-modal" class="modal-overlay">
        <div class="modal-box text-left">
            <h3 class="text-xl font-bold mb-1 text-slate-800 text-center">ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚’é¸æŠ</h3>
            <p class="text-xs text-slate-400 mb-6 text-center">çµŒè·¯æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™</p>
            
            <div class="flex flex-col gap-3 mb-6">
                <button onclick="confirmNavigation('google')" class="p-4 rounded-xl border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center group">
                    <div class="w-10 h-10 bg-white shadow-sm rounded-full flex items-center justify-center text-xl mr-3 text-red-500"><i class="fab fa-google"></i></div>
                    <div><div class="text-sm font-bold text-slate-700 group-hover:text-blue-600">Googleãƒãƒƒãƒ—</div><div class="text-[10px] text-slate-400">æ¨å¥¨ãƒ»PC/ã‚¹ãƒãƒ›å…±é€š</div></div>
                    <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
                </button>
                <button onclick="confirmNavigation('default')" class="p-4 rounded-xl border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center group">
                    <div class="w-10 h-10 bg-white shadow-sm rounded-full flex items-center justify-center text-xl mr-3 text-slate-700"><i class="fas fa-mobile-alt"></i></div>
                    <div><div class="text-sm font-bold text-slate-700 group-hover:text-blue-600">æ¨™æº–ãƒãƒƒãƒ—</div><div class="text-[10px] text-slate-400">iPhoneæ¨™æº– / Androidæ¨™æº–</div></div>
                    <i class="fas fa-chevron-right ml-auto text-slate-300"></i>
                </button>
            </div>

            <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-100">
                <h4 class="text-xs font-bold text-yellow-700 mb-2 flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i> åˆ©ç”¨æ™‚ã®ã”æ³¨æ„</h4>
                <ul class="text-[10px] text-yellow-800 space-y-1.5 leading-relaxed list-disc pl-3">
                    <li><strong>å‰²å¼•ã«ã¤ã„ã¦:</strong> åŸºæœ¬çš„ã«ã€Œæœ¬äººï¼‹ä»˜æ·»1åã€ã¾ã§é©ç”¨ã§ã™ãŒã€è©³ç´°ã¯å„HPã‚’ã”ç¢ºèªãã ã•ã„ã€‚</li>
                    <li><strong>å¤‰å‹•ä¾¡æ ¼:</strong> ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚„ã‚µãƒ³ãƒªã‚ªç­‰ã¯æ—¥ã«ã‚ˆã‚Šä¾¡æ ¼ãŒç•°ãªã‚Šã¾ã™ã€‚</li>
                    <li><strong>æ‰‹å¸³ã®æç¤º:</strong> å‰²å¼•ã«ã¯å¿…ãšæ‰‹å¸³ï¼ˆã¾ãŸã¯ãƒŸãƒ©ã‚¤ãƒ­IDï¼‰ã®æç¤ºãŒå¿…è¦ã§ã™ã€‚</li>
                </ul>
            </div>
            <button onclick="closeModal('map-select-modal')" class="mt-4 text-sm text-slate-400 font-bold w-full py-2">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="region-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="w-14 h-14 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl"><i class="fas fa-map-marker-slash"></i></div>
            <h3 class="text-lg font-bold mb-2 text-slate-800">ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</h3>
            <p class="text-sm text-slate-500 mb-6 leading-relaxed">ç«¯æœ«ã®è¨­å®šã§ä½ç½®æƒ…å ±ã‚’è¨±å¯ã™ã‚‹ã‹ã€<br>æ‰‹å‹•ã§ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            <button onclick="closeModal('region-modal')" class="btn-primary w-full bg-slate-500">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ ---
        const facilities = [
            // æ±äº¬éƒ½
            { id: 101, name: "æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼", pref: "æ±äº¬éƒ½", area: "å¢¨ç”°åŒº", category: "leisure", lat: 35.7100, lng: 139.8107, price: "åŠé¡ (ä¼‘æ—¥å¤§äºº1,150å††ã€œ)", address: "å¢¨ç”°åŒºæŠ¼ä¸Š1-1-2", url: "https://www.tokyo-skytree.jp/" },
            { id: 102, name: "æ±äº¬ã‚¿ãƒ¯ãƒ¼", pref: "æ±äº¬éƒ½", area: "æ¸¯åŒº", category: "leisure", lat: 35.6585, lng: 139.7454, price: "åŠé¡ (ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚­600å††)", address: "æ¸¯åŒºèŠå…¬åœ’4-2-8", url: "https://www.tokyotower.co.jp/" },
            { id: 103, name: "æ–°å®¿å¾¡è‹‘", pref: "æ±äº¬éƒ½", area: "æ–°å®¿åŒº", category: "park", lat: 35.6851, lng: 139.7100, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "æ–°å®¿åŒºå†…è—¤ç”º11", url: "https://fng.or.jp/shinjuku/" },
            { id: 104, name: "ä¸Šé‡å‹•ç‰©åœ’", pref: "æ±äº¬éƒ½", area: "å°æ±åŒº", category: "zoo", lat: 35.7165, lng: 139.7713, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "å°æ±åŒºä¸Šé‡å…¬åœ’9-83", url: "https://www.tokyo-zoo.net/zoo/ueno/" },
            { id: 105, name: "è‘›è¥¿è‡¨æµ·æ°´æ—åœ’", pref: "æ±äº¬éƒ½", area: "æ±Ÿæˆ¸å·åŒº", category: "aquarium", lat: 35.6401, lng: 139.8624, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "æ±Ÿæˆ¸å·åŒºè‡¨æµ·ç”º6-2-3", url: "https://www.tokyo-zoo.net/zoo/kasai/" },
            { id: 106, name: "å›½ç«‹ç§‘å­¦åšç‰©é¤¨", pref: "æ±äº¬éƒ½", area: "å°æ±åŒº", category: "museum", lat: 35.7163, lng: 139.7766, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "å°æ±åŒºä¸Šé‡å…¬åœ’7-20", url: "https://www.kahaku.go.jp/" },
            { id: 107, name: "æ—¥æœ¬ç§‘å­¦æœªæ¥é¤¨", pref: "æ±äº¬éƒ½", area: "æ±Ÿæ±åŒº", category: "museum", lat: 35.6193, lng: 139.7765, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "æ±Ÿæ±åŒºé’æµ·2-3-6", url: "https://www.miraikan.jst.go.jp/" },
            { id: 108, name: "ã‚µãƒ³ãƒªã‚ªãƒ”ãƒ¥ãƒ¼ãƒ­ãƒ©ãƒ³ãƒ‰", pref: "æ±äº¬éƒ½", area: "å¤šæ‘©å¸‚", category: "leisure", lat: 35.6247, lng: 139.4293, price: "çª“å£ä¾¡æ ¼ã‚ˆã‚Š200å††å¼•", address: "å¤šæ‘©å¸‚è½åˆ1-31", url: "https://www.puroland.jp/" },
            { id: 109, name: "TOHOã‚·ãƒãƒã‚º", pref: "æ±äº¬éƒ½", area: "éƒ½å†…å„æ‰€", category: "cinema", lat: 35.6955, lng: 139.7020, price: "1,000å†† (æœ¬äººï¼‹ä»˜æ·»1å)", address: "æ–°å®¿ã»ã‹éƒ½å†…å„æ‰€", url: "https://www.tohotheater.jp/" },
            { id: 110, name: "å›½ç«‹æ–°ç¾è¡“é¤¨", pref: "æ±äº¬éƒ½", area: "æ¸¯åŒº", category: "museum", lat: 35.6652, lng: 139.7263, price: "ç„¡æ–™(ä¼ç”»å±•å«)", address: "æ¸¯åŒºå…­æœ¬æœ¨", url: "https://www.nact.jp/" },
            { id: 111, name: "æ£®ç¾è¡“é¤¨", pref: "æ±äº¬éƒ½", area: "æ¸¯åŒº", category: "museum", lat: 35.6604, lng: 139.7292, price: "åŠé¡(è¦æ‰‹å¸³)", address: "æ¸¯åŒºå…­æœ¬æœ¨ãƒ’ãƒ«ã‚º", url: "https://www.mori.art.museum/" },
            // ç¥å¥ˆå·çœŒ
            { id: 201, name: "æ–°æ±Ÿãƒå³¶æ°´æ—é¤¨", pref: "ç¥å¥ˆå·çœŒ", area: "è—¤æ²¢å¸‚", category: "aquarium", lat: 35.3089, lng: 139.4819, price: "åŠé¡ (å¤§äºº1,250å††)", address: "è—¤æ²¢å¸‚ç‰‡ç€¬æµ·å²¸2-19-1", url: "https://www.enosui.com/" },
            { id: 202, name: "ã‚ˆã“ã¯ã¾å‹•ç‰©åœ’ã‚ºãƒ¼ãƒ©ã‚·ã‚¢", pref: "ç¥å¥ˆå·çœŒ", area: "æ¨ªæµœå¸‚", category: "zoo", lat: 35.4944, lng: 139.5255, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "æ¨ªæµœå¸‚æ—­åŒºä¸Šç™½æ ¹ç”º1175-1", url: "https://www.hama-midorinokyokai.or.jp/zoo/zoorasia/" },
            { id: 203, name: "ã‚«ãƒƒãƒ—ãƒŒãƒ¼ãƒ‰ãƒ«ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ", pref: "ç¥å¥ˆå·çœŒ", area: "æ¨ªæµœå¸‚", category: "museum", lat: 35.4555, lng: 139.6389, price: "å…¥é¤¨æ–™ç„¡æ–™ (ä½“é¨“æ–™åˆ¥)", address: "æ¨ªæµœå¸‚ä¸­åŒºæ–°æ¸¯2-3-4", url: "https://www.cupnoodles-museum.jp/" },
            { id: 204, name: "æ¨ªæµœãƒ»å…«æ™¯å³¶ã‚·ãƒ¼ãƒ‘ãƒ©ãƒ€ã‚¤ã‚¹", pref: "ç¥å¥ˆå·çœŒ", area: "æ¨ªæµœå¸‚", category: "leisure", lat: 35.3367, lng: 139.6469, price: "åŠé¡ (ã‚¢ã‚¯ã‚¢ãƒªã‚¾ãƒ¼ãƒ„ãƒ‘ã‚¹ç­‰)", address: "æ¨ªæµœå¸‚é‡‘æ²¢åŒºå…«æ™¯å³¶", url: "https://www.seaparadise.co.jp/" },
            // åƒè‘‰çœŒ
            { id: 301, name: "æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰/ã‚·ãƒ¼", pref: "åƒè‘‰çœŒ", area: "æµ¦å®‰å¸‚", category: "leisure", lat: 35.6329, lng: 139.8804, price: "å°‚ç”¨ãƒ‘ã‚¹ (å¤§äºº6,800å††ã€œ)", address: "æµ¦å®‰å¸‚èˆæµœ1-1", url: "https://www.tokyodisneyresort.jp/" },
            { id: 302, name: "é´¨å·ã‚·ãƒ¼ãƒ¯ãƒ¼ãƒ«ãƒ‰", pref: "åƒè‘‰çœŒ", area: "é´¨å·å¸‚", category: "aquarium", lat: 35.1157, lng: 140.1189, price: "åŠé¡ (å¤§äºº1,650å††)", address: "é´¨å·å¸‚æ±ç”º1464-18", url: "https://www.kamogawa-seaworld.jp/" },
            { id: 303, name: "ãƒã‚¶ãƒ¼ç‰§å ´", pref: "åƒè‘‰çœŒ", area: "å¯Œæ´¥å¸‚", category: "zoo", lat: 35.2639, lng: 139.9328, price: "åŠé¡ (å¤§äºº750å††)", address: "å¯Œæ´¥å¸‚ç”°å€‰940-3", url: "https://www.motherfarm.co.jp/" },
            { id: 304, name: "æ±äº¬ãƒ‰ã‚¤ãƒ„æ‘", pref: "åƒè‘‰çœŒ", area: "è¢–ã‚±æµ¦å¸‚", category: "leisure", lat: 35.4055, lng: 140.0543, price: "åŠé¡ (å¤§äºº500å††)", address: "è¢–ã‚±æµ¦å¸‚æ°¸å‰419", url: "https://t-doitsumura.co.jp/" },
            // åŸ¼ç‰çœŒ
            { id: 401, name: "é‰„é“åšç‰©é¤¨", pref: "åŸ¼ç‰çœŒ", area: "ã•ã„ãŸã¾å¸‚", category: "museum", lat: 35.9209, lng: 139.6196, price: "åŠé¡ (ä¸€èˆ¬660å††)", address: "ã•ã„ãŸã¾å¸‚å¤§å®®åŒºå¤§æˆç”º3-47", url: "https://www.railway-museum.jp/" },
            { id: 402, name: "æ±æ­¦å‹•ç‰©å…¬åœ’", pref: "åŸ¼ç‰çœŒ", area: "å®®ä»£ç”º", category: "zoo", lat: 36.0244, lng: 139.7136, price: "å…¥åœ’æ–™åŠé¡ (å¤§äºº950å††)", address: "å—åŸ¼ç‰éƒ¡å®®ä»£ç”ºé ˆè³€110", url: "https://www.tobuzoo.com/" },
            { id: 403, name: "è¥¿æ­¦åœ’ã‚†ã†ãˆã‚“ã¡", pref: "åŸ¼ç‰çœŒ", area: "æ‰€æ²¢å¸‚", category: "leisure", lat: 35.7644, lng: 139.4447, price: "å‰²å¼•ã‚ã‚Š", address: "æ‰€æ²¢å¸‚å±±å£2964", url: "https://www.seibu-leisure.co.jp/" },
            // èŒ¨åŸçœŒ
            { id: 501, name: "ã‚¢ã‚¯ã‚¢ãƒ¯ãƒ¼ãƒ«ãƒ‰å¤§æ´—", pref: "èŒ¨åŸçœŒ", area: "å¤§æ´—ç”º", category: "aquarium", lat: 36.3134, lng: 140.5898, price: "åŠé¡ (å¤§äºº1,150å††)", address: "æ±èŒ¨åŸéƒ¡å¤§æ´—ç”ºç£¯æµœç”º", url: "https://www.aquaworld-oarai.com/" },
            { id: 502, name: "å›½å–¶ã²ãŸã¡æµ·æµœå…¬åœ’", pref: "èŒ¨åŸçœŒ", area: "ã²ãŸã¡ãªã‹å¸‚", category: "park", lat: 36.4042, lng: 140.5960, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "ã²ãŸã¡ãªã‹å¸‚é¦¬æ¸¡å­—å¤§æ²¼", url: "https://hitachikaihin.jp/" },
            // æ ƒæœ¨çœŒ
            { id: 601, name: "æ—¥å…‰æ±Ÿæˆ¸æ‘", pref: "æ ƒæœ¨çœŒ", area: "æ—¥å…‰å¸‚", category: "leisure", lat: 36.8043, lng: 139.6974, price: "å¤§äºº3,500å†† (é€šå¸¸5,800å††)", address: "æ—¥å…‰å¸‚æŸ„å€‰470-2", url: "http://edowonderland.net/" },
            { id: 602, name: "æ±æ­¦ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¯ã‚¦ã‚§ã‚¢", pref: "æ ƒæœ¨çœŒ", area: "æ—¥å…‰å¸‚", category: "leisure", lat: 36.8073, lng: 139.7121, price: "åŠé¡ (å¤§äºº1,400å††)", address: "æ—¥å…‰å¸‚é¬¼æ€’å·æ¸©æ³‰å¤§åŸ", url: "https://www.tobuws.co.jp/" },
            // ç¾¤é¦¬çœŒ
            { id: 701, name: "ç¾¤é¦¬ã‚µãƒ•ã‚¡ãƒªãƒ‘ãƒ¼ã‚¯", pref: "ç¾¤é¦¬çœŒ", area: "å¯Œå²¡å¸‚", category: "zoo", lat: 36.2628, lng: 138.9100, price: "å…¥åœ’æ–™åŠé¡ (å¤§äºº1,350å††)", address: "å¯Œå²¡å¸‚å²¡æœ¬1", url: "https://www.safari.co.jp/" },
            { id: 702, name: "å¯Œå²¡è£½ç³¸å ´", pref: "ç¾¤é¦¬çœŒ", area: "å¯Œå²¡å¸‚", category: "museum", lat: 36.2550, lng: 138.8986, price: "ç„¡æ–™ (æœ¬äººï¼‹ä»˜æ·»1å)", address: "å¯Œå²¡å¸‚å¯Œå²¡1-1", url: "https://www.tomioka-silk.jp/" },
            // å…¨åŸŸ
            { id: 901, name: "ã‚¤ã‚ªãƒ³ã‚·ãƒãƒ", pref: "å…¨åŸŸ", area: "å„åº—èˆ—", category: "cinema", lat: null, lng: null, price: "1,000å†† (æœ¬äººï¼‹ä»˜æ·»1å)", address: "é–¢æ±å„æ‰€ã®åŠ‡å ´", url: "https://www.aeoncinema.com/" },
            { id: 902, name: "ãƒ“ãƒƒã‚°ã‚¨ã‚³ãƒ¼", pref: "å…¨åŸŸ", area: "å„åº—èˆ—", category: "other", lat: null, lng: null, price: "å®¤æ–™50%OFF (ä¼šå“¡ä¾¡æ ¼ã‚ˆã‚Š)", address: "é–¢æ±å„æ‰€ã®åº—èˆ—", url: "https://big-echo.jp/" },
            { id: 903, name: "ã‚«ãƒ©ã‚ªã‚±é¤¨", pref: "å…¨åŸŸ", area: "å„åº—èˆ—", category: "other", lat: null, lng: null, price: "å®¤æ–™50%OFF (ä¸€èˆ¬æ–™é‡‘ã‚ˆã‚Š)", address: "é–¢æ±å„æ‰€ã®åº—èˆ—", url: "http://karaokekan.jp/" }
        ];

        // --- State ---
        let map;
        let markers = {};
        let currentFilter = 'all';
        let currentListTab = 'fav';
        let userStatus = JSON.parse(localStorage.getItem('handimap_v7_status')) || {};
        let activeFacilityId = null;
        let visibleFacilities = [];
        let userLocationMarker = null;
        let userCurrentPos = null; // {lat, lng}
        let currentSearchQuery = "";

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            renderList();
            renderMyList();
        });

        // --- Map Functions ---
        function initMap() {
            map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([35.6895, 139.6917], 9);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap Â© CARTO', maxZoom: 19
            }).addTo(map);

            if (window.innerWidth >= 768) L.control.zoom({ position: 'bottomright' }).addTo(map);

            map.on('moveend', () => {
                const center = map.getCenter();
                updateVisibleSpots(center.lat, center.lng);
            });
            map.on('touchstart click', () => { hideGpsHint(); });

            const scroller = document.getElementById('card-scroller');
            let isScrolling;
            scroller.addEventListener('scroll', () => {
                window.clearTimeout(isScrolling);
                isScrolling = setTimeout(() => detectActiveCard(), 100);
            });

            renderAllMarkers();
            updateVisibleSpots(35.6895, 139.6917);
        }

        function renderAllMarkers() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            facilities.forEach(spot => {
                if (!spot.lat || !spot.lng) return;
                const displayCategory = (spot.category === 'zoo' || spot.category === 'aquarium') ? 'leisure' : spot.category;
                if (currentFilter !== 'all' && displayCategory !== currentFilter && spot.category !== currentFilter) return;

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div id="pin-${spot.id}" class="pin-marker">${getIcon(spot.category)}</div>`,
                    iconSize: [48, 48], iconAnchor: [24, 56]
                });
                const marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
                marker.on('click', () => { setActiveFacility(spot.id); });
                markers[spot.id] = marker;
            });
        }

        function updateVisibleSpots(lat, lng) {
            const validSpots = facilities.filter(f => f.lat && f.lng);
            const sorted = validSpots.map(f => {
                const dist = getDistance(lat, lng, f.lat, f.lng);
                return { ...f, dist };
            }).sort((a, b) => a.dist - b.dist);

            let filtered = sorted;
            if (currentFilter !== 'all') {
                filtered = sorted.filter(f => {
                     const displayCategory = (f.category === 'zoo' || f.category === 'aquarium') ? 'leisure' : f.category;
                     return displayCategory === currentFilter || f.category === currentFilter;
                });
            }
            visibleFacilities = filtered.slice(0, 15);
            renderCards();
        }

        function renderCards() {
            const scroller = document.getElementById('card-scroller');
            scroller.innerHTML = '';
            if (visibleFacilities.length === 0) return;
            const spacerStart = document.createElement('div');
            spacerStart.style.flex = "0 0 10px";
            scroller.appendChild(spacerStart);
            visibleFacilities.forEach(spot => {
                const card = document.createElement('div');
                card.id = `card-${spot.id}`;
                card.className = 'map-card';
                card.onclick = () => setActiveFacility(spot.id);
                const status = userStatus[spot.id] || {};
                const distDisplay = spot.dist < 1 ? `${Math.round(spot.dist * 1000)}m` : `${spot.dist.toFixed(1)}km`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="tag tag-price">${spot.price.split(' ')[0]}</span>
                        <div class="text-3xl opacity-20 transform rotate-12">${getIcon(spot.category)}</div>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 leading-snug mb-1 line-clamp-1">${spot.name}</h3>
                    <p class="text-xs text-slate-500 font-bold mb-1">${spot.price}</p>
                    <p class="text-xs text-slate-400 mb-4 flex items-center">
                        <i class="fas fa-map-marker-alt mr-1"></i>${spot.pref} ${spot.area} 
                        <span class="text-teal-600 ml-2 font-bold">(${distDisplay}å…ˆ)</span>
                    </p>
                    <div class="mt-auto flex gap-3">
                        <button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}')" class="btn-primary flex-1 text-sm shadow-md">
                            <i class="fas fa-location-arrow"></i> è¡Œã
                        </button>
                        <button onclick="event.stopPropagation(); toggleStatus(${spot.id}, 'fav')" class="w-12 h-12 rounded-xl flex items-center justify-center border-2 transition-all ${status.fav ? 'border-pink-200 bg-pink-50 text-pink-500' : 'border-slate-100 bg-white text-slate-300'}">
                            <i class="${status.fav ? 'fas' : 'far'} fa-heart text-lg"></i>
                        </button>
                    </div>
                `;
                scroller.appendChild(card);
            });
            const spacerEnd = document.createElement('div');
            spacerEnd.style.flex = "0 0 10px";
            scroller.appendChild(spacerEnd);
        }

        function setActiveFacility(id) {
            if (activeFacilityId === id) return;
            activeFacilityId = id;
            document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
            const pin = document.getElementById(`pin-${id}`);
            if(pin) pin.classList.add('active-pin');
            const spot = facilities.find(f => f.id === id);
            if(spot && spot.lat) {
                const isDesktop = window.innerWidth >= 768;
                const offset = isDesktop ? 0 : map.getSize().y * 0.25;
                const targetPoint = map.project([spot.lat, spot.lng], map.getZoom()).subtract([0, -offset]);
                map.flyTo(map.unproject(targetPoint, map.getZoom()), 14, { duration: 0.8 });
            }
            setTimeout(() => {
                const card = document.getElementById(`card-${id}`);
                if(card) {
                    card.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    document.querySelectorAll('.map-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                }
            }, 100);
        }

        function detectActiveCard() {
            const scroller = document.getElementById('card-scroller');
            const center = scroller.scrollLeft + (scroller.offsetWidth / 2);
            let closestId = null, minDiff = Infinity;
            scroller.querySelectorAll('.map-card').forEach(card => {
                const diff = Math.abs(center - (card.offsetLeft + (card.offsetWidth / 2)));
                if(diff < minDiff) { minDiff = diff; closestId = parseInt(card.id.replace('card-', '')); }
            });
            if(closestId && closestId !== activeFacilityId) setActiveFacility(closestId);
        }

        // --- LIST / SEARCH Logic ---
        function handleSearch(query) {
            currentSearchQuery = query.toLowerCase().trim();
            const prompt = document.getElementById('location-prompt');
            
            // Show location prompt only if search is active AND location not set
            if(currentSearchQuery.length > 0 && !userCurrentPos) {
                prompt.classList.remove('hidden');
            } else {
                prompt.classList.add('hidden');
            }
            renderList();
        }

        function locateUserForList() {
            locateUser(); // This sets userCurrentPos
            // Prompt will hide in locateUser's callback or simply wait
        }

        function renderList() {
            const container = document.getElementById('pref-list-container');
            container.innerHTML = '';

            let targetFacilities = facilities;

            // Search Filter
            if (currentSearchQuery) {
                const q = currentSearchQuery;
                const terms = {
                    'æ˜ ç”»': 'cinema', 'æ°´æ—é¤¨': 'aquarium', 'å‹•ç‰©åœ’': 'zoo', 'åšç‰©é¤¨': 'museum', 
                    'ç¾è¡“é¤¨': 'museum', 'å…¬åœ’': 'park', 'éŠåœ’åœ°': 'leisure', 'ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯': 'leisure'
                };
                const catQuery = terms[q]; // Check if user typed "æ°´æ—é¤¨"

                targetFacilities = facilities.filter(f => {
                    const matchName = f.name.toLowerCase().includes(q);
                    const matchPref = f.pref.toLowerCase().includes(q);
                    const matchArea = f.area.toLowerCase().includes(q);
                    const matchCat = catQuery ? f.category === catQuery : false;
                    return matchName || matchPref || matchArea || matchCat;
                });
            }

            document.getElementById('total-count').innerText = `${targetFacilities.length} ä»¶è¡¨ç¤ºä¸­`;

            // If searching, show flat list (sorted by distance if avail)
            if (currentSearchQuery) {
                if (userCurrentPos) {
                    // Sort by distance
                    targetFacilities = targetFacilities.map(f => {
                         if (!f.lat) return { ...f, dist: Infinity };
                         return { ...f, dist: getDistance(userCurrentPos.lat, userCurrentPos.lng, f.lat, f.lng) };
                    }).sort((a, b) => a.dist - b.dist);
                }
                
                // Flat Grid Render
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                
                if (targetFacilities.length === 0) {
                    container.innerHTML = `<div class="text-center text-slate-400 py-10 font-bold">æ¡ä»¶ã«åˆã†æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>`;
                    return;
                }

                targetFacilities.forEach(spot => renderListItem(spot, grid));
                container.appendChild(grid);
                return;
            }

            // Normal Mode (Grouped by Pref)
            const grouped = {};
            const prefOrder = ["æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "åƒè‘‰çœŒ", "åŸ¼ç‰çœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "å…¨åŸŸ"];
            targetFacilities.forEach(f => {
                if(!grouped[f.pref]) grouped[f.pref] = [];
                grouped[f.pref].push(f);
            });

            prefOrder.forEach(pref => {
                if(!grouped[pref]) return;
                const section = document.createElement('div');
                section.className = "mb-8";
                section.innerHTML = `<h2 class="text-lg font-bold text-teal-900 mb-4 flex items-center gap-2 border-l-4 border-teal-500 pl-3">${pref}</h2>`;
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                grouped[pref].forEach(spot => renderListItem(spot, grid));
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        function renderListItem(spot, container) {
            const status = userStatus[spot.id] || {};
            let distHtml = "";
            if (userCurrentPos && spot.lat) {
                const d = getDistance(userCurrentPos.lat, userCurrentPos.lng, spot.lat, spot.lng);
                const distStr = d < 1 ? `${Math.round(d*1000)}m` : `${d.toFixed(1)}km`;
                distHtml = `<span class="bg-teal-50 text-teal-700 px-2 py-0.5 rounded text-[10px] ml-2 font-bold whitespace-nowrap"><i class="fas fa-map-marker-alt"></i> ç¾åœ¨åœ°ã‹ã‚‰ ${distStr}</span>`;
            }

            const item = document.createElement('div');
            item.className = "bg-white rounded-2xl p-5 shadow-card border border-slate-100";
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex flex-wrap gap-1 items-center">
                        <span class="tag tag-area">${spot.area}</span>
                        ${distHtml}
                    </div>
                    <div class="text-xl">${getIcon(spot.category)}</div>
                </div>
                <h3 class="font-bold text-lg text-slate-800 mb-1">${spot.name}</h3>
                <div class="bg-red-50 text-red-700 text-sm font-bold p-2 rounded mb-3">
                    <i class="fas fa-yen-sign"></i> ${spot.price}
                </div>
                <p class="text-xs text-slate-400 mb-4"><i class="fas fa-map-marker-alt"></i> ${spot.address}</p>
                <div class="flex gap-2">
                    ${spot.lat ? 
                        `<button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}')" class="btn-primary text-xs flex-1 py-2"><i class="fas fa-location-arrow"></i> è¡Œã</button>` : 
                        `<a href="${spot.url}" target="_blank" class="btn-primary text-xs flex-1 py-2 bg-slate-600"><i class="fas fa-external-link-alt"></i> å…¬å¼HP</a>`
                    }
                    <button onclick="toggleStatus(${spot.id}, 'fav')" class="py-2 px-4 rounded-xl border border-slate-200 text-slate-400 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200 transition-colors ${status.fav ? '!bg-pink-50 !text-pink-500 !border-pink-200' : ''}">
                        <i class="${status.fav ? 'fas' : 'far'} fa-heart"></i>
                    </button>
                </div>
            `;
            container.appendChild(item);
        }

        function renderMyList() {
            const container = document.getElementById('mylist-container');
            container.innerHTML = '';
            const list = facilities.filter(f => userStatus[f.id]?.[currentListTab]);
            if(list.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-slate-400 font-bold">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }
            list.forEach(spot => {
                const el = document.createElement('div');
                el.className = "bg-white rounded-2xl p-5 shadow-card border border-slate-100";
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                         <span class="tag bg-slate-100 text-slate-500">${spot.pref}</span>
                         <span class="text-2xl">${getIcon(spot.category)}</span>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 mb-1">${spot.name}</h3>
                    <p class="text-xs text-red-500 font-bold mb-4">${spot.price}</p>
                    <div class="flex gap-2 mt-auto">
                        ${spot.lat ? 
                            `<button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}')" class="flex-1 bg-teal-50 text-teal-700 font-bold py-2 rounded-xl text-sm"><i class="fas fa-location-arrow"></i> è¡Œã</button>` : 
                            `<a href="${spot.url}" target="_blank" class="flex-1 bg-slate-100 text-slate-600 font-bold py-2 rounded-xl text-sm text-center">HP</a>`
                        }
                        <button onclick="toggleStatus(${spot.id}, '${currentListTab}')" class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- Nav & Utils ---
        function handleNavClick(lat, lng, name) {
            event.stopPropagation();
            window.tempNavTarget = { lat, lng, name };
            document.getElementById('map-select-modal').classList.add('show');
        }

        function confirmNavigation(provider) {
            document.getElementById('map-select-modal').classList.remove('show');
            if (window.tempNavTarget) {
                const t = window.tempNavTarget;
                openMap(t.lat, t.lng, t.name, provider);
                window.tempNavTarget = null;
            }
        }

        function openMap(lat, lng, name, provider) {
            if (provider === 'google') window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}&query_place_id=${encodeURIComponent(name)}`, '_blank');
            else {
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                if (isIOS) window.open(`http://maps.apple.com/?q=${encodeURIComponent(name)}&ll=${lat},${lng}`, '_system');
                else window.open(`geo:${lat},${lng}?q=${encodeURIComponent(name)}`, '_system');
            }
        }

        function locateUser() {
            hideGpsHint();
            if(!navigator.geolocation) { document.getElementById('region-modal').classList.add('show'); return; }
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                userCurrentPos = { lat, lng }; // Store globally
                
                if(userLocationMarker) map.removeLayer(userLocationMarker);
                const pulseIcon = L.divIcon({ className: 'custom-div-icon', html: '<div style="width:24px;height:24px;background:#0F766E;border-radius:50%;border:4px solid white;box-shadow:0 0 0 4px rgba(15,118,110,0.3);"></div>', iconSize: [24, 24] });
                userLocationMarker = L.marker([lat, lng], {icon: pulseIcon}).addTo(map);
                
                // If on Map Page
                if (document.getElementById('page-map').classList.contains('active')) {
                    map.flyTo([lat, lng], 13); updateVisibleSpots(lat, lng);
                } 
                // If on List Page, re-render to show distances and hide prompt
                else if (document.getElementById('page-list').classList.contains('active')) {
                    document.getElementById('location-prompt').classList.add('hidden');
                    renderList(); // Re-render to show distances
                }
            });
        };

        function hideGpsHint() {
            const el = document.getElementById('gps-hint');
            if(el) el.style.display = 'none';
        }

        function toggleStatus(id, type) {
            if(!userStatus[id]) userStatus[id] = {};
            userStatus[id][type] = !userStatus[id][type];
            localStorage.setItem('handimap_v7_status', JSON.stringify(userStatus));
            renderList(); renderMyList();
            if(document.getElementById('page-map').classList.contains('active')) {
                const center = map.getCenter(); updateVisibleSpots(center.lat, center.lng);
            }
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            if(pageId === 'map') setTimeout(() => map.invalidateSize(), 300);
        }
        function switchListTab(tab) {
            currentListTab = tab;
            document.getElementById('tab-fav').className = `px-4 py-2 text-xs font-bold rounded-md transition-all ${tab==='fav' ? 'bg-white text-teal-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('tab-visited').className = `px-4 py-2 text-xs font-bold rounded-md transition-all ${tab==='visited' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400'}`;
            renderMyList();
        }
        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`filter-${type}`).classList.add('active');
            renderAllMarkers(); const center = map.getCenter(); updateVisibleSpots(center.lat, center.lng);
        }
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getIcon(cat) { const icons = { leisure:'ğŸ¡', zoo:'ğŸ˜', aquarium:'ğŸ¬', cinema:'ğŸ¬', museum:'ğŸ›ï¸', park:'ğŸŒ³', other:'ğŸ¤' }; return icons[cat] || 'ğŸ“'; }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    </script>
</body>
</html>
