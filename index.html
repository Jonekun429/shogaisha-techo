<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HandiMap Travel - Responsive</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'md': '768px',
                        'lg': '1024px',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            touch-action: manipulation; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
        }

        /* ã‚¢ãƒ—ãƒªå…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* PCæ™‚ã¯æ¨ªä¸¦ã³ï¼ˆãƒŠãƒ“ + ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰ */
        @media (min-width: 768px) {
            #app-container {
                flex-direction: row;
            }
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .page { 
            display: none; 
            flex: 1; 
            height: 100%; 
            width: 100%; 
            flex-direction: column; 
            position: relative;
            /* ãƒ¢ãƒã‚¤ãƒ«ã¯ãƒœãƒˆãƒ ãƒŠãƒ“ã®åˆ†ã ã‘ä½™ç™½ */
            padding-bottom: 60px; 
        }
        
        @media (min-width: 768px) {
            .page {
                padding-bottom: 0; /* PCã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ãªã®ã§ä½™ç™½ä¸è¦ */
            }
        }

        .page.active { display: flex; }

        /* ãƒãƒƒãƒ— */
        #map { flex: 1; width: 100%; z-index: 0; background: #e5e7eb; }

        /* æ¤œç´¢ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
        #search-indicator {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.95); padding: 8px 20px; border-radius: 30px;
            font-size: 12px; font-weight: bold; color: #475569;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 500;
            display: flex; align-items: center; gap: 8px;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #search-indicator.show { opacity: 1; }

        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ (ãƒãƒƒãƒ—ç”»é¢ç”¨) */
        .card-scroller {
            position: absolute; bottom: 80px; left: 0; right: 0;
            display: flex; gap: 12px; padding: 0 16px;
            overflow-x: auto; scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; z-index: 1000;
            padding-bottom: 10px; scrollbar-width: none;
            height: 160px;
        }
        @media (min-width: 768px) {
            .card-scroller {
                bottom: 20px; /* PCã¯ãƒŠãƒ“ãŒãªã„ã®ã§ä¸‹å¯„ã› */
                width: 100%;
                max-width: 600px; /* å¹…ã‚’åˆ¶é™ */
                margin: 0 auto;
            }
        }
        .card-scroller::-webkit-scrollbar { display: none; }

        .map-card {
            flex: 0 0 85%;
            background: white; border-radius: 16px; padding: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            scroll-snap-align: center;
            transition: transform 0.2s, border-color 0.2s;
            border: 2px solid transparent;
            display: flex; flex-direction: column;
            position: relative;
            height: 100%;
        }
        @media (min-width: 768px) {
            .map-card {
                flex: 0 0 300px; /* PCã§ã¯å›ºå®šå¹… */
                cursor: pointer;
            }
        }
        .map-card.active { border-color: #2563EB; transform: scale(1.02); }

        /* ãƒ”ãƒ³ãƒãƒ¼ã‚«ãƒ¼ */
        .custom-div-icon { background: transparent; border: none; }
        .pin-marker {
            background-color: white; border-radius: 50%; border: 2px solid #64748b;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: all 0.2s; width: 36px; height: 36px;
        }
        .pin-marker.active-pin {
            background-color: #2563EB; color: white; border-color: #2563EB; 
            transform: scale(1.3); z-index: 3000 !important;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
        }

        /* ã‚¨ãƒªã‚¢é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
        #region-modal {
            display: none; position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #region-modal.show { display: flex; opacity: 1; }
        .modal-content {
            background: white; width: 90%; max-width: 320px; border-radius: 20px;
            padding: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s;
        }
        #region-modal.show .modal-content { transform: scale(1); }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰ */
        .nav-container {
            background: white;
            z-index: 3000;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
        }

        /* ãƒ¢ãƒã‚¤ãƒ«: ãƒœãƒˆãƒ ãƒŠãƒ“ */
        @media (max-width: 767px) {
            .nav-container {
                position: fixed; bottom: 0; left: 0; right: 0;
                border-top: 1px solid #f1f5f9;
                display: flex; justify-content: space-around; 
                padding: 10px 0; padding-bottom: env(safe-area-inset-bottom, 20px);
                height: 60px;
            }
            .nav-item {
                flex-direction: column;
                font-size: 10px;
            }
        }

        /* PC: ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        @media (min-width: 768px) {
            .nav-container {
                position: relative;
                width: 240px;
                height: 100%;
                flex-direction: column;
                justify-content: flex-start;
                padding-top: 20px;
                border-right: 1px solid #e2e8f0;
                box-shadow: 4px 0 10px rgba(0,0,0,0.03);
            }
            .nav-item {
                flex-direction: row;
                font-size: 16px;
                padding: 16px 24px;
                width: 100%;
                justify-content: flex-start;
                gap: 12px;
                transition: background-color 0.2s;
            }
            .nav-item:hover {
                background-color: #f8fafc;
            }
            .nav-item.active {
                background-color: #eff6ff;
                border-right: 3px solid #2563EB;
            }
        }

        .nav-item {
            text-align: center; color: #94a3b8; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .nav-item.active { color: #2563EB; font-weight: bold; }

        /* ãƒªã‚¹ãƒˆ */
        .list-header { background: white; padding: 16px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 20; }
        .scroll-content { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        
        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚°ãƒªãƒƒãƒ‰å¯¾å¿œï¼ˆPCï¼‰ */
        .grid-container {
            display: block;
        }
        @media (min-width: 768px) {
            .grid-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 16px;
                padding: 16px;
            }
            /* ã‚°ãƒªãƒƒãƒ‰æ™‚ã¯ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
            .list-item { margin: 0 !important; height: 100%; }
        }

        .list-item {
            background: white; margin: 12px 16px; padding: 16px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
        }

        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .spot-link { color: #2563EB; text-decoration: underline; text-underline-offset: 3px; cursor: pointer; }
        
        /* PCç”¨ã®ãƒ­ã‚´ã‚¨ãƒªã‚¢ */
        .desktop-logo {
            display: none;
            padding: 0 24px 24px 24px;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 10px;
        }
        @media (min-width: 768px) {
            .desktop-logo { display: block; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container">
        <nav class="nav-container bg-white order-2 md:order-1">
            <div class="desktop-logo">
                <h1 class="text-xl font-bold text-slate-800"><i class="fas fa-map-marked-alt text-blue-500 mr-2"></i>HandiMap</h1>
                <p class="text-xs text-slate-400 mt-1">Travel Support</p>
            </div>

            <div class="nav-item active" onclick="switchPage('map')" id="nav-map">
                <i class="fas fa-map-marked-alt"></i><span>ãƒãƒƒãƒ—</span>
            </div>
            <div class="nav-item" onclick="switchPage('list')" id="nav-list">
                <i class="fas fa-list-ul"></i><span>ã‚¨ãƒªã‚¢ä¸€è¦§</span>
            </div>
            <div class="nav-item" onclick="switchPage('mylist')" id="nav-mylist">
                <i class="fas fa-heart"></i><span>ãƒã‚¤ãƒªã‚¹ãƒˆ</span>
            </div>
        </nav>

        <main class="flex-1 relative h-full order-1 md:order-2 overflow-hidden">
            
            <div id="page-map" class="page active">
                <div class="absolute top-4 left-4 right-4 z-[500] flex justify-between pointer-events-none md:top-6 md:left-6 md:right-6">
                    <div class="bg-white/95 backdrop-blur shadow-md rounded-full px-1 py-1 flex gap-1 pointer-events-auto border border-gray-100 overflow-x-auto max-w-[80%] hide-scrollbar">
                        <button onclick="setFilter('all')" id="filter-all" class="px-3 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white transition-colors whitespace-nowrap">ã™ã¹ã¦</button>
                        <button onclick="setFilter('theme_park')" id="filter-theme_park" class="px-3 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap">éŠåœ’åœ°</button>
                        <button onclick="setFilter('aquarium')" id="filter-aquarium" class="px-3 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap">æ°´æ—é¤¨</button>
                        <button onclick="setFilter('zoo')" id="filter-zoo" class="px-3 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap">å‹•ç‰©åœ’</button>
                        <button onclick="setFilter('cinema')" id="filter-cinema" class="px-3 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap">æ˜ ç”»é¤¨</button>
                        <button onclick="setFilter('museum')" id="filter-museum" class="px-3 py-1.5 rounded-full text-xs font-bold text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap">ç¾è¡“é¤¨</button>
                    </div>
                    <button onclick="locateUser()" id="gps-btn" class="bg-white w-10 h-10 rounded-full shadow-md text-blue-600 flex items-center justify-center pointer-events-auto active:bg-gray-100 border border-gray-100 flex-shrink-0 hover:bg-blue-50 transition-colors">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                </div>

                <div id="search-indicator"><i class="fas fa-map-marked-alt text-blue-500"></i> ã“ã®ã‚¨ãƒªã‚¢ã®æ–½è¨­ã‚’è¡¨ç¤ºä¸­</div>

                <div id="map" class="h-full w-full"></div>
                <div id="card-scroller" class="card-scroller"></div>
            </div>

            <div id="page-list" class="page bg-slate-50">
                <div class="list-header shadow-sm bg-white md:px-8">
                    <h1 class="font-bold text-lg text-slate-800"><i class="fas fa-building mr-2 text-blue-500"></i>å…¨å›½ã®æ–½è¨­ä¸€è¦§</h1>
                    <p id="total-count" class="text-sm font-bold text-blue-600 mt-1">é›†è¨ˆä¸­...</p>
                </div>
                <div id="pref-list-container" class="scroll-content bg-slate-50 md:px-6"></div>
            </div>

            <div id="page-mylist" class="page bg-slate-50">
                <div class="list-header shadow-sm flex justify-between items-center bg-white md:px-8">
                    <h1 class="font-bold text-lg text-slate-800"><i class="fas fa-heart mr-2 text-pink-500"></i>ãƒã‚¤ãƒªã‚¹ãƒˆ</h1>
                    <div class="flex bg-slate-100 rounded-lg p-1">
                        <button onclick="switchListTab('fav')" id="tab-fav" class="px-4 py-1.5 text-xs font-bold rounded bg-white text-blue-600 shadow-sm transition-all">è¡ŒããŸã„ <span id="count-fav">(0)</span></button>
                        <button onclick="switchListTab('visited')" id="tab-visited" class="px-4 py-1.5 text-xs font-bold rounded text-slate-400 transition-all">è¡Œã£ãŸ <span id="count-visited">(0)</span></button>
                    </div>
                </div>
                <div id="mylist-container" class="scroll-content bg-slate-50 pt-2 grid-container md:px-6"></div>
            </div>
        </main>
    </div>

    <div id="region-modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</h3>
            <p class="text-xs text-gray-500 mb-4">ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>è¡¨ç¤ºã—ãŸã„ã‚¨ãƒªã‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="manualLocate(43.0686, 141.3508)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ åŒ—æµ·é“</button>
                <button onclick="manualLocate(38.2682, 140.8694)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ æ±åŒ—</button>
                <button onclick="manualLocate(35.6812, 139.7671)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ é–¢æ±</button>
                <button onclick="manualLocate(35.1814, 136.9066)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ ä¸­éƒ¨</button>
                <button onclick="manualLocate(34.7024, 135.4959)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ é–¢è¥¿</button>
                <button onclick="manualLocate(34.3963, 132.4594)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ ä¸­å›½</button>
                <button onclick="manualLocate(33.5902, 130.4207)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ ä¹å·</button>
                <button onclick="manualLocate(26.2124, 127.6809)" class="py-2 bg-slate-100 rounded-lg text-sm font-bold hover:bg-blue-50 text-slate-700">ğŸ“ æ²–ç¸„</button>
            </div>
            <button onclick="closeModal()" class="w-full py-3 text-sm text-gray-400 font-bold">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // --- çµ±åˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ (ä¸»è¦æ–½è¨­) ---
        // (æ³¨: å…ƒã®ãƒ‡ãƒ¼ã‚¿ã¯é•·ã„ã®ã§ã€ã“ã“ã§ã¯ä¸€éƒ¨ã‚’ä¾‹ç¤ºã—ã¾ã™ãŒã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦åˆ©ç”¨å¯èƒ½ã§ã™)
        // å‹•ä½œç¢ºèªç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ã¾ã™ã€‚
        const facilities = [
            // === åŒ—æµ·é“ãƒ»æ±åŒ— ===
            { id: 1001, name: "æ—­å±±å‹•ç‰©åœ’", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "zoo", lat: 43.7686, lng: 142.4808, tags: ["physical", "mental"], discount: "å…¥åœ’æ–™å…¨é¡å…é™¤", address: "æ—­å·å¸‚", url: "https://www.city.asahikawa.hokkaido.jp/asahiyamazoo/" },
            { id: 1002, name: "å††å±±å‹•ç‰©åœ’", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "zoo", lat: 43.0523, lng: 141.3094, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "æœ­å¹Œå¸‚", url: "https://www.city.sapporo.jp/zoo/" },
            { id: 1003, name: "äº”ç¨œéƒ­ã‚¿ãƒ¯ãƒ¼", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "sightseeing", lat: 41.7947, lng: 140.7543, tags: ["physical", "mental"], discount: "å±•æœ›æ–™é‡‘å‰²å¼•", address: "å‡½é¤¨å¸‚", url: "https://www.goryokaku-tower.co.jp/" },
            { id: 1004, name: "æœ­å¹Œã‚·ãƒãƒãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "cinema", lat: 43.0686, lng: 141.3508, tags: ["physical", "mental"], discount: "1000å††", address: "æœ­å¹Œå¸‚", url: "http://www.cinemafrontier.net/" },
            { id: 1005, name: "ãŠãŸã‚‹æ°´æ—é¤¨", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "aquarium", lat: 43.2422, lng: 141.0128, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "å°æ¨½å¸‚", url: "https://otaru-aq.jp/" },
            { id: 1006, name: "ãƒ«ã‚¹ãƒ„ãƒªã‚¾ãƒ¼ãƒˆ", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "theme_park", lat: 42.7567, lng: 140.9064, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ç•™å¯¿éƒ½æ‘", url: "https://rusutsu.com/" },
            { id: 1007, name: "åŒ—æµ·é“ç«‹è¿‘ä»£ç¾è¡“é¤¨", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "museum", lat: 43.0605, lng: 141.3283, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "æœ­å¹Œå¸‚", url: "https://artmuseum.pref.hokkaido.lg.jp/knb/" },
            { id: 1101, name: "ä»™å°ã†ã¿ã®æœæ°´æ—é¤¨", region: "æ±åŒ—", pref: "å®®åŸçœŒ", category: "aquarium", lat: 38.2711, lng: 140.9902, tags: ["physical", "mental"], discount: "åŠé¡ç¨‹åº¦", address: "ä»™å°å¸‚", url: "http://www.uminomori.jp/" },
            { id: 1102, name: "ã‚¹ãƒ‘ãƒªã‚¾ãƒ¼ãƒˆãƒãƒ¯ã‚¤ã‚¢ãƒ³ã‚º", region: "æ±åŒ—", pref: "ç¦å³¶çœŒ", category: "theme_park", lat: 36.9859, lng: 140.8359, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ã„ã‚ãå¸‚", url: "https://www.hawaiians.co.jp/" },
            { id: 1103, name: "ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³ãµãã—ã¾", region: "æ±åŒ—", pref: "ç¦å³¶çœŒ", category: "aquarium", lat: 36.9427, lng: 140.9022, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "ã„ã‚ãå¸‚", url: "https://www.aquamarine.or.jp/" },
            { id: 1104, name: "é’æ£®çœŒç«‹ç¾è¡“é¤¨", region: "æ±åŒ—", pref: "é’æ£®çœŒ", category: "museum", lat: 40.8039, lng: 140.7011, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "é’æ£®å¸‚", url: "https://www.aomori-museum.jp/" },
            { id: 1105, name: "ãƒªãƒŠãƒ¯ãƒ¼ãƒ«ãƒ‰", region: "æ±åŒ—", pref: "å±±å½¢çœŒ", category: "theme_park", lat: 38.2017, lng: 140.3014, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ä¸Šå±±å¸‚", url: "https://www.linaworld.co.jp/" },

            // === é–¢æ± ===
            { id: 2001, name: "æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰/ã‚·ãƒ¼", region: "é–¢æ±", pref: "åƒè‘‰çœŒ", category: "theme_park", lat: 35.6329, lng: 139.8804, tags: ["physical", "mental"], discount: "å‰²å¼•ãƒã‚±ãƒƒãƒˆ", address: "æµ¦å®‰å¸‚", url: "https://www.tokyodisneyresort.jp/" },
            { id: 2002, name: "æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "sightseeing", lat: 35.7100, lng: 139.8107, tags: ["physical", "mental"], discount: "åŠé¡", address: "å¢¨ç”°åŒº", url: "https://www.tokyo-skytree.jp/" },
            { id: 2003, name: "ã‚µãƒ³ã‚·ãƒ£ã‚¤ãƒ³æ°´æ—é¤¨", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "aquarium", lat: 35.7289, lng: 139.7200, tags: ["physical", "mental"], discount: "åŠé¡", address: "è±Šå³¶åŒº", url: "https://sunshinecity.jp/aquarium/" },
            { id: 2004, name: "æ©è³œä¸Šé‡å‹•ç‰©åœ’", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "zoo", lat: 35.7165, lng: 139.7713, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "å°æ±åŒº", url: "https://www.tokyo-zoo.net/zoo/ueno/" },
            { id: 2005, name: "å›½ç«‹ç§‘å­¦åšç‰©é¤¨", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "museum", lat: 35.7153, lng: 139.7758, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "å°æ±åŒº", url: "https://www.kahaku.go.jp/" },
            { id: 2006, name: "å›½ç«‹æ–°ç¾è¡“é¤¨", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "museum", lat: 35.6652, lng: 139.7263, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "æ¸¯åŒº", url: "https://www.nact.jp/" },
            { id: 2007, name: "ã‚ˆã¿ã†ã‚Šãƒ©ãƒ³ãƒ‰", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "theme_park", lat: 35.6253, lng: 139.5173, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ç¨²åŸå¸‚", url: "https://www.yomiuriland.com/" },
            { id: 2008, name: "ã‚µãƒ³ãƒªã‚ªãƒ”ãƒ¥ãƒ¼ãƒ­ãƒ©ãƒ³ãƒ‰", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "theme_park", lat: 35.6247, lng: 139.4293, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "å¤šæ‘©å¸‚", url: "https://www.puroland.jp/" },
            { id: 2009, name: "æ±äº¬ãƒ‰ãƒ¼ãƒ ã‚·ãƒ†ã‚£", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "theme_park", lat: 35.7056, lng: 139.7519, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "æ–‡äº¬åŒº", url: "https://www.tokyo-dome.co.jp/" },
            { id: 2010, name: "æ¨ªæµœãƒ»å…«æ™¯å³¶ã‚·ãƒ¼ãƒ‘ãƒ©ãƒ€ã‚¤ã‚¹", region: "é–¢æ±", pref: "ç¥å¥ˆå·çœŒ", category: "theme_park", lat: 35.3367, lng: 139.6469, tags: ["physical", "mental"], discount: "åŠé¡", address: "æ¨ªæµœå¸‚", url: "http://www.seaparadise.co.jp/" },
            { id: 2011, name: "æ–°æ±Ÿãƒå³¶æ°´æ—é¤¨", region: "é–¢æ±", pref: "ç¥å¥ˆå·çœŒ", category: "aquarium", lat: 35.3089, lng: 139.4819, tags: ["physical", "mental"], discount: "åŠé¡", address: "è—¤æ²¢å¸‚", url: "https://www.enosui.com/" },
            { id: 2012, name: "é´¨å·ã‚·ãƒ¼ãƒ¯ãƒ¼ãƒ«ãƒ‰", region: "é–¢æ±", pref: "åƒè‘‰çœŒ", category: "aquarium", lat: 35.1157, lng: 140.1189, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "é´¨å·å¸‚", url: "http://www.kamogawa-seaworld.jp/" },
            { id: 2013, name: "ãƒã‚¶ãƒ¼ç‰§å ´", region: "é–¢æ±", pref: "åƒè‘‰çœŒ", category: "theme_park", lat: 35.2639, lng: 139.9328, tags: ["physical", "mental"], discount: "åŠé¡", address: "å¯Œæ´¥å¸‚", url: "http://www.motherfarm.co.jp/" },
            { id: 2014, name: "ãƒ ãƒ¼ãƒŸãƒ³ãƒãƒ¬ãƒ¼ãƒ‘ãƒ¼ã‚¯", region: "é–¢æ±", pref: "åŸ¼ç‰çœŒ", category: "theme_park", lat: 35.8715, lng: 139.3276, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "é£¯èƒ½å¸‚", url: "https://metsa-hanno.com/" },
            { id: 2015, name: "æ±æ­¦å‹•ç‰©å…¬åœ’", region: "é–¢æ±", pref: "åŸ¼ç‰çœŒ", category: "zoo", lat: 36.0244, lng: 139.7136, tags: ["physical", "mental"], discount: "åŠé¡", address: "å®®ä»£ç”º", url: "http://www.tobuzoo.com/" },
            { id: 2016, name: "æ—¥å…‰æ±ç…§å®®", region: "é–¢æ±", pref: "æ ƒæœ¨çœŒ", category: "sightseeing", lat: 36.7581, lng: 139.5989, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "æ—¥å…‰å¸‚", url: "https://www.toshogu.jp/" },
            { id: 2017, name: "ã‚ã—ã‹ãŒãƒ•ãƒ©ãƒ¯ãƒ¼ãƒ‘ãƒ¼ã‚¯", region: "é–¢æ±", pref: "æ ƒæœ¨çœŒ", category: "park", lat: 36.3142, lng: 139.5202, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "è¶³åˆ©å¸‚", url: "https://www.ashikaga.co.jp/" },
            { id: 2018, name: "é‚£é ˆãƒã‚¤ãƒ©ãƒ³ãƒ‰ãƒ‘ãƒ¼ã‚¯", region: "é–¢æ±", pref: "æ ƒæœ¨çœŒ", category: "theme_park", lat: 37.0567, lng: 139.9678, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "é‚£é ˆç”º", url: "https://www.nasuhai.co.jp/" },
            { id: 2019, name: "ã‚¢ã‚¯ã‚¢ãƒ¯ãƒ¼ãƒ«ãƒ‰å¤§æ´—", region: "é–¢æ±", pref: "èŒ¨åŸçœŒ", category: "aquarium", lat: 36.3134, lng: 140.5898, tags: ["physical", "mental"], discount: "åŠé¡", address: "å¤§æ´—ç”º", url: "https://www.aquaworld-oarai.com/" },
            { id: 2020, name: "ç¾¤é¦¬ã‚µãƒ•ã‚¡ãƒªãƒ‘ãƒ¼ã‚¯", region: "é–¢æ±", pref: "ç¾¤é¦¬çœŒ", category: "zoo", lat: 36.2628, lng: 138.9100, tags: ["physical", "mental"], discount: "åŠé¡", address: "å¯Œå²¡å¸‚", url: "http://www.safari.co.jp/" },
            { id: 2021, name: "TOHOã‚·ãƒãƒã‚ºæ–°å®¿", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "cinema", lat: 35.6955, lng: 139.7020, tags: ["physical", "mental"], discount: "1000å††", address: "æ–°å®¿åŒº", url: "https://www.tohotheater.jp/" },
            { id: 2022, name: "æ¨ªæµœç¾è¡“é¤¨", region: "é–¢æ±", pref: "ç¥å¥ˆå·çœŒ", category: "museum", lat: 35.4570, lng: 139.6310, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "æ¨ªæµœå¸‚", url: "https://yokohama.art.museum/" },

            // === ä¸­éƒ¨ ===
            { id: 3001, name: "å¯Œå£«æ€¥ãƒã‚¤ãƒ©ãƒ³ãƒ‰", region: "ä¸­éƒ¨", pref: "å±±æ¢¨çœŒ", category: "theme_park", lat: 35.4869, lng: 138.7806, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "å¯Œå£«å‰ç”°å¸‚", url: "https://www.fujiq.jp/" },
            { id: 3002, name: "ã‚¸ãƒ–ãƒªãƒ‘ãƒ¼ã‚¯", region: "ä¸­éƒ¨", pref: "æ„›çŸ¥çœŒ", category: "theme_park", lat: 35.1709, lng: 137.0902, tags: ["physical", "mental"], discount: "å‰²å¼•ãƒã‚±ãƒƒãƒˆ", address: "é•·ä¹…æ‰‹å¸‚", url: "https://ghibli-park.jp/" },
            { id: 3003, name: "åå¤å±‹æ¸¯æ°´æ—é¤¨", region: "ä¸­éƒ¨", pref: "æ„›çŸ¥çœŒ", category: "aquarium", lat: 35.0906, lng: 136.8781, tags: ["physical", "mental"], discount: "å…¨é¡å…é™¤", address: "åå¤å±‹å¸‚", url: "https://nagoyaaqua.jp/" },
            { id: 3004, name: "ãƒŠã‚¬ã‚·ãƒã‚¹ãƒ‘ãƒ¼ãƒ©ãƒ³ãƒ‰", region: "ä¸­éƒ¨", pref: "ä¸‰é‡çœŒ", category: "theme_park", lat: 35.0305, lng: 136.7323, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "æ¡‘åå¸‚", url: "https://www.nagashima-onsen.co.jp/" },
            { id: 3005, name: "å¿—æ‘©ã‚¹ãƒšã‚¤ãƒ³æ‘", region: "ä¸­éƒ¨", pref: "ä¸‰é‡çœŒ", category: "theme_park", lat: 34.3631, lng: 136.8431, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "å¿—æ‘©å¸‚", url: "https://www.parque-net.com/" },
            { id: 3006, name: "é‡‘æ²¢21ä¸–ç´€ç¾è¡“é¤¨", region: "ä¸­éƒ¨", pref: "çŸ³å·çœŒ", category: "museum", lat: 36.5609, lng: 136.6582, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "é‡‘æ²¢å¸‚", url: "https://www.kanazawa21.jp/" },
            { id: 3007, name: "ç¦äº•çœŒç«‹æç«œåšç‰©é¤¨", region: "ä¸­éƒ¨", pref: "ç¦äº•çœŒ", category: "museum", lat: 36.0842, lng: 136.5083, tags: ["physical", "mental"], discount: "åŠé¡", address: "å‹å±±å¸‚", url: "https://www.dinosaur.pref.fukui.jp/" },
            { id: 3008, name: "æ¾æœ¬åŸ", region: "ä¸­éƒ¨", pref: "é•·é‡çœŒ", category: "sightseeing", lat: 36.2387, lng: 137.9691, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "æ¾æœ¬å¸‚", url: "https://www.matsumoto-castle.jp/" },
            { id: 3009, name: "éˆ´é¹¿ã‚µãƒ¼ã‚­ãƒƒãƒˆ", region: "ä¸­éƒ¨", pref: "ä¸‰é‡çœŒ", category: "theme_park", lat: 34.8431, lng: 136.5408, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "éˆ´é¹¿å¸‚", url: "https://www.suzukacircuit.jp/" },

            // === é–¢è¥¿ ===
            { id: 4001, name: "ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ»ã‚¹ã‚¿ã‚¸ã‚ªãƒ»ã‚¸ãƒ£ãƒ‘ãƒ³", region: "é–¢è¥¿", pref: "å¤§é˜ªåºœ", category: "theme_park", lat: 34.6654, lng: 135.4323, tags: ["physical", "mental"], discount: "å‰²å¼•ãƒ‘ã‚¹", address: "å¤§é˜ªå¸‚", url: "https://www.usj.co.jp/" },
            { id: 4002, name: "ã²ã‚‰ã‹ãŸãƒ‘ãƒ¼ã‚¯", region: "é–¢è¥¿", pref: "å¤§é˜ªåºœ", category: "theme_park", lat: 34.8080, lng: 135.6421, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "æšæ–¹å¸‚", url: "http://www.hirakatapark.co.jp/" },
            { id: 4003, name: "æµ·éŠé¤¨", region: "é–¢è¥¿", pref: "å¤§é˜ªåºœ", category: "aquarium", lat: 34.6545, lng: 135.4289, tags: ["physical", "mental"], discount: "åŠé¡", address: "å¤§é˜ªå¸‚", url: "https://www.kaiyukan.com/" },
            { id: 4004, name: "æ±æ˜ å¤ªç§¦æ˜ ç”»æ‘", region: "é–¢è¥¿", pref: "äº¬éƒ½åºœ", category: "theme_park", lat: 35.0163, lng: 135.7077, tags: ["physical", "mental"], discount: "åŠé¡", address: "äº¬éƒ½å¸‚", url: "https://www.toei-eigamura.com/" },
            { id: 4005, name: "äº¬éƒ½é‰„é“åšç‰©é¤¨", region: "é–¢è¥¿", pref: "äº¬éƒ½åºœ", category: "museum", lat: 34.9864, lng: 135.7418, tags: ["physical", "mental"], discount: "åŠé¡", address: "äº¬éƒ½å¸‚", url: "https://www.kyotorailwaymuseum.jp/" },
            { id: 4006, name: "å§«è·¯ã‚»ãƒ³ãƒˆãƒ©ãƒ«ãƒ‘ãƒ¼ã‚¯", region: "é–¢è¥¿", pref: "å…µåº«çœŒ", category: "theme_park", lat: 34.8703, lng: 134.7397, tags: ["physical", "mental"], discount: "åŠé¡", address: "å§«è·¯å¸‚", url: "https://www.central-park.co.jp/" },
            { id: 4007, name: "æ±æ¡æ¹–ãŠã‚‚ã¡ã‚ƒç‹å›½", region: "é–¢è¥¿", pref: "å…µåº«çœŒ", category: "theme_park", lat: 34.9250, lng: 135.0658, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "åŠ æ±å¸‚", url: "https://www.omochaoukoku.com/tojoko/" },
            { id: 4008, name: "ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ¯ãƒ¼ãƒ«ãƒ‰", region: "é–¢è¥¿", pref: "å’Œæ­Œå±±çœŒ", category: "zoo", lat: 33.6702, lng: 135.3759, tags: ["physical", "mental"], discount: "åŠé¡", address: "ç™½æµœç”º", url: "https://www.aws-s.com/" },
            { id: 4009, name: "ãƒãƒ«ãƒˆãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘", region: "é–¢è¥¿", pref: "å’Œæ­Œå±±çœŒ", category: "theme_park", lat: 34.1528, lng: 135.1764, tags: ["physical", "mental"], discount: "å…¥åœ’ç„¡æ–™", address: "å’Œæ­Œå±±å¸‚", url: "https://www.marinacity.com/porto/" },

            // === ä¸­å›½ãƒ»å››å›½ ===
            { id: 5001, name: "é·²ç¾½å±±ãƒã‚¤ãƒ©ãƒ³ãƒ‰", region: "ä¸­å›½", pref: "å²¡å±±çœŒ", category: "theme_park", lat: 34.4358, lng: 133.8378, tags: ["physical", "mental"], discount: "åŠé¡", address: "å€‰æ•·å¸‚", url: "http://www.w-highland.co.jp/" },
            { id: 5002, name: "ãŠã‚‚ã¡ã‚ƒç‹å›½", region: "ä¸­å›½", pref: "å²¡å±±çœŒ", category: "theme_park", lat: 34.4533, lng: 133.9214, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ç‰é‡å¸‚", url: "https://www.omochaoukoku.co.jp/" },
            { id: 5003, name: "ã¿ã‚ãã®é‡Œ", region: "ä¸­å›½", pref: "åºƒå³¶çœŒ", category: "theme_park", lat: 34.3739, lng: 133.3639, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ç¦å±±å¸‚", url: "https://www.mirokunosato.com/" },
            { id: 5004, name: "åºƒå³¶å¹³å’Œè¨˜å¿µè³‡æ–™é¤¨", region: "ä¸­å›½", pref: "åºƒå³¶çœŒ", category: "museum", lat: 34.3916, lng: 132.4526, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "åºƒå³¶å¸‚", url: "http://hpmmuseum.jp/" },
            { id: 5005, name: "NEWãƒ¬ã‚ªãƒãƒ¯ãƒ¼ãƒ«ãƒ‰", region: "å››å›½", pref: "é¦™å·çœŒ", category: "theme_park", lat: 34.1950, lng: 133.8569, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ä¸¸äº€å¸‚", url: "https://www.newreomaworld.com/" },
            { id: 5006, name: "å¤§å¡šå›½éš›ç¾è¡“é¤¨", region: "å››å›½", pref: "å¾³å³¶çœŒ", category: "museum", lat: 34.2319, lng: 134.6372, tags: ["physical", "mental"], discount: "åŠé¡", address: "é³´é–€å¸‚", url: "https://o-museum.or.jp/" },

            // === ä¹å·ãƒ»æ²–ç¸„ ===
            { id: 6001, name: "ãƒã‚¦ã‚¹ãƒ†ãƒ³ãƒœã‚¹", region: "ä¹å·", pref: "é•·å´çœŒ", category: "theme_park", lat: 33.0883, lng: 129.7872, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "ä½ä¸–ä¿å¸‚", url: "https://www.huistenbosch.co.jp/" },
            { id: 6002, name: "ã‚°ãƒªãƒ¼ãƒ³ãƒ©ãƒ³ãƒ‰", region: "ä¹å·", pref: "ç†Šæœ¬çœŒ", category: "theme_park", lat: 32.9922, lng: 130.4611, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "è’å°¾å¸‚", url: "http://www.greenland.co.jp/park/" },
            { id: 6003, name: "åŸå³¶é«˜åŸãƒ‘ãƒ¼ã‚¯", region: "ä¹å·", pref: "å¤§åˆ†çœŒ", category: "theme_park", lat: 33.2625, lng: 131.4239, tags: ["physical", "mental"], discount: "åŠé¡", address: "åˆ¥åºœå¸‚", url: "https://www.kijimakogen-park.jp/" },
            { id: 6004, name: "ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰", region: "ä¹å·", pref: "å¤§åˆ†çœŒ", category: "theme_park", lat: 33.4072, lng: 131.5458, tags: ["physical", "mental"], discount: "å‰²å¼•ã‚ã‚Š", address: "æ—¥å‡ºç”º", url: "https://www.harmonyland.jp/" },
            { id: 6005, name: "ãƒãƒªãƒ³ãƒ¯ãƒ¼ãƒ«ãƒ‰æµ·ã®ä¸­é“", region: "ä¹å·", pref: "ç¦å²¡çœŒ", category: "aquarium", lat: 33.6606, lng: 130.3668, tags: ["physical", "mental"], discount: "åŠé¡", address: "ç¦å²¡å¸‚", url: "https://marine-world.jp/" },
            { id: 6006, name: "æ²–ç¸„ç¾ã‚‰æµ·æ°´æ—é¤¨", region: "æ²–ç¸„", pref: "æ²–ç¸„çœŒ", category: "aquarium", lat: 26.6943, lng: 127.8779, tags: ["physical", "mental"], discount: "ç„¡æ–™", address: "æœ¬éƒ¨ç”º", url: "https://churaumi.okinawa/" },
            { id: 6007, name: "ãŠããªã‚ãƒ¯ãƒ¼ãƒ«ãƒ‰", region: "æ²–ç¸„", pref: "æ²–ç¸„çœŒ", category: "theme_park", lat: 26.1397, lng: 127.7503, tags: ["physical", "mental"], discount: "åŠé¡", address: "å—åŸå¸‚", url: "https://www.gyokusendo.co.jp/okinawaworld/" }
        ];

        // --- ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ ---
        let map;
        let markers = {};
        let currentFilter = 'all';
        let currentListTab = 'fav';
        let userStatus = JSON.parse(localStorage.getItem('handimap_final_v3_status')) || {};
        let activeFacilityId = null;
        let visibleFacilities = [];
        let userLocationMarker = null;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                initMap();
                const center = map.getCenter();
                updateVisibleSpots(center.lat, center.lng);
                renderPrefList();
                renderMyList();
            } catch(e) {
                console.error("Init Error:", e);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
            }
        });

        function initMap() {
            // æ—¥æœ¬å…¨ä½“ã‚’è¡¨ç¤º
            map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([35.6895, 139.6917], 8);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap', maxZoom: 18
            }).addTo(map);
            
            // PCã§ã¯ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ  (å³ä¸‹ã«)
            if (window.innerWidth >= 768) {
                L.control.zoom({ position: 'bottomright' }).addTo(map);
            }

            map.on('moveend', () => {
                const center = map.getCenter();
                updateVisibleSpots(center.lat, center.lng);
            });

            const scroller = document.getElementById('card-scroller');
            let isScrolling;
            scroller.addEventListener('scroll', () => {
                window.clearTimeout(isScrolling);
                isScrolling = setTimeout(() => detectActiveCard(), 100);
            });

            // å…¨ä»¶ãƒãƒ¼ã‚«ãƒ¼é…ç½®
            renderAllMarkers();
        }

        function renderAllMarkers() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            
            facilities.forEach(spot => {
                if (currentFilter !== 'all' && spot.category !== currentFilter) return;

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div id="pin-${spot.id}" class="pin-marker">${getIcon(spot.category)}</div>`,
                    iconSize: [36, 36], iconAnchor: [18, 36]
                });
                const marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
                marker.on('click', () => {
                    map.flyTo([spot.lat, spot.lng], 14, { duration: 1.2 });
                    setActiveFacility(spot.id);
                });
                markers[spot.id] = marker;
            });
        }

        // 50kmä»¥å†…ã®æ–½è¨­ã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        function updateVisibleSpots(lat, lng) {
            const indicator = document.getElementById('search-indicator');
            indicator.classList.add('show');

            const sorted = facilities.map(f => {
                const dist = getDistance(lat, lng, f.lat, f.lng);
                return { ...f, dist };
            }).sort((a, b) => a.dist - b.dist);

            let filtered = sorted;
            if (currentFilter !== 'all') {
                filtered = sorted.filter(f => f.category === currentFilter);
            }
            
            // è¿‘ãã®20ä»¶
            visibleFacilities = filtered.filter(f => f.dist < 50).slice(0, 20);

            renderCards();
            setTimeout(() => indicator.classList.remove('show'), 500);
        }

        function renderCards() {
            const scroller = document.getElementById('card-scroller');
            scroller.innerHTML = '';
            if (visibleFacilities.length === 0) return;

            visibleFacilities.forEach(spot => {
                const card = document.createElement('div');
                card.id = `card-${spot.id}`;
                card.className = 'map-card';
                card.onclick = () => setActiveFacility(spot.id);
                renderCardContent(card, spot);
                scroller.appendChild(card);
            });
            
            // ä½™ç™½
            const spacer = document.createElement('div');
            spacer.style.flex = "0 0 10px";
            scroller.appendChild(spacer);
        }

        function renderCardContent(el, spot) {
            const status = userStatus[spot.id] || {};
            const distDisplay = spot.dist < 1 ? `${Math.round(spot.dist * 1000)}m` : `${spot.dist.toFixed(1)}km`;
            
            el.innerHTML = `
                <div class="flex justify-between items-start mb-1 h-full">
                    <div class="flex-1 flex flex-col h-full">
                        <div>
                            <h3 class="font-bold text-base text-blue-600 line-clamp-1">
                                <a href="${spot.url}" target="_blank" onclick="event.stopPropagation()" class="spot-link flex items-center gap-1">
                                    ${spot.name} <i class="fas fa-external-link-alt text-xs opacity-70"></i>
                                </a>
                            </h3>
                            <p class="text-xs text-slate-500 mt-0.5"><i class="fas fa-map-marker-alt"></i> ${spot.address} <span class="ml-1 text-blue-500">(${distDisplay}å…ˆ)</span></p>
                        </div>
                        
                        <div class="flex gap-2 my-2">
                             <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">ğŸ’° ${spot.discount}</span>
                        </div>

                        <div class="mt-auto flex gap-2 w-full">
                            <a href="https://www.google.com/maps/search/?api=1&query=${spot.name}" target="_blank" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded flex items-center justify-center gap-1 shadow active:scale-95 transition-transform" onclick="event.stopPropagation()">
                                <i class="fas fa-location-arrow"></i> ãƒãƒƒãƒ—
                            </a>
                            <button onclick="event.stopPropagation(); toggleStatus(${spot.id}, 'fav')" class="w-10 h-8 rounded flex items-center justify-center border ${status.fav ? 'border-pink-200 bg-pink-50 text-pink-500' : 'border-slate-100 bg-slate-50 text-slate-400'}">
                                <i class="${status.fav ? 'fas' : 'far'} fa-heart text-base"></i>
                            </button>
                            <button onclick="event.stopPropagation(); toggleStatus(${spot.id}, 'visited')" class="w-10 h-8 rounded flex items-center justify-center border ${status.visited ? 'border-green-200 bg-green-50 text-green-500' : 'border-slate-100 bg-slate-50 text-slate-400'}">
                                <i class="fas fa-check text-base"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-2xl ml-2">${getIcon(spot.category)}</div>
                </div>
            `;
        }

        function setActiveFacility(id) {
            if (activeFacilityId === id) return;
            activeFacilityId = id;
            document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
            const pin = document.getElementById(`pin-${id}`);
            if(pin) pin.classList.add('active-pin');

            const spot = facilities.find(f => f.id === id);
            if(spot) {
                // PCã¨ã‚¹ãƒãƒ›ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆä½ç½®ã‚’å¾®èª¿æ•´
                const isDesktop = window.innerWidth >= 768;
                const offset = isDesktop ? 0 : map.getSize().y * 0.15;
                const targetPoint = map.project([spot.lat, spot.lng], map.getZoom()).subtract([0, -offset]);
                map.flyTo(map.unproject(targetPoint, map.getZoom()), 14, { duration: 0.8 });
            }

            setTimeout(() => {
                const card = document.getElementById(`card-${id}`);
                if(card) {
                    card.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    document.querySelectorAll('.map-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                }
            }, 150);
        }

        function detectActiveCard() {
            const scroller = document.getElementById('card-scroller');
            const center = scroller.scrollLeft + (scroller.offsetWidth / 2);
            let closestId = null, minDiff = Infinity;
            scroller.querySelectorAll('.map-card').forEach(card => {
                const diff = Math.abs(center - (card.offsetLeft + (card.offsetWidth / 2)));
                if(diff < minDiff) { minDiff = diff; closestId = parseInt(card.id.replace('card-', '')); }
            });
            if(closestId && closestId !== activeFacilityId) setActiveFacility(closestId);
        }

        // --- GPS ---
        window.locateUser = function() {
            const btn = document.getElementById('gps-btn');
            const icon = btn.querySelector('i');
            icon.className = "fas fa-spinner fa-spin";
            document.getElementById('search-indicator').innerHTML = 'ğŸ“¡ ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...';
            document.getElementById('search-indicator').classList.add('show');

            if(!navigator.geolocation) { showRegionSelectModal(); icon.className = "fas fa-crosshairs"; return; }

            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                if(userLocationMarker) map.removeLayer(userLocationMarker);
                const pulseIcon = L.divIcon({ className: 'custom-div-icon', html: '<div class="current-location-marker" style="width:20px;height:20px;background:#2563EB;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(37,99,235,0.5);"></div>', iconSize: [20, 20], iconAnchor: [10, 10] });
                userLocationMarker = L.marker([lat, lng], {icon: pulseIcon}).addTo(map);
                map.flyTo([lat, lng], 14, { duration: 1.5 });
                updateVisibleSpots(lat, lng);
                document.getElementById('search-indicator').innerHTML = '<i class="fas fa-map-marked-alt text-blue-500"></i> ç¾åœ¨åœ°å‘¨è¾ºã‚’è¡¨ç¤ºä¸­';
                icon.className = "fas fa-crosshairs";
            }, (err) => { showRegionSelectModal(); icon.className = "fas fa-crosshairs"; }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
        };

        function showRegionSelectModal() { document.getElementById('region-modal').classList.add('show'); document.getElementById('search-indicator').classList.remove('show'); }
        window.closeModal = function() { document.getElementById('region-modal').classList.remove('show'); }
        window.manualLocate = function(lat, lng) {
            closeModal();
            map.flyTo([lat, lng], 12, { duration: 1.5 });
            updateVisibleSpots(lat, lng);
            if(userLocationMarker) map.removeLayer(userLocationMarker);
            const pulseIcon = L.divIcon({ className: 'custom-div-icon', html: '<div class="current-location-marker" style="background-color:#64748b; box-shadow:0 0 0 4px rgba(100,116,139,0.3);width:20px;height:20px;border-radius:50%;"></div>', iconSize: [20, 20], iconAnchor: [10, 10] });
            userLocationMarker = L.marker([lat, lng], {icon: pulseIcon}).addTo(map);
            document.getElementById('search-indicator').innerHTML = '<i class="fas fa-map-pin text-gray-500"></i> æŒ‡å®šã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºä¸­';
            document.getElementById('search-indicator').classList.add('show');
        }

        // --- éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ ---
        function renderPrefList() {
            const container = document.getElementById('pref-list-container');
            container.innerHTML = '';
            
            const grouped = {};
            facilities.forEach(f => {
                if(!grouped[f.region]) grouped[f.region] = {};
                if(!grouped[f.region][f.pref]) grouped[f.region][f.pref] = [];
                grouped[f.region][f.pref].push(f);
            });
            document.getElementById('total-count').innerText = `å…¨ ${facilities.length} ä»¶ã®æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

            const regions = ["åŒ—æµ·é“", "æ±åŒ—", "é–¢æ±", "ä¸­éƒ¨", "é–¢è¥¿", "ä¸­å›½", "å››å›½", "ä¹å·", "æ²–ç¸„"];
            regions.forEach(region => {
                if (!grouped[region]) return;
                const h = document.createElement('div');
                h.className = "px-4 py-3 bg-slate-100 border-b border-slate-200 font-bold text-slate-600 flex justify-between items-center cursor-pointer hover:bg-slate-200 transition-colors rounded-t-lg mt-4 first:mt-0";
                h.innerHTML = `<span>${region}</span><i class="fas fa-chevron-right text-slate-400 text-sm transition-transform"></i>`;
                const regionContent = document.createElement('div');
                regionContent.className = "hidden";
                h.onclick = () => {
                    const isHidden = regionContent.classList.contains('hidden');
                    const icon = h.querySelector('.fa-chevron-right');
                    if (isHidden) { regionContent.classList.remove('hidden'); icon.style.transform = 'rotate(90deg)'; } 
                    else { regionContent.classList.add('hidden'); icon.style.transform = 'rotate(0deg)'; }
                };
                Object.keys(grouped[region]).forEach(pref => {
                    const prefSpots = grouped[region][pref];
                    const prefWrapper = document.createElement('div');
                    prefWrapper.className = "bg-white border-b border-slate-100 pl-4";
                    const prefHeader = document.createElement('div');
                    prefHeader.className = "px-4 py-3 flex justify-between items-center cursor-pointer active:bg-slate-50";
                    prefHeader.innerHTML = `<span class="font-bold text-slate-800">${pref} <span class="text-slate-400 text-xs font-normal ml-1">(${prefSpots.length}ä»¶)</span></span><i class="fas fa-chevron-down text-slate-300 transition-transform duration-300 transform"></i>`;
                    const spotList = document.createElement('div');
                    spotList.className = "hidden bg-slate-50/50 pb-2 border-t border-slate-100 grid-container"; // ã‚°ãƒªãƒƒãƒ‰å¯¾å¿œã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    prefHeader.onclick = () => {
                        const isHidden = spotList.classList.contains('hidden');
                        const icon = prefHeader.querySelector('.fa-chevron-down');
                        if (isHidden) { spotList.classList.remove('hidden'); icon.style.transform = 'rotate(180deg)'; prefHeader.classList.add('bg-slate-50'); } 
                        else { spotList.classList.add('hidden'); icon.style.transform = 'rotate(0deg)'; prefHeader.classList.remove('bg-slate-50'); }
                    };
                    prefSpots.forEach(spot => {
                        const div = document.createElement('div');
                        div.className = "list-item !mx-4 !my-2 shadow-sm md:!mx-0"; // PCæ™‚ã¯ãƒãƒ¼ã‚¸ãƒ³ãƒªã‚»ãƒƒãƒˆ
                        // ã‚«ãƒ¼ãƒ‰ã®ä¸­èº«ã‚’å†åˆ©ç”¨ã—ã¦ãƒªã‚¹ãƒˆç”¨ã«å¾®èª¿æ•´
                        const status = userStatus[spot.id] || {};
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-1 h-20">
                                <div class="flex-1">
                                    <h3 class="font-bold text-base text-slate-800 line-clamp-2"><a href="${spot.url}" target="_blank" class="spot-link">${spot.name}</a></h3>
                                    <p class="text-xs text-slate-500 mt-1 line-clamp-1"><i class="fas fa-map-marker-alt"></i> ${spot.address}</p>
                                </div>
                                <div class="text-xl ml-2">${getIcon(spot.category)}</div>
                            </div>
                            <div class="flex gap-2 my-2"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">ğŸ’° ${spot.discount}</span></div>
                            <div class="flex gap-2 mt-auto">
                                <a href="https://www.google.com/maps/search/?api=1&query=${spot.name}" target="_blank" class="flex-1 bg-slate-100 text-slate-600 text-xs font-bold py-2 rounded text-center hover:bg-slate-200 transition-colors"><i class="fas fa-location-arrow"></i> ãƒãƒƒãƒ—</a>
                                <button onclick="toggleStatus(${spot.id}, 'fav')" class="flex-1 border text-xs py-2 rounded transition-colors ${status.fav ? 'text-pink-500 bg-pink-50 border-pink-200' : 'text-slate-400 hover:bg-slate-50'}">ä¿å­˜</button>
                            </div>
                        `;
                        spotList.appendChild(div);
                    });
                    prefWrapper.appendChild(prefHeader);
                    prefWrapper.appendChild(spotList);
                    regionContent.appendChild(prefWrapper);
                });
                container.appendChild(h);
                container.appendChild(regionContent);
            });
        }

        function renderMyList() {
            const container = document.getElementById('mylist-container');
            container.innerHTML = '';
            const allFavs = facilities.filter(f => userStatus[f.id]?.fav);
            const allVisited = facilities.filter(f => userStatus[f.id]?.visited);
            document.getElementById('count-fav').innerText = `(${allFavs.length})`;
            document.getElementById('count-visited').innerText = `(${allVisited.length})`;
            const list = currentListTab === 'fav' ? allFavs : allVisited;
            
            if(list.length === 0) { container.innerHTML = `<div class="text-center text-slate-400 mt-10 text-sm col-span-full">ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</div>`; return; }
            
            list.forEach(spot => {
                const div = document.createElement('div'); div.className = "list-item";
                const status = userStatus[spot.id] || {};
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1 h-20">
                        <div class="flex-1"><h3 class="font-bold text-base text-slate-800 line-clamp-2"><a href="${spot.url}" target="_blank" class="spot-link">${spot.name}</a></h3></div>
                        <div class="text-xl ml-2">${getIcon(spot.category)}</div>
                    </div>
                    <div class="flex gap-2 my-2"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">ğŸ’° ${spot.discount}</span></div>
                    <div class="flex gap-2 mt-auto">
                        <a href="https://www.google.com/maps/search/?api=1&query=${spot.name}" target="_blank" class="flex-1 bg-slate-100 text-slate-600 text-xs font-bold py-2 rounded text-center hover:bg-slate-200 transition-colors">Googleãƒãƒƒãƒ—</a>
                         <button onclick="toggleStatus(${spot.id}, 'visited')" class="flex-1 border text-xs py-2 rounded transition-colors ${status.visited ? 'text-green-500 bg-green-50 border-green-200' : 'text-slate-400 hover:bg-slate-50'}">è¨ªå•æ¸ˆ</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.setFilter = function(type) {
            currentFilter = type;
            ['all', 'cinema', 'theme_park', 'aquarium', 'zoo', 'museum'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if (btn) btn.className = `px-3 py-1.5 rounded-full text-xs font-bold transition-colors whitespace-nowrap ${t===type ? 'bg-blue-600 text-white' : 'text-gray-500 hover:bg-gray-100'}`;
            });
            renderAllMarkers();
            const center = map.getCenter();
            updateVisibleSpots(center.lat, center.lng);
        };

        window.toggleStatus = function(id, type) {
            if(!userStatus[id]) userStatus[id] = {};
            userStatus[id][type] = !userStatus[id][type];
            localStorage.setItem('handimap_final_v3_status', JSON.stringify(userStatus));
            renderPrefList(); renderMyList();
            const center = map.getCenter();
            updateVisibleSpots(center.lat, center.lng);
        };

        window.switchListTab = function(tab) {
            currentListTab = tab;
            document.getElementById('tab-fav').className = `px-4 py-1.5 text-xs font-bold rounded shadow-sm transition-all ${tab==='fav' ? 'bg-white text-blue-600' : 'text-slate-400 hover:text-slate-600'}`;
            document.getElementById('tab-visited').className = `px-4 py-1.5 text-xs font-bold rounded shadow-sm transition-all ${tab==='visited' ? 'bg-white text-green-600' : 'text-slate-400 hover:text-slate-600'}`;
            renderMyList();
        };

        window.switchPage = function(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            if(pageId === 'map') setTimeout(() => map.invalidateSize(), 100);
        };

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getIcon(cat) {
            const icons = { theme_park:'ğŸ¡', zoo:'ğŸ˜', aquarium:'ğŸ¬', cinema:'ğŸ¬', museum:'ğŸ›ï¸', sightseeing:'ğŸ—¼', park:'ğŸŒ³' };
            return icons[cat] || 'ğŸ“';
        }
    </script>
</body>
</html>
