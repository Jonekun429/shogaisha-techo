<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HandiMap Travel</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Poppins"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#64748B',
                        accent: '#F43F5E',
                    },
                    boxShadow: {
                        'float': '0 10px 40px -10px rgba(0,0,0,0.15)',
                        'card': '0 4px 20px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            touch-action: manipulation; 
            overflow: hidden; 
            background-color: #F8FAFC;
            -webkit-font-smoothing: antialiased;
        }

        /* --- UI Layout --- */
        #app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; position: relative; }
        @media (min-width: 768px) { #app-container { flex-direction: row; } }

        .page { display: none; flex: 1; height: 100%; width: 100%; flex-direction: column; position: relative; padding-bottom: 90px; opacity: 0; transition: opacity 0.3s ease; }
        .page.active { display: flex; opacity: 1; }
        @media (min-width: 768px) { .page { padding-bottom: 0; } }

        /* --- Map Styling --- */
        #map { flex: 1; width: 100%; z-index: 0; background: #e5e7eb; }

        /* Custom Markers */
        .pin-marker {
            background-color: white; border-radius: 50%; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            width: 44px; height: 44px; position: relative;
        }
        .pin-marker::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid white;
        }
        .pin-marker.active-pin {
            background-color: #3B82F6; color: white; border-color: #3B82F6; 
            transform: scale(1.2) translateY(-10px); z-index: 3000 !important;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.5);
        }
        .pin-marker.active-pin::after { border-top-color: #3B82F6; }

        /* Floating Controls (Map) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
        }

        .category-filter {
            display: flex; gap: 8px; overflow-x: auto; padding: 4px;
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .category-filter::-webkit-scrollbar { display: none; }
        
        .filter-btn {
            padding: 8px 16px; border-radius: 100px; font-size: 13px; font-weight: 600; white-space: nowrap;
            transition: all 0.2s; background: white; color: #64748B; border: 1px solid #E2E8F0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .filter-btn.active {
            background: #3B82F6; color: white; border-color: #3B82F6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transform: translateY(-1px);
        }

        /* Cards */
        .card-scroller {
            position: absolute; bottom: 100px; left: 0; right: 0;
            display: flex; gap: 16px; padding: 0 20px;
            overflow-x: auto; scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; z-index: 1000;
            padding-bottom: 20px; scrollbar-width: none;
        }
        @media (min-width: 768px) {
            .card-scroller { bottom: 30px; justify-content: center; }
        }
        .card-scroller::-webkit-scrollbar { display: none; }

        .map-card {
            flex: 0 0 88%; max-width: 360px;
            background: white; border-radius: 24px; padding: 20px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
            scroll-snap-align: center;
            transition: transform 0.3s, border 0.3s;
            border: 2px solid transparent;
            position: relative; display: flex; flex-direction: column;
        }
        .map-card.active { border-color: #3B82F6; transform: translateY(-4px); }

        /* Navigation Bar (Floating Island style for Mobile) */
        .nav-container { z-index: 3000; }
        @media (max-width: 767px) {
            .nav-container {
                position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
                width: 90%; max-width: 380px; height: 64px;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                border-radius: 32px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5);
                display: flex; justify-content: space-evenly; align-items: center;
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #94A3B8; font-size: 10px; width: 60px; height: 100%;
                gap: 4px; transition: all 0.2s; position: relative;
            }
            .nav-item i { font-size: 20px; transition: transform 0.2s; }
            .nav-item.active { color: #3B82F6; }
            .nav-item.active i { transform: translateY(-2px); }
            .nav-item.active::after {
                content: ''; position: absolute; bottom: 8px; width: 4px; height: 4px;
                background: #3B82F6; border-radius: 50%;
            }
        }
        @media (min-width: 768px) {
            .nav-container {
                position: relative; width: 260px; height: 100%;
                background: white; border-right: 1px solid #F1F5F9;
                display: flex; flex-direction: column; padding-top: 40px;
            }
            .nav-item {
                display: flex; align-items: center; gap: 16px;
                padding: 16px 32px; font-size: 15px; color: #64748B; font-weight: 500;
                cursor: pointer; transition: all 0.2s;
            }
            .nav-item:hover { background: #F8FAFC; color: #3B82F6; }
            .nav-item.active { background: #EFF6FF; color: #3B82F6; border-right: 3px solid #3B82F6; }
            .nav-item i { font-size: 18px; width: 24px; text-align: center; }
        }

        /* List & Grid */
        .list-header { 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 20px 24px; border-bottom: 1px solid #F1F5F9; position: sticky; top: 0; z-index: 20; 
        }
        
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 20px; }
        @media (min-width: 768px) {
            .grid-container { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); padding: 32px; gap: 24px; }
        }

        .list-card {
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #F1F5F9;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .list-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.06); }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; inset: 0; z-index: 9999;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-box {
            background: white; width: 85%; max-width: 360px; border-radius: 24px;
            padding: 28px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }

        /* Utilities */
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #2563EB); color: white;
            font-weight: 600; padding: 10px 20px; border-radius: 14px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.96); }
        .btn-secondary {
            background: #F1F5F9; color: #64748B;
            font-weight: 600; padding: 10px 20px; border-radius: 14px;
            transition: all 0.2s;
        }
        .btn-secondary:active { transform: scale(0.96); background: #E2E8F0; }

        .tag { font-size: 11px; padding: 4px 10px; border-radius: 8px; font-weight: 600; }
        .tag-discount { background: #ECFDF5; color: #059669; }
    </style>
</head>
<body class="text-slate-700">

    <div id="app-container">
        <nav class="nav-container order-2 md:order-1">
            <div class="hidden md:block px-8 mb-6">
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight flex items-center">
                    <span class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white mr-3 text-sm"><i class="fas fa-map"></i></span>
                    HandiMap
                </h1>
                <p class="text-xs text-slate-400 mt-1 pl-11 font-medium">Accessible Travel</p>
            </div>

            <div class="nav-item active" onclick="switchPage('map')" id="nav-map">
                <i class="fas fa-compass"></i><span>ãƒãƒƒãƒ—</span>
            </div>
            <div class="nav-item" onclick="switchPage('list')" id="nav-list">
                <i class="fas fa-list-ul"></i><span>ã‚¨ãƒªã‚¢ä¸€è¦§</span>
            </div>
            <div class="nav-item" onclick="switchPage('mylist')" id="nav-mylist">
                <i class="fas fa-heart"></i><span>ãƒã‚¤ãƒªã‚¹ãƒˆ</span>
            </div>
            
            <div class="mt-auto p-6 hidden md:block">
                <button onclick="openMapSettings()" class="w-full py-3 px-4 rounded-xl bg-slate-50 text-slate-500 text-xs font-bold hover:bg-slate-100 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-cog"></i> ãƒãƒƒãƒ—è¨­å®š
                </button>
            </div>
        </nav>

        <main class="flex-1 relative h-full order-1 md:order-2 overflow-hidden bg-slate-50">
            
            <div id="page-map" class="page active">
                <div class="absolute top-5 left-4 right-4 z-[500] flex flex-col gap-3 pointer-events-none md:top-8 md:left-8 md:right-8 md:flex-row md:justify-between md:items-start">
                    
                    <div class="glass-panel rounded-full p-1 pointer-events-auto max-w-full overflow-hidden">
                        <div class="category-filter">
                            <button onclick="setFilter('all')" id="filter-all" class="filter-btn active">ã™ã¹ã¦</button>
                            <button onclick="setFilter('theme_park')" id="filter-theme_park" class="filter-btn">éŠåœ’åœ°</button>
                            <button onclick="setFilter('aquarium')" id="filter-aquarium" class="filter-btn">æ°´æ—é¤¨</button>
                            <button onclick="setFilter('zoo')" id="filter-zoo" class="filter-btn">å‹•ç‰©åœ’</button>
                            <button onclick="setFilter('museum')" id="filter-museum" class="filter-btn">ç¾è¡“é¤¨</button>
                        </div>
                    </div>

                    <div class="flex gap-3 pointer-events-auto self-end md:self-auto">
                         <button onclick="openMapSettings()" class="w-11 h-11 bg-white rounded-full shadow-float text-slate-400 flex items-center justify-center active:scale-90 transition-transform md:hidden">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button onclick="locateUser()" id="gps-btn" class="w-11 h-11 bg-white rounded-full shadow-float text-blue-500 flex items-center justify-center active:scale-90 transition-transform">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>
                </div>

                <div id="toast" class="absolute top-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-5 py-2.5 rounded-full text-xs font-bold shadow-xl z-[500] opacity-0 transition-opacity pointer-events-none backdrop-blur-sm">
                    <i class="fas fa-info-circle mr-2"></i> <span id="toast-msg">Notification</span>
                </div>

                <div id="map"></div>
                <div id="card-scroller" class="card-scroller"></div>
            </div>

            <div id="page-list" class="page overflow-y-auto">
                <div class="list-header">
                    <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-search-location text-blue-500"></i> ã‚¨ãƒªã‚¢ã‹ã‚‰æ¢ã™
                    </h1>
                    <p id="total-count" class="text-xs font-bold text-slate-400 mt-1 pl-1">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div id="pref-list-container" class="pb-24 md:pb-8"></div>
            </div>

            <div id="page-mylist" class="page overflow-y-auto">
                <div class="list-header flex justify-between items-center">
                    <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-bookmark text-pink-500"></i> ãƒã‚¤ãƒªã‚¹ãƒˆ
                    </h1>
                    <div class="flex bg-slate-100 rounded-lg p-1 gap-1">
                        <button onclick="switchListTab('fav')" id="tab-fav" class="px-4 py-1.5 text-xs font-bold rounded-md bg-white text-blue-600 shadow-sm transition-all">è¡ŒããŸã„</button>
                        <button onclick="switchListTab('visited')" id="tab-visited" class="px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 transition-all">è¡Œã£ãŸ</button>
                    </div>
                </div>
                <div id="mylist-container" class="grid-container pb-24 md:pb-8"></div>
            </div>

        </main>
    </div>

    <div id="region-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500 text-xl">
                <i class="fas fa-map-marked-alt"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 text-slate-800">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</h3>
            <p class="text-xs text-slate-500 mb-6 leading-relaxed">ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã—ãŸã„ã‚¨ãƒªã‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="manualLocate(35.6812, 139.7671)" class="py-3 bg-slate-50 rounded-xl text-xs font-bold hover:bg-blue-50 hover:text-blue-600 text-slate-600 transition-colors">é–¢æ±</button>
                <button onclick="manualLocate(34.7024, 135.4959)" class="py-3 bg-slate-50 rounded-xl text-xs font-bold hover:bg-blue-50 hover:text-blue-600 text-slate-600 transition-colors">é–¢è¥¿</button>
                <button onclick="manualLocate(43.0686, 141.3508)" class="py-3 bg-slate-50 rounded-xl text-xs font-bold hover:bg-blue-50 hover:text-blue-600 text-slate-600 transition-colors">åŒ—æµ·é“</button>
                <button onclick="manualLocate(33.5902, 130.4207)" class="py-3 bg-slate-50 rounded-xl text-xs font-bold hover:bg-blue-50 hover:text-blue-600 text-slate-600 transition-colors">ä¹å·</button>
            </div>
            <button onclick="closeModal('region-modal')" class="text-xs text-slate-400 font-bold hover:text-slate-600">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="map-select-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-500 text-xl">
                <i class="fas fa-route"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 text-slate-800">ãƒŠãƒ“ã‚¢ãƒ—ãƒªã®è¨­å®š</h3>
            <p class="text-xs text-slate-500 mb-6 leading-relaxed">ã€Œãƒãƒƒãƒ—ã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸéš›ã«<br>èµ·å‹•ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            
            <div class="flex flex-col gap-3 mb-4">
                <button onclick="setMapProvider('google')" class="flex items-center p-4 rounded-xl border border-slate-100 bg-white hover:border-blue-500 hover:bg-blue-50 transition-all group text-left">
                    <div class="w-10 h-10 bg-white shadow-sm border border-slate-100 rounded-full flex items-center justify-center text-xl mr-3 text-red-500">
                        <i class="fab fa-google"></i>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-slate-700 group-hover:text-blue-700">Googleãƒãƒƒãƒ—</div>
                        <div class="text-[10px] text-slate-400">æ¨å¥¨ãƒ»PC/ã‚¹ãƒãƒ›å…±é€š</div>
                    </div>
                </button>

                <button onclick="setMapProvider('default')" class="flex items-center p-4 rounded-xl border border-slate-100 bg-white hover:border-blue-500 hover:bg-blue-50 transition-all group text-left">
                    <div class="w-10 h-10 bg-white shadow-sm border border-slate-100 rounded-full flex items-center justify-center text-xl mr-3 text-slate-700">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-slate-700 group-hover:text-blue-700">OSæ¨™æº–ã‚¢ãƒ—ãƒª</div>
                        <div class="text-[10px] text-slate-400">iOSãƒãƒƒãƒ— / Androidæ¨™æº–</div>
                    </div>
                </button>
            </div>
            <p class="text-[10px] text-slate-300">â€»ã“ã®è¨­å®šã¯å¾Œã‹ã‚‰å¤‰æ›´ã§ãã¾ã™</p>
        </div>
    </div>

    <script>
        // --- æ–½è¨­ãƒ‡ãƒ¼ã‚¿ (ç°¡ç•¥åŒ–ã®ãŸã‚ä¸€éƒ¨ã®ã¿è¡¨ç¤ºãƒ»å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„) ---
        // ã“ã“ã«ä»¥å‰ã®å…¨ãƒ‡ãƒ¼ã‚¿(facilities)ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚å‹•ä½œç¢ºèªç”¨ã«æ•°ä»¶å®šç¾©ã—ã¾ã™ã€‚
        const facilities = [
            { id: 2001, name: "æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰", region: "é–¢æ±", pref: "åƒè‘‰çœŒ", category: "theme_park", lat: 35.6329, lng: 139.8804, discount: "ãƒã‚±ãƒƒãƒˆå‰²å¼•", address: "æµ¦å®‰å¸‚", url: "https://www.tokyodisneyresort.jp/" },
            { id: 2003, name: "ã‚µãƒ³ã‚·ãƒ£ã‚¤ãƒ³æ°´æ—é¤¨", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "aquarium", lat: 35.7289, lng: 139.7200, discount: "åŠé¡", address: "è±Šå³¶åŒº", url: "https://sunshinecity.jp/aquarium/" },
            { id: 2004, name: "æ©è³œä¸Šé‡å‹•ç‰©åœ’", region: "é–¢æ±", pref: "æ±äº¬éƒ½", category: "zoo", lat: 35.7165, lng: 139.7713, discount: "ç„¡æ–™", address: "å°æ±åŒº", url: "https://www.tokyo-zoo.net/zoo/ueno/" },
            { id: 4001, name: "ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ»ã‚¹ã‚¿ã‚¸ã‚ªãƒ»ã‚¸ãƒ£ãƒ‘ãƒ³", region: "é–¢è¥¿", pref: "å¤§é˜ªåºœ", category: "theme_park", lat: 34.6654, lng: 135.4323, discount: "å‰²å¼•ãƒ‘ã‚¹", address: "å¤§é˜ªå¸‚", url: "https://www.usj.co.jp/" },
            { id: 1001, name: "æ—­å±±å‹•ç‰©åœ’", region: "åŒ—æµ·é“", pref: "åŒ—æµ·é“", category: "zoo", lat: 43.7686, lng: 142.4808, discount: "å…¨é¡å…é™¤", address: "æ—­å·å¸‚", url: "https://www.city.asahikawa.hokkaido.jp/asahiyamazoo/" },
            { id: 6006, name: "æ²–ç¸„ç¾ã‚‰æµ·æ°´æ—é¤¨", region: "æ²–ç¸„", pref: "æ²–ç¸„çœŒ", category: "aquarium", lat: 26.6943, lng: 127.8779, discount: "ç„¡æ–™", address: "æœ¬éƒ¨ç”º", url: "https://churaumi.okinawa/" }
        ];
        
        // --- ã‚¢ãƒ—ãƒªçŠ¶æ…‹ç®¡ç† ---
        let map;
        let markers = {};
        let currentFilter = 'all';
        let currentListTab = 'fav';
        let userStatus = JSON.parse(localStorage.getItem('handimap_v4_status')) || {};
        let mapProvider = localStorage.getItem('handimap_v4_provider') || null; // 'google' or 'default'
        let activeFacilityId = null;
        let visibleFacilities = [];
        let userLocationMarker = null;

        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            renderPrefList();
            renderMyList();
            
            // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ç¾åœ¨åœ°å–å¾—ã‚’è©¦ã¿ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            // locateUser(); 
        });

        // --- ãƒãƒƒãƒ—æ©Ÿèƒ½ ---
        function initMap() {
            map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([35.6895, 139.6917], 8);
            
            // ã‚·ãƒ³ãƒ—ãƒ«ã§è¦‹ã‚„ã™ã„åœ°å›³ã‚¹ã‚¿ã‚¤ãƒ« (CartoDB Voyager)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19
            }).addTo(map);

            if (window.innerWidth >= 768) L.control.zoom({ position: 'bottomright' }).addTo(map);

            map.on('moveend', () => {
                const center = map.getCenter();
                updateVisibleSpots(center.lat, center.lng);
            });

            // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•
            const scroller = document.getElementById('card-scroller');
            let isScrolling;
            scroller.addEventListener('scroll', () => {
                window.clearTimeout(isScrolling);
                isScrolling = setTimeout(() => detectActiveCard(), 100);
            });

            renderAllMarkers();
            
            // åˆæœŸè¡¨ç¤º
            updateVisibleSpots(35.6895, 139.6917);
        }

        function renderAllMarkers() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            
            facilities.forEach(spot => {
                if (currentFilter !== 'all' && spot.category !== currentFilter) return;

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div id="pin-${spot.id}" class="pin-marker">${getIcon(spot.category)}</div>`,
                    iconSize: [44, 44], iconAnchor: [22, 50]
                });
                const marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
                marker.on('click', () => {
                    setActiveFacility(spot.id);
                });
                markers[spot.id] = marker;
            });
        }

        // --- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ ---
        function updateVisibleSpots(lat, lng) {
            // è·é›¢è¨ˆç®—ã¨ã‚½ãƒ¼ãƒˆ
            const sorted = facilities.map(f => {
                const dist = getDistance(lat, lng, f.lat, f.lng);
                return { ...f, dist };
            }).sort((a, b) => a.dist - b.dist);

            let filtered = sorted;
            if (currentFilter !== 'all') filtered = sorted.filter(f => f.category === currentFilter);
            
            visibleFacilities = filtered.slice(0, 15); // è¿‘ã„é †ã«15ä»¶
            renderCards();
            
            // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
            showToast(`<i class="fas fa-map-marked-alt"></i> å‘¨è¾º ${visibleFacilities.length}ä»¶ã‚’è¡¨ç¤ºä¸­`);
        }

        function renderCards() {
            const scroller = document.getElementById('card-scroller');
            scroller.innerHTML = '';
            
            if (visibleFacilities.length === 0) return;

            // ä½™ç™½
            const spacerStart = document.createElement('div');
            spacerStart.style.flex = "0 0 10px";
            scroller.appendChild(spacerStart);

            visibleFacilities.forEach(spot => {
                const card = document.createElement('div');
                card.id = `card-${spot.id}`;
                card.className = 'map-card';
                card.onclick = () => setActiveFacility(spot.id);
                
                const status = userStatus[spot.id] || {};
                const distDisplay = spot.dist < 1 ? `${Math.round(spot.dist * 1000)}m` : `${spot.dist.toFixed(1)}km`;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="tag tag-discount"><i class="fas fa-yen-sign"></i> ${spot.discount}</span>
                        <div class="text-2xl opacity-20 transform rotate-12">${getIcon(spot.category)}</div>
                    </div>
                    
                    <h3 class="font-bold text-lg text-slate-800 leading-tight mb-1 line-clamp-1">${spot.name}</h3>
                    <p class="text-xs text-slate-400 font-medium mb-4"><i class="fas fa-map-marker-alt mr-1"></i>${spot.address} <span class="text-blue-500 ml-1 font-bold">${distDisplay}å…ˆ</span></p>
                    
                    <div class="mt-auto flex gap-3">
                        <button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}')" class="btn-primary flex-1 text-xs flex items-center justify-center gap-2">
                            <i class="fas fa-location-arrow"></i> è¡Œã
                        </button>
                        <button onclick="event.stopPropagation(); toggleStatus(${spot.id}, 'fav')" class="w-10 h-10 rounded-xl flex items-center justify-center border transition-all ${status.fav ? 'border-pink-200 bg-pink-50 text-pink-500' : 'border-slate-100 bg-slate-50 text-slate-300'}">
                            <i class="${status.fav ? 'fas' : 'far'} fa-heart"></i>
                        </button>
                    </div>
                    <a href="${spot.url}" target="_blank" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500"><i class="fas fa-external-link-alt"></i></a>
                `;
                scroller.appendChild(card);
            });

            const spacerEnd = document.createElement('div');
            spacerEnd.style.flex = "0 0 10px";
            scroller.appendChild(spacerEnd);
        }

        function setActiveFacility(id) {
            if (activeFacilityId === id) return;
            activeFacilityId = id;
            
            // ãƒ”ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
            const pin = document.getElementById(`pin-${id}`);
            if(pin) pin.classList.add('active-pin');

            const spot = facilities.find(f => f.id === id);
            if(spot) {
                // ã‚¹ãƒãƒ›ã¨PCã§ä¸­å¿ƒä½ç½®ã‚’èª¿æ•´ï¼ˆã‚«ãƒ¼ãƒ‰è¢«ã‚Šã‚’é˜²ãï¼‰
                const isDesktop = window.innerWidth >= 768;
                const offset = isDesktop ? 0 : map.getSize().y * 0.2;
                const targetPoint = map.project([spot.lat, spot.lng], map.getZoom()).subtract([0, -offset]);
                map.flyTo(map.unproject(targetPoint, map.getZoom()), 14, { duration: 0.8, easeLinearity: 0.5 });
            }

            // ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                const card = document.getElementById(`card-${id}`);
                if(card) {
                    card.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    document.querySelectorAll('.map-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                }
            }, 100);
        }

        function detectActiveCard() {
            const scroller = document.getElementById('card-scroller');
            const center = scroller.scrollLeft + (scroller.offsetWidth / 2);
            let closestId = null, minDiff = Infinity;
            scroller.querySelectorAll('.map-card').forEach(card => {
                const diff = Math.abs(center - (card.offsetLeft + (card.offsetWidth / 2)));
                if(diff < minDiff) { minDiff = diff; closestId = parseInt(card.id.replace('card-', '')); }
            });
            if(closestId && closestId !== activeFacilityId) setActiveFacility(closestId);
        }

        // --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠãƒ­ã‚¸ãƒƒã‚¯ ---
        function handleNavClick(lat, lng, name) {
            event.stopPropagation();
            if (!mapProvider) {
                // æœªè¨­å®šãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆä¸€æ™‚ä¿å­˜ï¼‰
                window.tempNavTarget = { lat, lng, name };
                document.getElementById('map-select-modal').classList.add('show');
            } else {
                openMap(lat, lng, name);
            }
        }

        function setMapProvider(provider) {
            mapProvider = provider;
            localStorage.setItem('handimap_v4_provider', provider);
            document.getElementById('map-select-modal').classList.remove('show');
            
            // ä¿ç•™ã—ã¦ã„ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å®Ÿè¡Œ
            if (window.tempNavTarget) {
                const t = window.tempNavTarget;
                openMap(t.lat, t.lng, t.name);
                window.tempNavTarget = null;
            } else {
                showToast("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            }
        }

        function openMapSettings() {
            document.getElementById('map-select-modal').classList.add('show');
        }

        function openMap(lat, lng, name) {
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            let url = "";

            if (mapProvider === 'google') {
                // Google Maps (Web/Universal Link)
                url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${lat},${lng}`;
            } else {
                // Default (OS Standard)
                if (isIOS) {
                    // Apple Maps
                    url = `http://maps.apple.com/?q=${encodeURIComponent(name)}&ll=${lat},${lng}`;
                } else {
                    // Geo URI (Android intent) or fallback
                    url = `geo:${lat},${lng}?q=${encodeURIComponent(name)}`;
                }
            }
            window.open(url, '_blank');
        }

        // --- ãã®ä»–ã®æ©Ÿèƒ½ ---
        function renderPrefList() {
            const container = document.getElementById('pref-list-container');
            container.innerHTML = '';
            
            const grouped = {};
            facilities.forEach(f => {
                if(!grouped[f.region]) grouped[f.region] = {};
                if(!grouped[f.region][f.pref]) grouped[f.region][f.pref] = [];
                grouped[f.region][f.pref].push(f);
            });
            document.getElementById('total-count').innerText = `${facilities.length} æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

            const regions = ["åŒ—æµ·é“", "æ±åŒ—", "é–¢æ±", "ä¸­éƒ¨", "é–¢è¥¿", "ä¸­å›½", "å››å›½", "ä¹å·", "æ²–ç¸„"];
            regions.forEach(region => {
                if (!grouped[region]) return;
                
                const section = document.createElement('div');
                section.className = "mb-4 px-4 md:px-0";
                section.innerHTML = `<h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 ml-2">${region}</h2>`;
                
                Object.keys(grouped[region]).forEach(pref => {
                    const prefDetails = document.createElement('details');
                    prefDetails.className = "group bg-white rounded-2xl mb-2 shadow-sm border border-slate-100 overflow-hidden";
                    
                    const summary = document.createElement('summary');
                    summary.className = "px-5 py-4 cursor-pointer font-bold text-slate-700 flex justify-between items-center list-none select-none active:bg-slate-50";
                    summary.innerHTML = `${pref} <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-full">${grouped[region][pref].length}</span>`;
                    
                    const content = document.createElement('div');
                    content.className = "bg-slate-50/50 p-3 grid gap-3";
                    
                    grouped[region][pref].forEach(spot => {
                        const status = userStatus[spot.id] || {};
                        const item = document.createElement('div');
                        item.className = "list-card p-4";
                        item.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-slate-800">${spot.name}</h3>
                                    <p class="text-xs text-slate-400 mt-1"><i class="fas fa-map-marker-alt"></i> ${spot.address}</p>
                                </div>
                                <span class="text-xl">${getIcon(spot.category)}</span>
                            </div>
                            <div class="mt-3 flex gap-2">
                                <span class="tag tag-discount text-[10px]">ğŸ’° ${spot.discount}</span>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}')" class="btn-primary text-xs flex-1"><i class="fas fa-location-arrow"></i> è¡Œã</button>
                                <button onclick="toggleStatus(${spot.id}, 'fav')" class="btn-secondary text-xs flex-1 ${status.fav ? '!text-pink-500 !bg-pink-50' : ''}"><i class="${status.fav ? 'fas' : 'far'} fa-heart"></i> ä¿å­˜</button>
                            </div>
                        `;
                        content.appendChild(item);
                    });
                    
                    prefDetails.appendChild(summary);
                    prefDetails.appendChild(content);
                    section.appendChild(prefDetails);
                });
                container.appendChild(section);
            });
        }

        function renderMyList() {
            const container = document.getElementById('mylist-container');
            container.innerHTML = '';
            const list = facilities.filter(f => userStatus[f.id]?.[currentListTab]);
            
            if(list.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300 text-2xl">
                            <i class="far fa-folder-open"></i>
                        </div>
                        <p class="text-slate-400 text-sm font-bold">ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>`;
                return;
            }
            
            list.forEach(spot => {
                const el = document.createElement('div');
                el.className = "list-card";
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                         <span class="tag bg-slate-100 text-slate-500">${spot.region}</span>
                         <span class="text-2xl">${getIcon(spot.category)}</span>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 mb-1">${spot.name}</h3>
                    <p class="text-xs text-slate-400 mb-4"><i class="fas fa-map-marker-alt"></i> ${spot.address}</p>
                    <div class="flex gap-2">
                        <button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}')" class="btn-secondary text-xs flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100"><i class="fas fa-location-arrow"></i> ãƒãƒƒãƒ—</button>
                        <button onclick="toggleStatus(${spot.id}, '${currentListTab}')" class="w-10 h-10 rounded-xl flex items-center justify-center border border-slate-200 text-slate-400 hover:text-red-500 hover:bg-red-50"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        window.locateUser = function() {
            showToast("ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...");
            if(!navigator.geolocation) { showModal('region-modal'); return; }
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                if(userLocationMarker) map.removeLayer(userLocationMarker);
                
                // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                const pulseIcon = L.divIcon({ className: 'custom-div-icon', html: '<div style="width:20px;height:20px;background:#3B82F6;border-radius:50%;border:3px solid white;box-shadow:0 0 0 4px rgba(59,130,246,0.3);"></div>', iconSize: [20, 20] });
                userLocationMarker = L.marker([lat, lng], {icon: pulseIcon}).addTo(map);
                
                map.flyTo([lat, lng], 13, { duration: 1.5 });
                updateVisibleSpots(lat, lng);
                showToast("ç¾åœ¨åœ°å‘¨è¾ºã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
            }, (err) => { showModal('region-modal'); }, { timeout: 8000 });
        };

        window.manualLocate = function(lat, lng) {
            closeModal('region-modal');
            map.flyTo([lat, lng], 10, { duration: 1.5 });
            updateVisibleSpots(lat, lng);
        }

        window.setFilter = function(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`filter-${type}`);
            if(btn) btn.classList.add('active');
            
            renderAllMarkers();
            const center = map.getCenter();
            updateVisibleSpots(center.lat, center.lng);
        };

        window.toggleStatus = function(id, type) {
            if(!userStatus[id]) userStatus[id] = {};
            userStatus[id][type] = !userStatus[id][type];
            localStorage.setItem('handimap_v4_status', JSON.stringify(userStatus));
            
            // æ›´æ–°åæ˜ 
            const center = map.getCenter();
            updateVisibleSpots(center.lat, center.lng); 
            renderPrefList();
            renderMyList();
            
            if(userStatus[id][type]) showToast(type === 'fav' ? "ãƒã‚¤ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ" : "è¨ªå•æ¸ˆã¿ã«ã—ã¾ã—ãŸ");
        }

        window.switchPage = function(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            
            if(pageId === 'map') setTimeout(() => map.invalidateSize(), 300);
        }

        window.switchListTab = function(tab) {
            currentListTab = tab;
            const t1 = document.getElementById('tab-fav');
            const t2 = document.getElementById('tab-visited');
            
            // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒ©ã‚¹åˆ‡æ›¿
            if(tab === 'fav') {
                t1.className = "px-4 py-1.5 text-xs font-bold rounded-md bg-white text-blue-600 shadow-sm transition-all";
                t2.className = "px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 transition-all";
            } else {
                t1.className = "px-4 py-1.5 text-xs font-bold rounded-md text-slate-400 transition-all";
                t2.className = "px-4 py-1.5 text-xs font-bold rounded-md bg-white text-green-600 shadow-sm transition-all";
            }
            renderMyList();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerHTML = msg;
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, -10px)'; }, 2500);
        }

        function showModal(id) { document.getElementById(id).classList.add('show'); }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('show'); }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getIcon(cat) {
            const icons = { theme_park:'ğŸ¡', zoo:'ğŸ˜', aquarium:'ğŸ¬', cinema:'ğŸ¬', museum:'ğŸ›ï¸', sightseeing:'ğŸ—¼', park:'ğŸŒ³' };
            return icons[cat] || 'ğŸ“';
        }
    </script>
</body>
</html>
