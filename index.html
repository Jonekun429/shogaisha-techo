<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HandiMap Kanto</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"M PLUS Rounded 1c"', 'sans-serif'] },
                    colors: { primary: '#0D9488', secondary: '#F0FDFA', accent: '#F43F5E' },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base & Safe Area Fixes */
        body { 
            touch-action: manipulation; overflow: hidden; background-color: #F8FAFC; 
            -webkit-font-smoothing: antialiased; color: #334155;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; position: relative; }
        @media (min-width: 768px) { #app-container { flex-direction: row; } }
        
        .page { display: none; flex: 1; height: 100%; width: 100%; flex-direction: column; position: relative; padding-bottom: 90px; }
        .page.active { display: flex; }
        @media (min-width: 768px) { .page { padding-bottom: 0; } }

        /* Map */
        #map { flex: 1; width: 100%; z-index: 0; background: #e5e7eb; }
        .pin-marker {
            background-color: white; border-radius: 50%; border: 2.5px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; transition: all 0.3s; width: 44px; height: 44px; position: relative;
        }
        .pin-marker::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid white;
        }
        .pin-marker.active-pin {
            background-color: #0D9488; color: white; border-color: #0D9488; 
            transform: scale(1.25) translateY(-8px); z-index: 3000 !important;
            box-shadow: 0 10px 25px rgba(13, 148, 136, 0.4);
        }
        .pin-marker.active-pin::after { border-top-color: #0D9488; }

        /* Filter Chips */
        .filter-bar {
            position: absolute; top: 10px; left: 0; right: 0; z-index: 500;
            display: flex; justify-content: center; pointer-events: none;
        }
        @supports (padding-top: env(safe-area-inset-top)) {
            .filter-bar { top: env(safe-area-inset-top); margin-top: 10px; }
        }
        .chip-scroll { 
            display: flex; gap: 8px; overflow-x: auto; padding: 6px 16px; 
            scrollbar-width: none; pointer-events: auto; max-width: 95%;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.8);
        }
        .chip {
            padding: 8px 14px; border-radius: 100px; font-size: 12px; font-weight: 700; white-space: nowrap;
            background: #F1F5F9; color: #94A3B8; border: 1px solid transparent; 
            display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s;
        }
        .chip.active { background: #0D9488; color: white; box-shadow: 0 2px 8px rgba(13, 148, 136, 0.3); }
        .chip:not(.active) { opacity: 0.7; }

        /* GPS Button */
        .gps-container {
            position: absolute; right: 16px; 
            bottom: 300px; /* ã‚«ãƒ¼ãƒ‰ã®ä¸Š */
            z-index: 500; display: flex; align-items: center; justify-content: flex-end; gap: 8px;
        }
        .gps-btn {
            width: 48px; height: 48px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); color: #0D9488; font-size: 20px;
            border: 1px solid #F0FDFA; transition: transform 0.2s;
        }
        .gps-btn:active { transform: scale(0.9); }
        .gps-hint-bubble {
            background: white; padding: 8px 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-size: 11px; font-weight: 800; color: #0D9488;
            white-space: nowrap; pointer-events: none; border: 2px solid #F0FDFA; position: relative; margin-right: 4px;
        }
        .gps-hint-bubble::after {
            content: ''; position: absolute; right: -6px; top: 50%; transform: translateY(-50%);
            border-left: 6px solid white; border-top: 6px solid transparent; border-bottom: 6px solid transparent;
        }

        /* Map Bottom Sheet (Card Scroller) */
        .sheet-wrapper {
            position: absolute; 
            /* ãƒŠãƒ“ãƒãƒ¼(ç´„80px) + ä½™ç™½åˆ† ä¸Šã’ã‚‹ */
            bottom: 90px; 
            left: 0; right: 0; 
            z-index: 1000; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .sheet-handle-bar {
            width: 40px; height: 5px; background: rgba(0,0,0,0.2); border-radius: 10px;
            margin: 0 auto 8px auto; box-shadow: 0 1px 2px rgba(255,255,255,0.5);
        }
        .card-scroller {
            display: flex; gap: 12px; padding: 0 16px;
            overflow-x: auto; scroll-snap-type: x mandatory; 
            padding-bottom: 10px; scrollbar-width: none;
            height: 170px; pointer-events: auto; 
            -webkit-overflow-scrolling: touch;
        }
        
        .map-card-horizontal {
            flex: 0 0 88%; max-width: 340px; scroll-snap-align: center;
            background: white; border-radius: 24px; padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s; height: 100%; display: flex; flex-direction: column;
        }
        .map-card-horizontal.active { border-color: #0D9488; transform: translateY(-4px); }

        /* Navigation Bar */
        .nav-container { z-index: 3000; }
        @media (max-width: 767px) {
            .nav-container {
                position: fixed; bottom: 0; left: 0; right: 0;
                height: calc(70px + env(safe-area-inset-bottom));
                padding-bottom: env(safe-area-inset-bottom);
                background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0,0,0,0.05); box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
                display: flex; justify-content: space-evenly; align-items: center;
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #94A3B8; font-size: 10px; font-weight: bold; width: 70px; height: 100%;
            }
            .nav-item i { font-size: 22px; transition: transform 0.2s; margin-bottom: 2px; }
            .nav-item.active { color: #0D9488; }
            .nav-item.active i { transform: translateY(-3px); }
            .nav-item.active::after { content: ''; width: 4px; height: 4px; background: #0D9488; border-radius: 50%; position: absolute; bottom: 12px; }
        }
        @media (min-width: 768px) {
            .nav-container { width: 260px; height: 100%; background: white; border-right: 1px solid #E2E8F0; display: flex; flex-direction: column; padding-top: 40px; }
            .nav-item { display: flex; align-items: center; gap: 14px; padding: 16px 32px; font-size: 15px; color: #64748B; font-weight: 600; cursor: pointer; transition: all 0.2s; }
            .nav-item:hover { background: #F8FAFC; color: #0D9488; }
            .nav-item.active { background: #F0FDFA; color: #0D9488; border-right: 3px solid #0D9488; }
        }

        /* Search Area */
        .search-area {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid #E2E8F0; padding: 12px 16px;
            position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            padding-top: max(12px, env(safe-area-inset-top)); 
        }
        .search-input {
            width: 100%; padding: 12px 16px 12px 40px; border-radius: 14px; border: 2px solid #F1F5F9;
            background: #F8FAFC; font-weight: bold; color: #334155; transition: all 0.2s; font-size: 14px;
        }
        .search-input:focus { background: white; border-color: #0D9488; outline: none; }
        .search-icon { position: absolute; left: 14px; bottom: 12px; color: #94A3B8; }

        /* Utils */
        .map-card { background: white; border-radius: 20px; padding: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 12px; border: 1px solid #F1F5F9; }
        .btn-primary {
            background: #0D9488; color: white; font-weight: 700; padding: 10px 0; border-radius: 10px; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px;
        }
        .btn-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid #E2E8F0; color: #64748B; }
        .tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 700; background: #F1F5F9; color: #64748B; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: white; width: 85%; max-width: 360px; border-radius: 24px; padding: 24px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        #pwa-prompt {
            position: fixed; top: 0; left: 0; right: 0; background: #0D9488; color: white; z-index: 9999;
            padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top));
            display: none; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="text-slate-700">

    <div id="pwa-prompt">
        <div class="text-xs font-bold flex-1"><i class="fas fa-home mr-1"></i> ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™</div>
        <button onclick="closePwaPrompt()" class="bg-white/20 rounded-full w-6 h-6 flex items-center justify-center text-xs ml-3"><i class="fas fa-times"></i></button>
    </div>

    <div id="app-container">
        <nav class="nav-container order-2 md:order-1">
            <div class="hidden md:block px-8 mb-8">
                <h1 class="text-2xl font-extrabold text-teal-800 tracking-tight flex items-center gap-3">
                    <span class="w-10 h-10 bg-teal-600 rounded-xl flex items-center justify-center text-white text-lg shadow-lg"><i class="fas fa-universal-access"></i></span> HandiMap
                </h1>
                <p class="text-xs text-slate-400 mt-2 font-bold pl-1">Version 21.0</p>
            </div>
            <div class="nav-item active" onclick="switchPage('map')" id="nav-map"><i class="fas fa-map-marked-alt"></i><span>ãƒãƒƒãƒ—</span></div>
            <div class="nav-item" onclick="switchPage('list')" id="nav-list"><i class="fas fa-search"></i><span>æ¢ã™</span></div>
            <div class="nav-item" onclick="switchPage('mylist')" id="nav-mylist"><i class="fas fa-heart"></i><span>ä¿å­˜æ¸ˆã¿</span></div>
        </nav>

        <main class="flex-1 relative h-full order-1 md:order-2 overflow-hidden bg-slate-50">
            
            <div id="page-map" class="page active">
                <div class="filter-bar">
                    <div class="chip-scroll">
                        <button class="chip active" onclick="toggleMapFilter('leisure', this)"><i class="fas fa-rocket"></i> éŠåœ’åœ°</button>
                        <button class="chip active" onclick="toggleMapFilter('aquarium', this)"><i class="fas fa-water"></i> æ°´æ—é¤¨</button>
                        <button class="chip active" onclick="toggleMapFilter('zoo', this)"><i class="fas fa-paw"></i> å‹•ç‰©åœ’</button>
                        <button class="chip active" onclick="toggleMapFilter('museum', this)"><i class="fas fa-landmark"></i> åšç‰©é¤¨</button>
                        <button class="chip active" onclick="toggleMapFilter('park', this)"><i class="fas fa-tree"></i> å…¬åœ’</button>
                        <button class="chip active" onclick="toggleMapFilter('cinema', this)"><i class="fas fa-film"></i> æ˜ ç”»</button>
                    </div>
                </div>
                
                <div class="gps-container">
                    <div id="gps-hint" class="gps-hint-bubble animate-bounce-slow">ç¾åœ¨åœ°ã‚’è¡¨ç¤ºï¼</div>
                    <button onclick="locateUserOnMap()" class="gps-btn"><i class="fas fa-crosshairs"></i></button>
                </div>

                <div id="map"></div>
                
                <div class="sheet-wrapper">
                    <div class="sheet-handle-bar"></div>
                    <div id="card-scroller" class="card-scroller"></div>
                </div>
            </div>

            <div id="page-list" class="page overflow-y-auto">
                <div class="search-area">
                    <div class="relative w-full mb-3">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="æ–½è¨­åã€åœ°åã€ã‚¸ãƒ£ãƒ³ãƒ«..." oninput="handleSearch(this.value)">
                    </div>
                    <div class="chip-scroll">
                        <button class="chip active" onclick="applyListFilter('all', this)">ã™ã¹ã¦</button>
                        <button class="chip" onclick="applyListFilter('leisure', this)">éŠåœ’åœ°</button>
                        <button class="chip" onclick="applyListFilter('aquarium', this)">æ°´æ—é¤¨</button>
                        <button class="chip" onclick="applyListFilter('zoo', this)">å‹•ç‰©åœ’</button>
                        <button class="chip" onclick="applyListFilter('museum', this)">åšç‰©é¤¨</button>
                    </div>
                    <div id="location-prompt" class="mt-3 hidden animate-pulse-fast bg-teal-50 border border-teal-100 rounded-xl p-3 flex items-center justify-between cursor-pointer hover:bg-teal-100 transition-colors" onclick="locateUserForList()">
                        <div class="flex items-center gap-2 text-xs font-bold text-teal-800"><i class="fas fa-location-arrow"></i> <span>ç¾åœ¨åœ°ã‚’å–å¾—</span></div>
                        <span class="bg-white px-3 py-1 rounded-full text-[10px] text-teal-600 font-extrabold shadow-sm">ON</span>
                    </div>
                </div>
                <div id="list-container" class="p-4 pb-28 md:pb-12 max-w-3xl mx-auto w-full min-h-[50vh]"></div>
            </div>

            <div id="page-mylist" class="page overflow-y-auto">
                <div class="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b border-slate-100 px-6 py-4 shadow-sm flex justify-between items-center" style="padding-top: max(16px, env(safe-area-inset-top));">
                    <h1 class="text-lg font-bold text-slate-800"><i class="fas fa-bookmark text-pink-500 mr-2"></i>ä¿å­˜æ¸ˆã¿</h1>
                    <div class="flex bg-slate-100 rounded-lg p-1 gap-1">
                        <button onclick="switchListTab('fav')" id="tab-fav" class="px-3 py-1.5 text-xs font-bold rounded-md bg-white text-teal-600 shadow-sm transition-all">è¡ŒããŸã„</button>
                        <button onclick="switchListTab('visited')" id="tab-visited" class="px-3 py-1.5 text-xs font-bold rounded-md text-slate-400 transition-all">è¡Œã£ãŸ</button>
                    </div>
                </div>
                <div id="mylist-container" class="p-4 pb-20 md:pb-12 max-w-3xl mx-auto w-full"></div>
                <div class="p-6 border-t border-slate-200 mt-auto bg-slate-50 text-center">
                    <h3 class="text-xs font-bold text-slate-400 mb-3">ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ãï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</h3>
                    <div class="flex gap-3 justify-center">
                        <button onclick="openBackupModal('export')" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 shadow-sm hover:bg-slate-50"><i class="fas fa-copy mr-1"></i> ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</button>
                        <button onclick="openBackupModal('import')" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-xs font-bold text-slate-600 shadow-sm hover:bg-slate-50"><i class="fas fa-paste mr-1"></i> ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="map-select-modal" class="modal-overlay">
        <div class="modal-box text-left">
            <h3 class="text-xl font-bold mb-1 text-slate-800 text-center">çµŒè·¯æ¡ˆå†…ã‚’é–‹å§‹</h3>
            <p class="text-xs text-slate-400 mb-6 text-center">ç§»å‹•å‰ã«æœ€æ–°æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„</p>
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 text-center">
                <p class="text-xs font-bold text-blue-800 mb-2">âš ï¸ æ–™é‡‘ãƒ»å–¶æ¥­æ™‚é–“ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
                <a id="modal-hp-link" href="#" target="_blank" class="block w-full bg-white text-blue-600 font-bold py-3 rounded-lg border border-blue-200 text-xs hover:bg-blue-600 hover:text-white transition-colors">
                    <i class="fas fa-external-link-alt mr-2"></i> å…¬å¼ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª
                </a>
            </div>
            <div class="text-xs font-bold text-slate-400 mb-2 pl-1">ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚’é¸æŠ:</div>
            <div class="flex flex-col gap-3 mb-4">
                <button onclick="confirmNavigation('google')" class="p-3 rounded-xl border-2 border-slate-100 hover:border-teal-500 hover:bg-teal-50 transition-all flex items-center group bg-white">
                    <i class="fab fa-google text-lg mr-3 text-red-500"></i><div class="flex-1 text-sm font-bold text-slate-700">Googleãƒãƒƒãƒ—</div><i class="fas fa-chevron-right text-slate-300"></i>
                </button>
                <button onclick="confirmNavigation('default')" class="p-3 rounded-xl border-2 border-slate-100 hover:border-teal-500 hover:bg-teal-50 transition-all flex items-center group bg-white">
                    <i class="fas fa-mobile-alt text-lg mr-3 text-slate-600"></i><div class="flex-1 text-sm font-bold text-slate-700">æ¨™æº–ãƒãƒƒãƒ—</div><i class="fas fa-chevron-right text-slate-300"></i>
                </button>
            </div>
            <button onclick="closeModal('map-select-modal')" class="text-sm text-slate-400 font-bold w-full py-2">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="backup-modal" class="modal-overlay">
        <div class="modal-box text-left">
            <h3 id="backup-title" class="text-lg font-bold mb-2 text-slate-800 text-center">ãƒ‡ãƒ¼ã‚¿ä¿å­˜</h3>
            <p id="backup-desc" class="text-xs text-slate-500 mb-4 text-center">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ¡ãƒ¢å¸³ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
            <textarea id="backup-text" class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono mb-4 resize-none focus:border-teal-500 focus:outline-none"></textarea>
            <button id="backup-action-btn" class="btn-primary mb-3">ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
            <button onclick="closeModal('backup-modal')" class="text-xs text-slate-400 font-bold w-full py-2">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="region-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="text-lg font-bold mb-2 text-slate-800">ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</h3>
            <p class="text-sm text-slate-500 mb-6">ç«¯æœ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            <button onclick="closeModal('region-modal')" class="btn-primary bg-slate-500">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const STORAGE_KEY = 'handimap_persistent_save_v1';
        const facilitiesData = [
            { id: 101, name: "æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼", pref: "æ±äº¬éƒ½", area: "å¢¨ç”°åŒº", category: "leisure", lat: 35.7100, lng: 139.8107, price: "åŠé¡ (ä¼‘æ—¥1150å††ã€œ)", address: "å¢¨ç”°åŒºæŠ¼ä¸Š1-1-2", url: "https://www.tokyo-skytree.jp/" },
            { id: 102, name: "æ±äº¬ã‚¿ãƒ¯ãƒ¼", pref: "æ±äº¬éƒ½", area: "æ¸¯åŒº", category: "leisure", lat: 35.6585, lng: 139.7454, price: "åŠé¡ (600å††)", address: "æ¸¯åŒºèŠå…¬åœ’4-2-8", url: "https://www.tokyotower.co.jp/" },
            { id: 103, name: "æ–°å®¿å¾¡è‹‘", pref: "æ±äº¬éƒ½", area: "æ–°å®¿åŒº", category: "park", lat: 35.6851, lng: 139.7100, price: "ç„¡æ–™ (ä»˜æ·»1åå«)", address: "æ–°å®¿åŒºå†…è—¤ç”º11", url: "https://fng.or.jp/shinjuku/" },
            { id: 104, name: "ä¸Šé‡å‹•ç‰©åœ’", pref: "æ±äº¬éƒ½", area: "å°æ±åŒº", category: "zoo", lat: 35.7165, lng: 139.7713, price: "ç„¡æ–™ (ä»˜æ·»1åå«)", address: "å°æ±åŒºä¸Šé‡å…¬åœ’9-83", url: "https://www.tokyo-zoo.net/zoo/ueno/" },
            { id: 105, name: "è‘›è¥¿è‡¨æµ·æ°´æ—åœ’", pref: "æ±äº¬éƒ½", area: "æ±Ÿæˆ¸å·åŒº", category: "aquarium", lat: 35.6401, lng: 139.8624, price: "ç„¡æ–™ (ä»˜æ·»1åå«)", address: "æ±Ÿæˆ¸å·åŒºè‡¨æµ·ç”º6-2-3", url: "https://www.tokyo-zoo.net/zoo/kasai/" },
            { id: 106, name: "å›½ç«‹ç§‘å­¦åšç‰©é¤¨", pref: "æ±äº¬éƒ½", area: "å°æ±åŒº", category: "museum", lat: 35.7163, lng: 139.7766, price: "ç„¡æ–™ (ä»˜æ·»1åå«)", address: "å°æ±åŒºä¸Šé‡å…¬åœ’7-20", url: "https://www.kahaku.go.jp/" },
            { id: 107, name: "æ—¥æœ¬ç§‘å­¦æœªæ¥é¤¨", pref: "æ±äº¬éƒ½", area: "æ±Ÿæ±åŒº", category: "museum", lat: 35.6193, lng: 139.7765, price: "ç„¡æ–™ (ä»˜æ·»1åå«)", address: "æ±Ÿæ±åŒºé’æµ·2-3-6", url: "https://www.miraikan.jst.go.jp/" },
            { id: 108, name: "ã‚µãƒ³ãƒªã‚ªãƒ”ãƒ¥ãƒ¼ãƒ­ãƒ©ãƒ³ãƒ‰", pref: "æ±äº¬éƒ½", area: "å¤šæ‘©å¸‚", category: "leisure", lat: 35.6247, lng: 139.4293, price: "200å††å¼•", address: "å¤šæ‘©å¸‚è½åˆ1-31", url: "https://www.puroland.jp/" },
            { id: 109, name: "TOHOã‚·ãƒãƒã‚º", pref: "æ±äº¬éƒ½", area: "éƒ½å†…å„æ‰€", category: "cinema", lat: 35.6955, lng: 139.7020, price: "1000å†† (ä»˜æ·»1åå«)", address: "æ–°å®¿ã»ã‹éƒ½å†…å„æ‰€", url: "https://www.tohotheater.jp/" },
            { id: 110, name: "å›½ç«‹æ–°ç¾è¡“é¤¨", pref: "æ±äº¬éƒ½", area: "æ¸¯åŒº", category: "museum", lat: 35.6652, lng: 139.7263, price: "ç„¡æ–™ (ä¼ç”»å±•å«)", address: "æ¸¯åŒºå…­æœ¬æœ¨", url: "https://www.nact.jp/" },
            { id: 111, name: "æ£®ç¾è¡“é¤¨", pref: "æ±äº¬éƒ½", area: "æ¸¯åŒº", category: "museum", lat: 35.6604, lng: 139.7292, price: "åŠé¡", address: "æ¸¯åŒºå…­æœ¬æœ¨ãƒ’ãƒ«ã‚º", url: "https://www.mori.art.museum/" },
            { id: 201, name: "æ–°æ±Ÿãƒå³¶æ°´æ—é¤¨", pref: "ç¥å¥ˆå·çœŒ", area: "è—¤æ²¢å¸‚", category: "aquarium", lat: 35.3089, lng: 139.4819, price: "åŠé¡ (1250å††)", address: "è—¤æ²¢å¸‚ç‰‡ç€¬æµ·å²¸", url: "https://www.enosui.com/" },
            { id: 202, name: "ã‚ˆã“ã¯ã¾å‹•ç‰©åœ’ã‚ºãƒ¼ãƒ©ã‚·ã‚¢", pref: "ç¥å¥ˆå·çœŒ", area: "æ¨ªæµœå¸‚", category: "zoo", lat: 35.4944, lng: 139.5255, price: "ç„¡æ–™ (ä»˜æ·»1åå«)", address: "æ¨ªæµœå¸‚æ—­åŒº", url: "https://www.hama-midorinokyokai.or.jp/zoo/zoorasia/" },
            { id: 204, name: "æ¨ªæµœãƒ»å…«æ™¯å³¶ã‚·ãƒ¼ãƒ‘ãƒ©ãƒ€ã‚¤ã‚¹", pref: "ç¥å¥ˆå·çœŒ", area: "æ¨ªæµœå¸‚", category: "leisure", lat: 35.3367, lng: 139.6469, price: "åŠé¡ (ãƒ‘ã‚¹ç­‰)", address: "æ¨ªæµœå¸‚é‡‘æ²¢åŒº", url: "https://www.seaparadise.co.jp/" },
            { id: 301, name: "æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰/ã‚·ãƒ¼", pref: "åƒè‘‰çœŒ", area: "æµ¦å®‰å¸‚", category: "leisure", lat: 35.6329, lng: 139.8804, price: "å°‚ç”¨ãƒ‘ã‚¹ (6800å††ã€œ)", address: "æµ¦å®‰å¸‚èˆæµœ", url: "https://www.tokyodisneyresort.jp/" },
            { id: 302, name: "é´¨å·ã‚·ãƒ¼ãƒ¯ãƒ¼ãƒ«ãƒ‰", pref: "åƒè‘‰çœŒ", area: "é´¨å·å¸‚", category: "aquarium", lat: 35.1157, lng: 140.1189, price: "åŠé¡ (1650å††)", address: "é´¨å·å¸‚æ±ç”º", url: "https://www.kamogawa-seaworld.jp/" },
            { id: 303, name: "ãƒã‚¶ãƒ¼ç‰§å ´", pref: "åƒè‘‰çœŒ", area: "å¯Œæ´¥å¸‚", category: "zoo", lat: 35.2639, lng: 139.9328, price: "åŠé¡ (750å††)", address: "å¯Œæ´¥å¸‚ç”°å€‰", url: "https://www.motherfarm.co.jp/" },
            { id: 401, name: "é‰„é“åšç‰©é¤¨", pref: "åŸ¼ç‰çœŒ", area: "ã•ã„ãŸã¾å¸‚", category: "museum", lat: 35.9209, lng: 139.6196, price: "åŠé¡ (660å††)", address: "ã•ã„ãŸã¾å¸‚å¤§å®®åŒº", url: "https://www.railway-museum.jp/" },
            { id: 403, name: "è¥¿æ­¦åœ’ã‚†ã†ãˆã‚“ã¡", pref: "åŸ¼ç‰çœŒ", area: "æ‰€æ²¢å¸‚", category: "leisure", lat: 35.7644, lng: 139.4447, price: "å‰²å¼•ã‚ã‚Š", address: "æ‰€æ²¢å¸‚å±±å£", url: "https://www.seibu-leisure.co.jp/" },
            { id: 501, name: "ã‚¢ã‚¯ã‚¢ãƒ¯ãƒ¼ãƒ«ãƒ‰å¤§æ´—", pref: "èŒ¨åŸçœŒ", area: "å¤§æ´—ç”º", category: "aquarium", lat: 36.3134, lng: 140.5898, price: "åŠé¡ (1150å††)", address: "æ±èŒ¨åŸéƒ¡å¤§æ´—ç”º", url: "https://www.aquaworld-oarai.com/" },
            { id: 901, name: "ã‚¤ã‚ªãƒ³ã‚·ãƒãƒ", pref: "å…¨åŸŸ", area: "å„åº—èˆ—", category: "cinema", lat: null, lng: null, price: "1000å††", address: "é–¢æ±å„æ‰€", url: "https://www.aeoncinema.com/" }
        ];

        let map, markers = {};
        let userStatus = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let userCurrentPos = null;
        let activeListCategory = 'all'; 
        let activeMapCategories = new Set(['leisure', 'aquarium', 'zoo', 'museum', 'park', 'cinema']);
        let searchQuery = "";
        let currentListTab = 'fav';
        let isSingleCardMode = false;

        window.onload = function() {
            initMap();
            renderList();
            renderMyList();
            if (window.innerWidth < 768 && !window.navigator.standalone) {
                setTimeout(() => { document.getElementById('pwa-prompt').style.display = 'flex'; }, 3000);
            }
        };

        function closePwaPrompt() { document.getElementById('pwa-prompt').style.display = 'none'; }

        // --- BACKUP LOGIC ---
        function openBackupModal(type) {
            const modal = document.getElementById('backup-modal');
            const title = document.getElementById('backup-title');
            const desc = document.getElementById('backup-desc');
            const textarea = document.getElementById('backup-text');
            const btn = document.getElementById('backup-action-btn');

            modal.classList.add('show');
            
            if(type === 'export') {
                title.innerText = "ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆæ›¸ãå‡ºã—ï¼‰";
                desc.innerText = "ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ¡ãƒ¢å¸³ãªã©ã«å¤§åˆ‡ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚";
                textarea.value = JSON.stringify(userStatus);
                textarea.readOnly = true;
                btn.innerText = "ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼";
                btn.onclick = function() {
                    textarea.select();
                    document.execCommand('copy');
                    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
                };
            } else {
                title.innerText = "ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆèª­ã¿è¾¼ã¿ï¼‰";
                desc.innerText = "ä¿å­˜ã—ã¦ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ã€å¾©å…ƒãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
                textarea.value = "";
                textarea.readOnly = false;
                btn.innerText = "å¾©å…ƒã™ã‚‹";
                btn.onclick = function() {
                    try {
                        const data = JSON.parse(textarea.value);
                        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")) {
                            userStatus = data;
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(userStatus));
                            renderMyList(); renderList();
                            alert("å¾©å…ƒã—ã¾ã—ãŸï¼");
                            closeModal('backup-modal');
                        }
                    } catch(e) {
                        alert("ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
                    }
                };
            }
        }

        // --- MAP LOGIC ---
        function initMap() {
            if(map) return;
            map = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 9);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
            if (window.innerWidth >= 768) L.control.zoom({ position: 'bottomright' }).addTo(map);
            
            map.on('moveend', () => { if (!isSingleCardMode) updateVisibleSpots(); });
            map.on('click', () => {
                isSingleCardMode = false;
                document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
                hideGpsHint();
                updateVisibleSpots();
            });
            renderAllMarkers();
            
            // åˆå›å…¨ä»¶è¡¨ç¤º
            updateVisibleSpots(); 
        }

        function renderAllMarkers() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            facilitiesData.forEach(spot => {
                if (!spot.lat) return;
                if (!activeMapCategories.has(spot.category)) return;
                const icon = L.divIcon({ className: 'custom-div-icon', html: `<div id="pin-${spot.id}" class="pin-marker">${getIcon(spot.category)}</div>`, iconSize: [44, 44], iconAnchor: [22, 50] });
                const marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
                marker.on('click', (e) => { L.DomEvent.stopPropagation(e); setActiveFacilityOnMap(spot.id); });
                markers[spot.id] = marker;
            });
        }

        function toggleMapFilter(cat, btn) {
            if (activeMapCategories.has(cat)) { activeMapCategories.delete(cat); btn.classList.remove('active'); }
            else { activeMapCategories.add(cat); btn.classList.add('active'); }
            renderAllMarkers(); updateVisibleSpots();
        }

        function updateVisibleSpots() {
            const center = map.getCenter();
            const refLat = userCurrentPos ? userCurrentPos.lat : center.lat;
            const refLng = userCurrentPos ? userCurrentPos.lng : center.lng;
            
            // å…¨ä»¶ã‚’å¯¾è±¡ã«è·é›¢é †ã‚½ãƒ¼ãƒˆã—ã€ä¸Šä½15ä»¶ã‚’è¡¨ç¤º
            const sorted = facilitiesData
                .filter(f => f.lat && activeMapCategories.has(f.category))
                .map(f => ({ ...f, dist: getDistance(refLat, refLng, f.lat, f.lng) }))
                .sort((a, b) => a.dist - b.dist)
                .slice(0, 15);
            renderMapCards(sorted);
        }

        function renderMapCards(spots) {
            const scroller = document.getElementById('card-scroller');
            scroller.innerHTML = '';
            const spacer = document.createElement('div'); spacer.style.flex = "0 0 10px"; scroller.appendChild(spacer);
            spots.forEach(spot => {
                const card = document.createElement('div');
                card.className = "map-card-horizontal bg-white";
                card.onclick = (e) => { 
                    L.DomEvent.stopPropagation(e);
                    map.flyTo([spot.lat, spot.lng], 14); 
                    setActiveFacilityOnMap(spot.id); 
                };
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-slate-800 text-base line-clamp-1 cursor-pointer underline decoration-dotted decoration-teal-500" onclick="window.open('${spot.url}', '_blank'); event.stopPropagation();">${spot.name}<i class="fas fa-external-link-alt text-xs text-teal-500 ml-1"></i></h3>
                            <div class="text-xl cursor-pointer" onclick="window.open('${spot.url}', '_blank'); event.stopPropagation();">${getIcon(spot.category)}</div>
                        </div>
                        <p class="text-xs text-red-500 font-bold mb-1">${spot.price}</p>
                        <p class="text-[10px] text-slate-400"><i class="fas fa-map-marker-alt"></i> ${spot.dist < 1 ? Math.round(spot.dist*1000)+'m' : spot.dist.toFixed(1)+'km'}å…ˆ</p>
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-100 flex gap-2">
                        <button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}', '${spot.url}'); event.stopPropagation();" class="btn-primary text-xs py-2 shadow-sm flex-1"><i class="fas fa-location-arrow"></i> ãƒŠãƒ“</button>
                    </div>
                `;
                scroller.appendChild(card);
            });
            const spacerEnd = document.createElement('div'); spacerEnd.style.flex = "0 0 10px"; scroller.appendChild(spacerEnd);
        }

        function setActiveFacilityOnMap(id) {
            const spot = facilitiesData.find(f => f.id === id); if(!spot) return;
            isSingleCardMode = true;
            document.querySelectorAll('.pin-marker').forEach(el => el.classList.remove('active-pin'));
            const pin = document.getElementById(`pin-${id}`); if(pin) pin.classList.add('active-pin');
            map.flyTo([spot.lat, spot.lng], 14);
            renderMapCards([spot]); 
        }

        function locateUserOnMap() {
             hideGpsHint();
             if(!navigator.geolocation) { document.getElementById('region-modal').classList.add('show'); return; }
             navigator.geolocation.getCurrentPosition((pos) => {
                 userCurrentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                 if(window.userMarker) map.removeLayer(window.userMarker);
                 const icon = L.divIcon({ className: '', html: '<div style="width:20px;height:20px;background:#0D9488;border-radius:50%;border:3px solid white;box-shadow:0 0 0 4px rgba(13,148,136,0.3);"></div>' });
                 window.userMarker = L.marker([userCurrentPos.lat, userCurrentPos.lng], {icon: icon}).addTo(map);
                 map.flyTo([userCurrentPos.lat, userCurrentPos.lng], 13);
                 isSingleCardMode = false;
                 updateVisibleSpots();
             });
        }

        function hideGpsHint() { const el = document.getElementById('gps-hint'); if(el) el.style.display = 'none'; }

        // --- LIST & UTILS ---
        function applyListFilter(cat, btn) {
            activeListCategory = cat;
            btn.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderList();
        }

        function renderList() {
            const container = document.getElementById('list-container'); if(!container) return;
            container.innerHTML = '';
            let targets = facilitiesData.filter(f => {
                if (activeListCategory !== 'all') {
                    if (activeListCategory === 'leisure' && (f.category === 'zoo' || f.category === 'aquarium')) return true;
                    if (f.category !== activeListCategory) return false;
                }
                if (searchQuery) {
                    const q = searchQuery;
                    return f.name.toLowerCase().includes(q) || f.pref.toLowerCase().includes(q) || f.area.toLowerCase().includes(q);
                }
                return true;
            });
            if (userCurrentPos) {
                targets = targets.map(f => {
                    if(!f.lat) return {...f, dist: Infinity};
                    return {...f, dist: getDistance(userCurrentPos.lat, userCurrentPos.lng, f.lat, f.lng)};
                }).sort((a,b) => a.dist - b.dist);
            }
            if (targets.length === 0) { container.innerHTML = `<div class="text-center py-10 text-slate-400 font-bold">è©²å½“ãªã—</div>`; return; }
            const grouped = {};
            const prefOrder = ["æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "åƒè‘‰çœŒ", "åŸ¼ç‰çœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "å…¨åŸŸ"];
            if (!searchQuery && !userCurrentPos) {
                targets.forEach(f => { if(!grouped[f.pref]) grouped[f.pref] = []; grouped[f.pref].push(f); });
                prefOrder.forEach(pref => {
                    if(!grouped[pref]) return;
                    const section = document.createElement('div');
                    section.className = "mb-6";
                    section.innerHTML = `<h2 class="text-md font-bold text-teal-900 mb-3 flex items-center gap-2 border-l-4 border-teal-500 pl-3">${pref}</h2>`;
                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-1 md:grid-cols-2 gap-3";
                    grouped[pref].forEach(spot => renderListItem(spot, grid));
                    section.appendChild(grid);
                    container.appendChild(section);
                });
            } else {
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 md:grid-cols-2 gap-3";
                targets.forEach(spot => renderListItem(spot, grid));
                container.appendChild(grid);
            }
        }

        function renderListItem(spot, container) {
            const status = userStatus[spot.id] || {};
            let distHtml = '';
            if (userCurrentPos && spot.lat) {
                const d = spot.dist !== undefined ? spot.dist : getDistance(userCurrentPos.lat, userCurrentPos.lng, spot.lat, spot.lng);
                const dStr = d < 1 ? `${Math.round(d*1000)}m` : `${d.toFixed(1)}km`;
                distHtml = `<span class="bg-teal-50 text-teal-700 text-[10px] px-2 py-0.5 rounded font-bold ml-2"><i class="fas fa-location-arrow"></i> ${dStr}</span>`;
            }
            const item = document.createElement('div');
            item.className = "map-card";
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center flex-wrap">
                        <span class="tag">${spot.area}</span>
                        ${distHtml}
                    </div>
                    <div class="text-xl opacity-30 cursor-pointer" onclick="window.open('${spot.url}', '_blank'); event.stopPropagation();">${getIcon(spot.category)}</div>
                </div>
                <h3 class="font-bold text-lg text-slate-800 mb-1 leading-snug cursor-pointer underline decoration-dotted decoration-teal-500" onclick="window.open('${spot.url}', '_blank')">${spot.name}</h3>
                <div class="inline-block bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded mb-3">${spot.price}</div>
                <div class="flex gap-2">
                     ${spot.lat ? 
                        `<button onclick="handleNavClick(${spot.lat}, ${spot.lng}, '${spot.name}', '${spot.url}')" class="btn-primary shadow-sm flex-1"><i class="fas fa-map"></i> è¡Œã</button>` : 
                        `<a href="${spot.url}" target="_blank" class="btn-primary shadow-sm flex-1 !bg-slate-500"><i class="fas fa-external-link-alt"></i> HP</a>`
                    }
                    <a href="${spot.url}" target="_blank" class="btn-icon bg-white hover:text-teal-600"><i class="fas fa-globe"></i></a>
                    <button onclick="toggleStatus(${spot.id}, 'fav')" class="btn-icon bg-white hover:text-pink-500 ${status.fav ? '!text-pink-500 !bg-pink-50 !border-pink-200' : ''}">
                        <i class="${status.fav ? 'fas' : 'far'} fa-heart text-lg"></i>
                    </button>
                </div>
            `;
            container.appendChild(item);
        }

        // --- Common ---
        function handleNavClick(lat, lng, name, url) {
            window.tempNavTarget = { lat, lng, name };
            const linkEl = document.getElementById('modal-hp-link');
            if(linkEl) linkEl.href = url;
            document.getElementById('map-select-modal').classList.add('show');
        }
        function confirmNavigation(provider) {
            document.getElementById('map-select-modal').classList.remove('show');
            if (window.tempNavTarget) {
                const t = window.tempNavTarget;
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                if (provider === 'google') window.open(`https://www.google.com/maps/search/?api=1&query=${t.lat},${t.lng}&query_place_id=${encodeURIComponent(t.name)}`, '_blank');
                else if (isIOS) window.open(`http://maps.apple.com/?q=${encodeURIComponent(t.name)}&ll=${t.lat},${t.lng}`, '_system');
                else window.open(`geo:${t.lat},${t.lng}?q=${encodeURIComponent(t.name)}`, '_system');
            }
        }
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            if(pageId === 'map') setTimeout(() => map.invalidateSize(), 300);
            if(pageId === 'mylist') renderMyList();
        }
        function handleSearch(val) { searchQuery = val.toLowerCase().trim(); renderList(); }
        function locateUserForList() {
            if(!navigator.geolocation) { document.getElementById('region-modal').classList.add('show'); return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                userCurrentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                document.getElementById('location-prompt').classList.add('hidden');
                renderList();
            });
        }
        function toggleStatus(id, type) {
            if(!userStatus[id]) userStatus[id] = {};
            userStatus[id][type] = !userStatus[id][type];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userStatus));
            renderList(); renderMyList();
        }
        function switchListTab(tab) {
            currentListTab = tab;
            document.getElementById('tab-fav').className = `px-3 py-1.5 text-xs font-bold rounded-md transition-all ${tab==='fav' ? 'bg-white text-teal-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('tab-visited').className = `px-3 py-1.5 text-xs font-bold rounded-md transition-all ${tab==='visited' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400'}`;
            renderMyList();
        }
        function renderMyList() {
            const container = document.getElementById('mylist-container');
            container.innerHTML = '';
            const list = facilitiesData.filter(f => userStatus[f.id]?.[currentListTab]);
            if(list.length === 0) { container.innerHTML = `<div class="text-center text-slate-400 py-10 font-bold">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`; return; }
            list.forEach(spot => renderListItem(spot, container));
        }
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getIcon(cat) { const icons = { leisure:'ğŸ¡', zoo:'ğŸ˜', aquarium:'ğŸ¬', cinema:'ğŸ¬', museum:'ğŸ›ï¸', park:'ğŸŒ³', other:'ğŸ¤' }; return icons[cat] || 'ğŸ“'; }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    </script>
</body>
</html>
